<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Трекер зала — Матрица (single-file)</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7f9;
      --text:#101318;
      --muted:#667085;
      --border:#e6e8ee;
      --shadow: 0 10px 30px rgba(10, 20, 40, .10);
      --accent:#3b82f6;

      --gold:#f6c343;
      --green:#22c55e;
      --yellow:#fbbf24;
      --graybg:#f2f4f7;
      --injury:#ef4444;

      --cellH: 44px;
      --stickyW: 290px;
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0b0f14;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,.38);
      --graybg:#0f172a;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
    }
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Compact top bar */
    .top{
      position:sticky;
      top:0;
      z-index:40;
      background: color-mix(in oklab, var(--bg) 88%, transparent);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .topInner{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      flex-wrap:wrap;
    }
    .title{
      font-weight:900;
      letter-spacing:.01em;
      margin-right:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .title small{
      font-weight:700;
      color:var(--muted);
      font-size:12px;
    }

    button{
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
      white-space:nowrap;
    }
    button:hover{ border-color:#cfd5e3; }
    [data-theme="dark"] button:hover{ border-color:#2b364a; }
    button:active{ transform: translateY(1px); }

    button.primary{
      background: var(--accent);
      color:#fff;
      border-color: transparent;
    }
    button.danger{
      border-color: rgba(239,68,68,.35);
      color: var(--injury);
    }
    button.icon{
      padding: 8px 10px;
      font-weight:900;
      border-radius: 12px;
    }

    .spacer{ flex:1; }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .toggle input{ margin:0; }

    .tabs{
      display:flex;
      gap:8px;
    }
    .tab{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      cursor:pointer;
      font-weight:800;
      color: var(--muted);
      user-select:none;
    }
    .tab.active{
      background: var(--text);
      color: var(--bg);
      border-color: transparent;
    }
    [data-theme="dark"] .tab.active{
      background:#e5e7eb;
      color:#0b0f14;
    }

    input[type="text"], input[type="number"], select, textarea{
      font: inherit;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      outline:none;
    }
    input.small{ width: 140px; }
    input.tiny{ width: 90px; }
    select{ padding-right: 26px; }

    main{
      flex:1;
      min-height:0;
      padding: 8px 12px 12px;
    }

    /* Table fills the screen */
    .tableWrap{
      height: calc(100vh - 66px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background: var(--bg);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .tableMeta{
      padding: 8px 10px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      border:2px solid currentColor;
      display:inline-block;
    }
    .dot.gold{ color: var(--gold); }
    .dot.green{ color: var(--green); }
    .dot.yellow{ color: var(--yellow); }
    .dot.red{ color: var(--injury); }
    .dot.gray{ color: #98a2b3; background: var(--graybg); border-color:#98a2b3; }

    .scrollX{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    table{
      border-collapse: separate;
      border-spacing:0;
      width:max-content;
      min-width:100%;
      font-size:14px;
    }
    thead th{
      position: sticky;
      top:0;
      z-index:10;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      height: var(--cellH);
      padding: 6px 8px;
      text-align:left;
      white-space:nowrap;
      vertical-align: middle;
    }
    thead th:first-child{
      left:0;
      z-index:12;
      min-width: var(--stickyW);
      width: var(--stickyW);
      border-right: 1px solid var(--border);
    }
    tbody td, tbody th{
      border-bottom: 1px solid var(--border);
      height: var(--cellH);
      padding: 6px 8px;
      vertical-align: middle;
      background: var(--bg);
    }
    tbody th{
      position: sticky;
      left:0;
      z-index:5;
      min-width: var(--stickyW);
      width: var(--stickyW);
      border-right: 1px solid var(--border);
      background: var(--bg);
    }
    tbody tr:hover td, tbody tr:hover th{
      background: rgba(59,130,246,.08);
    }
    [data-theme="dark"] tbody tr:hover td, [data-theme="dark"] tbody tr:hover th{
      background: rgba(59,130,246,.14);
    }

    .rowBlock{
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: .04em;
      border-top: 2px solid var(--border);
      background: linear-gradient(90deg, rgba(59,130,246,.10), rgba(0,0,0,0));
    }
    .rowExercise{
      font-weight: 800;
      padding-left: 18px !important;
    }
    .rowWeight{
      font-weight: 500;
      padding-left: 36px !important;
      color: var(--muted);
    }
    .submeta{
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
      font-family: var(--mono);
    }

    .wCell{
      min-width: 150px;
      width: 150px;
      max-width: 180px;
      cursor:pointer;
      user-select:none;
    }
    .cellInner{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.15;
    }
    .cellValue{
      font-family: var(--mono);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cellGoal{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color: var(--muted);
    }
    .star{ width:14px;height:14px; display:inline-block; vertical-align:-2px; }

    /* status visuals */
    .st-injury{
      outline: 2px solid var(--injury);
      outline-offset:-2px;
      background: rgba(239,68,68,.14) !important;
    }
    .st-record{ outline: 2px solid var(--gold); outline-offset:-2px; }
    .st-newWeight{ outline: 2px solid var(--green); outline-offset:-2px; }
    .st-firstEx{ outline: 2px solid var(--yellow); outline-offset:-2px; }
    .st-notRecord{ background: var(--graybg) !important; }

    .colHeader{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .radio{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color: var(--muted);
      user-select:none;
    }
    .radio input{ margin:0; }
    .hDate{ font-weight:900; letter-spacing:.02em; }
    .hNote{
      font-size:12px;
      color:var(--muted);
      max-width: 140px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Drawer (management panel) */
    .drawerBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      display:none;
      z-index:70;
    }
    .drawerBack.show{ display:block; }
    .drawer{
      position:absolute;
      top:0; left:0;
      height:100%;
      width: min(420px, 92vw);
      background: var(--bg);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .drawerHead{
      padding: 12px 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerHead .h{
      font-weight: 900;
      letter-spacing:.02em;
      text-transform: uppercase;
      font-size: 13px;
    }
    .drawerBody{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .section{
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      margin-bottom: 12px;
    }
    .sectionHead{
      padding: 10px 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      font-weight: 900;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing:.03em;
    }
    .sectionBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .group{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in oklab, var(--bg) 80%, transparent);
    }
    .label{
      font-size:12px;
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hr{ height:1px; background: var(--border); }
    code{
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(59,130,246,.10);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 8px;
      color: var(--text);
    }

    /* Modals */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 80;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding: 12px 14px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .modalTitle{
      font-weight: 900;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .modalTitle small{
      font-weight: 700;
      color: var(--muted);
      font-size: 12px;
    }
    .modalBody{ padding: 14px; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Analytics */
    .analytics{ display:none; }
    .analytics.show{ display:block; }
    .panel{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: var(--bg);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 14px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panelHead h3{
      margin:0;
      font-size: 13px;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .panelBody{ padding: 12px 14px; }
    canvas{
      width:100%;
      height:240px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: color-mix(in oklab, var(--bg) 80%, transparent);
    }
    .split{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }

    /* Mobile tweaks */
    @media (max-width: 720px){
      :root{ --stickyW: 240px; }
      .topInner{ padding: 10px 10px; }
      .title{ display:none; } /* give table more space */
      .grid2{ grid-template-columns: 1fr; }
      .tableWrap{ height: calc(100vh - 58px); }
      .wCell{ min-width: 160px; width: 160px; }
    }
  </style>
</head>

<body>
<div class="app" id="app" data-theme="light">

  <!-- Compact top bar: table-first -->
  <div class="top">
    <div class="topInner">
      <button class="icon" id="openDrawerBtn" title="Открыть управление">☰</button>

      <div class="title">
        Матрица зала <small id="selectedWorkoutLabel">—</small>
      </div>

      <input id="workoutDate" class="small" type="text" placeholder="DD.MM.YYYY" />
      <input id="workoutNote" class="small" type="text" placeholder="заметка (опц.)" />
      <button class="primary" id="addWorkoutBtn" title="Добавить тренировку">+ Тренировка</button>
      <button class="danger" id="delWorkoutBtn" title="Удалить выбранную тренировку">Удалить</button>

      <div class="spacer"></div>

      <div class="tabs" role="tablist">
        <div class="tab active" id="tabTable" role="tab" aria-selected="true">Таблица</div>
        <div class="tab" id="tabAnalytics" role="tab" aria-selected="false">Аналитика</div>
      </div>

      <label class="toggle" title="Ночной режим">
        <input type="checkbox" id="themeToggle" />
        <span>Ночь</span>
      </label>
    </div>
  </div>

  <main>
    <!-- TABLE -->
    <section id="tableSection">
      <div class="tableWrap">
        <div class="tableMeta">
          <span class="chip" title="Рекорд по повторам на этом весе (и стороне при L/R)"><span class="dot gold"></span> Рекорд</span>
          <span class="chip" title="Первое использование веса"><span class="dot green"></span> Новый вес</span>
          <span class="chip" title="Первое выполнение упражнения"><span class="dot yellow"></span> Первое упражнение</span>
          <span class="chip" title="Есть запись, но не рекорд"><span class="dot gray"></span> Не рекорд</span>
          <span class="chip" title="Травма (вручную)"><span class="dot red"></span> Травма</span>
          <span class="spacer"></span>
          <span class="hint">Клик по ячейке → ввод <code>12+10+8</code>. Enter — сохранить, Esc — закрыть.</span>
        </div>

        <div class="scrollX" id="tableScroll">
          <table id="matrixTable" aria-label="Матрица прогресса"></table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analyticsSection" class="analytics">
      <div class="split">
        <div class="panel">
          <div class="panelHead">
            <h3>Тренд: повторы по весу</h3>
            <div class="group" style="margin:0">
              <span class="label">Период</span>
              <select id="periodSelect">
                <option value="month">Этот месяц</option>
                <option value="year">Этот год</option>
                <option value="all">Всё</option>
              </select>
              <span class="label">Блок</span>
              <select id="anBlock"></select>
              <span class="label">Упр.</span>
              <select id="anExercise"></select>
              <span class="label">Вес</span>
              <select id="anWeight"></select>
              <span class="label">Сторона</span>
              <select id="anSide">
                <option value="both">—</option>
                <option value="left">L</option>
                <option value="right">R</option>
              </select>
            </div>
          </div>
          <div class="panelBody">
            <canvas id="trendCanvas" width="1200" height="350"></canvas>
            <div class="hint" id="trendHint"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHead">
            <h3>Рекорды: по тренировкам</h3>
          </div>
          <div class="panelBody">
            <div id="kpiWrap" class="hint"></div>
            <div style="height:10px"></div>
            <canvas id="recordsCanvas" width="1200" height="350"></canvas>
            <div class="hint" id="recHint"></div>
            <div class="hr"></div>
            <div class="hint" id="monthCompare"></div>
            <div class="hr"></div>
            <div class="hint" id="recommendations"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer: Management -->
  <div class="drawerBack" id="drawerBack" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawerHead">
        <div class="h">Управление</div>
        <button id="closeDrawerBtn" class="icon" title="Закрыть">✕</button>
      </div>

      <div class="drawerBody">

        <div class="section">
          <div class="sectionHead">Структура (блоки / упражнения / веса)</div>
          <div class="sectionBody">
            <div class="group">
              <span class="label">Блок</span>
              <select id="blockSelect"></select>
              <button id="addBlockBtn">+ Блок</button>
              <button id="renameBlockBtn">Переим.</button>
              <button id="archiveBlockBtn" class="danger">Архив</button>
            </div>

            <div class="group">
              <span class="label">Упражнение</span>
              <select id="exerciseSelect"></select>
              <button id="addExerciseBtn">+ Упр.</button>
              <button id="renameExerciseBtn">Переим.</button>
              <button id="delExerciseBtn" class="danger">Удалить</button>
            </div>

            <div class="group">
              <span class="label">Вес</span>
              <select id="weightSelect"></select>
              <input id="addWeightVal" class="tiny" type="number" step="0.5" placeholder="вес" />
              <button id="addWeightBtn">+ Вес</button>
              <button id="toggleWeightHideBtn">Скрыть/показать</button>
              <label class="toggle" title="L/R отдельно для этого веса">
                <input type="checkbox" id="lrToggle" />
                <span>L/R</span>
              </label>
            </div>

            <div class="hint">
              <b>Важно:</b> скрытые веса не удаляются и остаются в истории.
            </div>
          </div>
        </div>

        <div class="section">
          <div class="sectionHead">Отображение и правила</div>
          <div class="sectionBody">
            <div class="group">
              <span class="label">Метрика рекорда</span>
              <select id="metricSelect" title="Влияет на рекорд/цели">
                <option value="sum">Сумма</option>
                <option value="best">Лучший подход</option>
                <option value="avg">Среднее</option>
              </select>
            </div>
            <div class="group">
              <label class="toggle" title="Показывать скрытые веса в таблице">
                <input type="checkbox" id="showHiddenWeights" />
                <span>Показывать скрытые веса</span>
              </label>
            </div>
            <div class="hint">
              Цель “надо N” показывается <b>всегда</b> в каждой ячейке: это (исторический максимум по метрике) + 1.
            </div>
          </div>
        </div>

        <div class="section">
          <div class="sectionHead">Данные</div>
          <div class="sectionBody">
            <div class="group">
              <button id="exportBtn">Экспорт JSON</button>
              <button id="importBtn">Импорт JSON</button>
              <button id="resetDemoBtn" class="danger">Сбросить всё</button>
            </div>
            <div class="hint">
              Импорт заменяет все данные (надежный перенос). Экспорт — бэкап.
            </div>
          </div>
        </div>

        <div class="section">
          <div class="sectionHead">Подсказки</div>
          <div class="sectionBody">
            <div class="hint">
              • Тренировки сортируются: <b>самая свежая слева</b>.<br/>
              • Клик по заголовку даты открывает статистику тренировки.<br/>
              • В ячейке: <code>12+10+8</code>, 0 считается пустым.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Cell editor modal -->
  <div class="modalBack" id="cellModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="modalTitle" id="cellModalTitle">Редактор</div>
        <button id="cellModalCloseBtn">Закрыть (Esc)</button>
      </div>
      <div class="modalBody">
        <div id="cellModalMeta" class="hint" style="margin-top:0"></div>
        <div class="hr" style="margin:10px 0"></div>

        <div id="cellEditorSingle">
          <div class="group" style="width:100%">
            <span class="label">Подходы</span>
            <input id="setsInput" type="text" style="flex:1" placeholder="например 12+10+8" />
          </div>
        </div>

        <div id="cellEditorLR" style="display:none">
          <div class="grid2">
            <div class="group" style="width:100%">
              <span class="label">L</span>
              <input id="leftSetsInput" type="text" style="flex:1" placeholder="12+10+8" />
            </div>
            <div class="group" style="width:100%">
              <span class="label">R</span>
              <input id="rightSetsInput" type="text" style="flex:1" placeholder="12+10+8" />
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="group" style="justify-content:space-between">
          <label class="toggle" title="Травма (красный доминирует)">
            <input type="checkbox" id="injuryToggle" />
            <span>Травма</span>
          </label>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="primary" id="saveCellBtn">Сохранить (Enter)</button>
            <button class="danger" id="clearCellBtn">Очистить</button>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          Разделители чистятся автоматически: пробелы/запятые → <code>+</code>. Нули игнорируются.
        </div>
      </div>
    </div>
  </div>

  <!-- Workout stats modal -->
  <div class="modalBack" id="statsModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="modalTitle" id="statsTitle">Статистика тренировки</div>
        <button id="statsCloseBtn">Закрыть (Esc)</button>
      </div>
      <div class="modalBody">
        <div id="statsKpi" class="hint"></div>
        <div class="hr" style="margin:10px 0"></div>
        <div id="statsByBlock"></div>
      </div>
    </div>
  </div>

  <!-- Import/Export modal -->
  <div class="modalBack" id="ioModalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div class="modalTitle" id="ioTitle">JSON</div>
        <button id="ioCloseBtn">Закрыть (Esc)</button>
      </div>
      <div class="modalBody">
        <div class="group">
          <button id="downloadJsonBtn" class="primary">Скачать JSON</button>
          <label class="toggle" title="Импорт из файла">
            <input type="file" id="importFile" accept="application/json" />
            <span>Файл</span>
          </label>
          <button id="applyImportBtn" class="danger">Импортировать (заменить всё)</button>
        </div>
        <div class="hint">Импорт полностью заменяет данные. Перед импортом лучше сделать экспорт.</div>
        <div class="hr" style="margin:10px 0"></div>
        <textarea id="ioTextarea" rows="12" style="width:100%" placeholder="Тут появится JSON для экспорта или вставь JSON для импорта"></textarea>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  "use strict";

  const LS_KEY = "gym_matrix_v2_tablefirst";
  const NOW = () => new Date();
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
  const pad2 = n => (String(n).length===1 ? "0"+n : String(n));

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // normalize date from common formats
  function normalizeDate(input){
    const s0 = (input||"").trim();
    if(!s0) return null;
    let s = s0.replace(/[\/\-]/g, ".").replace(/\s+/g,"");
    if(/^\d{8}$/.test(s)){ s = s.slice(0,2)+"."+s.slice(2,4)+"."+s.slice(4); }
    const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if(!m) return null;
    let d=Number(m[1]), mo=Number(m[2]), y=Number(m[3]);
    if(!(y>=1900 && y<=2100)) return null;
    d=clamp(d,1,31); mo=clamp(mo,1,12);
    const dt = new Date(y, mo-1, d);
    if(dt.getFullYear()!==y || dt.getMonth()!==(mo-1) || dt.getDate()!==d){
      const last = new Date(y, mo, 0).getDate();
      d = clamp(d,1,last);
    }
    return `${pad2(d)}.${pad2(mo)}.${y}`;
  }
  function parseDateToTs(ddmmyyyy){
    const m = (ddmmyyyy||"").match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if(!m) return NaN;
    const d=Number(m[1]), mo=Number(m[2]), y=Number(m[3]);
    return new Date(y,mo-1,d).getTime();
  }

  function cleanSetsString(s){
    const raw = (s||"").trim();
    if(!raw) return "";
    const parts = raw
      .replace(/[，、;]/g, ",")
      .replace(/\s+/g, "")
      .replace(/,/g, "+")
      .split("+")
      .map(x => x.replace(/[^\d]/g,""))
      .filter(x => x.length)
      .map(x => String(Number(x)))
      .filter(x => x !== "0" && x !== "NaN");
    return parts.join("+");
  }
  function parseSetsToNumbers(setsStr){
    const s = cleanSetsString(setsStr);
    if(!s) return [];
    return s.split("+").map(x=>Number(x)).filter(n=>Number.isFinite(n) && n>0);
  }
  function calcMetric(nums, metric){
    if(!nums.length) return 0;
    if(metric==="best") return Math.max(...nums);
    if(metric==="avg") return Math.round((nums.reduce((a,b)=>a+b,0)/nums.length)*10)/10;
    return nums.reduce((a,b)=>a+b,0);
  }
  function countSets(setsStr){ return parseSetsToNumbers(setsStr).length; }

  function weekKey(ts){
    const d = new Date(ts);
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
    return `${date.getUTCFullYear()}-W${pad2(weekNo)}`;
  }
  function monthKey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }

  function defaultData(demo=true){
    const data = {
      dataVersion: 1,
      settings: {
        theme:"light",
        showHiddenWeights:false,
        recordMetric:"sum",
        newestLeft:true
      },
      blocks: [],
      exercises: [],
      weightVariants: [],
      workouts: [],
      cells: {}
    };
    if(!demo) return data;

    const bChest = { id: uid(), name: "ГРУДЬ", archived:false };
    const bBiceps = { id: uid(), name: "БИЦЕПС", archived:false };
    data.blocks.push(bChest, bBiceps);

    const exBench = { id: uid(), blockId: bChest.id, name: "жим лёжа", deleted:false };
    const exFly = { id: uid(), blockId: bChest.id, name: "разводка", deleted:false };
    const exCurl = { id: uid(), blockId: bBiceps.id, name: "сгибания", deleted:false };
    data.exercises.push(exBench, exFly, exCurl);

    const wBench40 = { id: uid(), exerciseId: exBench.id, value: 40, unit:"кг", hidden:false, lr:false };
    const wBench50 = { id: uid(), exerciseId: exBench.id, value: 50, unit:"кг", hidden:false, lr:false };
    const wFly12 = { id: uid(), exerciseId: exFly.id, value: 12, unit:"кг", hidden:false, lr:true };
    const wCurl14 = { id: uid(), exerciseId: exCurl.id, value: 14, unit:"кг", hidden:false, lr:true };
    data.weightVariants.push(wBench40, wBench50, wFly12, wCurl14);

    const w1 = { id: uid(), date: "02.01.2026", note:"лёгкая" };
    const w2 = { id: uid(), date: "04.01.2026", note:"" };
    data.workouts.push(w1,w2);
    data.cells[w1.id] = {};
    data.cells[w2.id] = {};
    data.cells[w1.id][wBench40.id] = { injury:false, sets:"12+10+10", leftSets:"", rightSets:"" };
    data.cells[w1.id][wBench50.id] = { injury:false, sets:"8+8+6", leftSets:"", rightSets:"" };
    data.cells[w1.id][wFly12.id]   = { injury:false, sets:"", leftSets:"12+10+10", rightSets:"12+10+8" };
    data.cells[w2.id][wBench40.id] = { injury:false, sets:"12+12+10", leftSets:"", rightSets:"" };
    data.cells[w2.id][wBench50.id] = { injury:true,  sets:"8+7+6", leftSets:"", rightSets:"" };
    data.cells[w2.id][wFly12.id]   = { injury:false, sets:"", leftSets:"12+12+10", rightSets:"12+10+10" };
    data.cells[w2.id][wCurl14.id]  = { injury:false, sets:"", leftSets:"10+10+8", rightSets:"10+8+8" };

    return data;
  }

  function migrateData(raw){
    let d = raw && typeof raw==="object" ? raw : null;
    if(!d) return defaultData(true);
    const v = Number(d.dataVersion||0);
    if(v < 1) d.dataVersion = 1;

    d.settings = d.settings || {};
    d.settings.theme = d.settings.theme || "light";
    d.settings.showHiddenWeights = !!d.settings.showHiddenWeights;
    d.settings.recordMetric = d.settings.recordMetric || "sum";
    d.settings.newestLeft = (d.settings.newestLeft !== false);

    d.blocks = Array.isArray(d.blocks) ? d.blocks : [];
    d.exercises = Array.isArray(d.exercises) ? d.exercises : [];
    d.weightVariants = Array.isArray(d.weightVariants) ? d.weightVariants : [];
    d.workouts = Array.isArray(d.workouts) ? d.workouts : [];
    d.cells = (d.cells && typeof d.cells==="object") ? d.cells : {};

    for(const b of d.blocks){
      if(b.archived == null) b.archived = false;
      if(!b.id) b.id = uid();
      if(!b.name) b.name = "БЛОК";
    }
    for(const ex of d.exercises){
      if(ex.deleted == null) ex.deleted = false;
      if(!ex.id) ex.id = uid();
      if(!ex.name) ex.name = "упражнение";
    }
    for(const w of d.weightVariants){
      if(w.hidden == null) w.hidden = false;
      if(w.lr == null) w.lr = false;
      if(!w.unit) w.unit = "кг";
      if(!w.id) w.id = uid();
      if(typeof w.value !== "number") w.value = Number(w.value)||0;
    }
    for(const wo of d.workouts){
      if(!wo.id) wo.id = uid();
      wo.note = wo.note || "";
      const nd = normalizeDate(wo.date);
      wo.date = nd || wo.date || "01.01.2000";
      if(!d.cells[wo.id] || typeof d.cells[wo.id] !== "object") d.cells[wo.id] = {};
    }
    return d;
  }

  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultData(true);
    try{ return migrateData(JSON.parse(raw)); }
    catch{ return defaultData(true); }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

  const state = {
    data: load(),
    ui: {
      selectedWorkoutId: null,
      selectedBlockId: null,
      selectedExerciseId: null,
      selectedWeightId: null,
      activeTab: "table",
      cellEdit: null,
      drawerOpen: false
    },
    cache: { statsByCell: null }
  };

  const D = () => state.data;

  // DOM
  const app = document.getElementById("app");
  const selectedWorkoutLabel = document.getElementById("selectedWorkoutLabel");
  const workoutDate = document.getElementById("workoutDate");
  const workoutNote = document.getElementById("workoutNote");
  const addWorkoutBtn = document.getElementById("addWorkoutBtn");
  const delWorkoutBtn = document.getElementById("delWorkoutBtn");
  const themeToggle = document.getElementById("themeToggle");

  const tabTable = document.getElementById("tabTable");
  const tabAnalytics = document.getElementById("tabAnalytics");
  const tableSection = document.getElementById("tableSection");
  const analyticsSection = document.getElementById("analyticsSection");

  const matrixTable = document.getElementById("matrixTable");

  // Drawer
  const drawerBack = document.getElementById("drawerBack");
  const openDrawerBtn = document.getElementById("openDrawerBtn");
  const closeDrawerBtn = document.getElementById("closeDrawerBtn");

  // Drawer controls
  const blockSelect = document.getElementById("blockSelect");
  const exerciseSelect = document.getElementById("exerciseSelect");
  const weightSelect = document.getElementById("weightSelect");
  const addBlockBtn = document.getElementById("addBlockBtn");
  const renameBlockBtn = document.getElementById("renameBlockBtn");
  const archiveBlockBtn = document.getElementById("archiveBlockBtn");
  const addExerciseBtn = document.getElementById("addExerciseBtn");
  const renameExerciseBtn = document.getElementById("renameExerciseBtn");
  const delExerciseBtn = document.getElementById("delExerciseBtn");
  const addWeightVal = document.getElementById("addWeightVal");
  const addWeightBtn = document.getElementById("addWeightBtn");
  const toggleWeightHideBtn = document.getElementById("toggleWeightHideBtn");
  const lrToggle = document.getElementById("lrToggle");

  const metricSelect = document.getElementById("metricSelect");
  const showHiddenWeights = document.getElementById("showHiddenWeights");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const resetDemoBtn = document.getElementById("resetDemoBtn");

  // Modals
  const cellModalBack = document.getElementById("cellModalBack");
  const cellModalTitle = document.getElementById("cellModalTitle");
  const cellModalMeta = document.getElementById("cellModalMeta");
  const cellModalCloseBtn = document.getElementById("cellModalCloseBtn");
  const setsInput = document.getElementById("setsInput");
  const leftSetsInput = document.getElementById("leftSetsInput");
  const rightSetsInput = document.getElementById("rightSetsInput");
  const injuryToggle = document.getElementById("injuryToggle");
  const saveCellBtn = document.getElementById("saveCellBtn");
  const clearCellBtn = document.getElementById("clearCellBtn");
  const cellEditorSingle = document.getElementById("cellEditorSingle");
  const cellEditorLR = document.getElementById("cellEditorLR");

  const statsModalBack = document.getElementById("statsModalBack");
  const statsTitle = document.getElementById("statsTitle");
  const statsCloseBtn = document.getElementById("statsCloseBtn");
  const statsKpi = document.getElementById("statsKpi");
  const statsByBlock = document.getElementById("statsByBlock");

  const ioModalBack = document.getElementById("ioModalBack");
  const ioTitle = document.getElementById("ioTitle");
  const ioCloseBtn = document.getElementById("ioCloseBtn");
  const ioTextarea = document.getElementById("ioTextarea");
  const downloadJsonBtn = document.getElementById("downloadJsonBtn");
  const importFile = document.getElementById("importFile");
  const applyImportBtn = document.getElementById("applyImportBtn");

  // Analytics
  const periodSelect = document.getElementById("periodSelect");
  const anBlock = document.getElementById("anBlock");
  const anExercise = document.getElementById("anExercise");
  const anWeight = document.getElementById("anWeight");
  const anSide = document.getElementById("anSide");
  const trendCanvas = document.getElementById("trendCanvas");
  const recordsCanvas = document.getElementById("recordsCanvas");
  const trendHint = document.getElementById("trendHint");
  const kpiWrap = document.getElementById("kpiWrap");
  const recHint = document.getElementById("recHint");
  const monthCompare = document.getElementById("monthCompare");
  const recommendations = document.getElementById("recommendations");

  // Data helpers
  const blocksVisible = () => D().blocks.filter(b => !b.archived);
  const blockById = id => D().blocks.find(b=>b.id===id)||null;
  const exerciseById = id => D().exercises.find(e=>e.id===id)||null;
  const weightById = id => D().weightVariants.find(w=>w.id===id)||null;
  const workoutById = id => D().workouts.find(w=>w.id===id)||null;

  const exercisesOfBlock = blockId => D().exercises.filter(e=>e.blockId===blockId && !e.deleted);
  const weightsOfExercise = exId => D().weightVariants.filter(w=>w.exerciseId===exId);

  function workoutsSortedNewestLeft(){
    const arr = [...D().workouts];
    arr.sort((a,b)=>parseDateToTs(b.date)-parseDateToTs(a.date)); // newest first
    return arr;
  }

  function ensureSelections(){
    const visBlocks = blocksVisible();
    if(!state.ui.selectedBlockId || !visBlocks.some(b=>b.id===state.ui.selectedBlockId)){
      state.ui.selectedBlockId = visBlocks[0]?.id || null;
    }
    const exs = state.ui.selectedBlockId ? exercisesOfBlock(state.ui.selectedBlockId) : [];
    if(!state.ui.selectedExerciseId || !exs.some(e=>e.id===state.ui.selectedExerciseId)){
      state.ui.selectedExerciseId = exs[0]?.id || null;
    }
    const ws = state.ui.selectedExerciseId ? weightsOfExercise(state.ui.selectedExerciseId) : [];
    if(!state.ui.selectedWeightId || !ws.some(w=>w.id===state.ui.selectedWeightId)){
      state.ui.selectedWeightId = ws[0]?.id || null;
    }

    const wo = workoutsSortedNewestLeft();
    if(!state.ui.selectedWorkoutId || !wo.some(w=>w.id===state.ui.selectedWorkoutId)){
      state.ui.selectedWorkoutId = wo[0]?.id || null;
    }
  }

  function getCell(workoutId, weightId){
    if(!D().cells[workoutId]) D().cells[workoutId] = {};
    if(!D().cells[workoutId][weightId]){
      D().cells[workoutId][weightId] = { injury:false, sets:"", leftSets:"", rightSets:"" };
    }
    return D().cells[workoutId][weightId];
  }

  // Compute
  function computeAll(){
    const metric = D().settings.recordMetric;
    const woOldest = [...D().workouts].sort((a,b)=>parseDateToTs(a.date)-parseDateToTs(b.date));

    const best = new Map(); // weightId -> {best, bestLeft, bestRight}
    const firstWeightUse = new Map();
    const firstExerciseUse = new Map();

    for(const wo of woOldest){
      const cells = D().cells[wo.id] || {};
      for(const [weightId, cell] of Object.entries(cells)){
        const w = weightById(weightId);
        if(!w) continue;
        const exId = w.exerciseId;

        const val = calcMetric(parseSetsToNumbers(cell.sets||""), metric);
        const lval = calcMetric(parseSetsToNumbers(cell.leftSets||""), metric);
        const rval = calcMetric(parseSetsToNumbers(cell.rightSets||""), metric);
        const usedAny = (val>0)||(lval>0)||(rval>0);
        if(usedAny){
          if(!firstWeightUse.has(weightId)) firstWeightUse.set(weightId, wo.id);
          if(!firstExerciseUse.has(exId)) firstExerciseUse.set(exId, wo.id);
        }
      }
    }

    for(const wo of woOldest){
      const cells = D().cells[wo.id] || {};
      for(const [weightId, cell] of Object.entries(cells)){
        const w = weightById(weightId);
        if(!w) continue;
        const rec = best.get(weightId) || { best:0, bestLeft:0, bestRight:0 };
        if(w.lr){
          const lval = calcMetric(parseSetsToNumbers(cell.leftSets||""), metric);
          const rval = calcMetric(parseSetsToNumbers(cell.rightSets||""), metric);
          if(lval > rec.bestLeft) rec.bestLeft = lval;
          if(rval > rec.bestRight) rec.bestRight = rval;
        }else{
          const val = calcMetric(parseSetsToNumbers(cell.sets||""), metric);
          if(val > rec.best) rec.best = val;
        }
        best.set(weightId, rec);
      }
    }

    state.cache.statsByCell = { best, firstWeightUse, firstExerciseUse };
  }

  function getGoalForWeight(weightId){
    const w = weightById(weightId);
    const rec = state.cache.statsByCell?.best.get(weightId) || { best:0, bestLeft:0, bestRight:0 };
    if(w && w.lr){
      return { left:(rec.bestLeft||0)+1, right:(rec.bestRight||0)+1 };
    }
    return { both:(rec.best||0)+1 };
  }

  function evaluateCellStatus(workoutId, weightId){
    const w = weightById(weightId);
    if(!w) return { cls:"", flags:{} };
    const metric = D().settings.recordMetric;
    const cell = getCell(workoutId, weightId);

    const injury = !!cell.injury;
    const firstWeightUse = state.cache.statsByCell.firstWeightUse.get(weightId) || null;
    const firstExerciseUse = state.cache.statsByCell.firstExerciseUse.get(w.exerciseId) || null;

    const isNewWeight = (firstWeightUse === workoutId);
    const isFirstExercise = (firstExerciseUse === workoutId);

    const rec = state.cache.statsByCell.best.get(weightId) || { best:0, bestLeft:0, bestRight:0 };

    let hasAny=false, isRecord=false, isNotRecord=false;

    if(w.lr){
      const lval = calcMetric(parseSetsToNumbers(cell.leftSets||""), metric);
      const rval = calcMetric(parseSetsToNumbers(cell.rightSets||""), metric);
      hasAny = (lval>0)||(rval>0);
      const lIs = (lval>0) && (lval >= (rec.bestLeft||0));
      const rIs = (rval>0) && (rval >= (rec.bestRight||0));
      isRecord = lIs || rIs;
      isNotRecord = hasAny && !isRecord;
    }else{
      const val = calcMetric(parseSetsToNumbers(cell.sets||""), metric);
      hasAny = val>0;
      isRecord = hasAny && (val >= (rec.best||0));
      isNotRecord = hasAny && !isRecord;
    }

    let cls = "";
    if(injury) cls="st-injury";
    else if(isRecord) cls="st-record";
    else if(isNewWeight) cls="st-newWeight";
    else if(isFirstExercise) cls="st-firstEx";
    else if(isNotRecord) cls="st-notRecord";

    return { cls, flags:{ injury,isRecord,isNewWeight,isFirstExercise,isNotRecord,hasAny } };
  }

  function starSvg(){
    return `
      <svg class="star" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 2.2l2.9 6.2 6.8.6-5.1 4.4 1.6 6.6-6.2-3.6-6.2 3.6 1.6-6.6-5.1-4.4 6.8-.6L12 2.2z"
          stroke="currentColor" stroke-width="2" fill="none" />
      </svg>`;
  }

  // Rendering: drawer selectors
  function renderSelectors(){
    ensureSelections();

    const blocks = blocksVisible();
    blockSelect.innerHTML = blocks.map(b=>`<option value="${b.id}">${escapeHtml(b.name)}</option>`).join("") || `<option value="">(нет блоков)</option>`;
    blockSelect.value = state.ui.selectedBlockId || "";

    const exs = state.ui.selectedBlockId ? exercisesOfBlock(state.ui.selectedBlockId) : [];
    exerciseSelect.innerHTML = exs.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join("") || `<option value="">(нет упражнений)</option>`;
    exerciseSelect.value = state.ui.selectedExerciseId || "";

    const ws = state.ui.selectedExerciseId ? weightsOfExercise(state.ui.selectedExerciseId) : [];
    weightSelect.innerHTML = ws.map(w=>{
      const hid = w.hidden ? " (скрыт)" : "";
      const lr = w.lr ? " L/R" : "";
      return `<option value="${w.id}">${escapeHtml(String(w.value))} ${escapeHtml(w.unit)}${hid}${lr}</option>`;
    }).join("") || `<option value="">(нет весов)</option>`;
    weightSelect.value = state.ui.selectedWeightId || "";

    const selW = state.ui.selectedWeightId ? weightById(state.ui.selectedWeightId) : null;
    lrToggle.checked = !!(selW && selW.lr);

    themeToggle.checked = D().settings.theme === "dark";
    showHiddenWeights.checked = !!D().settings.showHiddenWeights;
    metricSelect.value = D().settings.recordMetric;

    const wo = state.ui.selectedWorkoutId ? workoutById(state.ui.selectedWorkoutId) : null;
    selectedWorkoutLabel.textContent = wo ? `${wo.date}${wo.note ? " • " + wo.note : ""}` : "—";
  }

  // Rendering: table
  function renderTable(){
    computeAll();
    ensureSelections();

    const workouts = workoutsSortedNewestLeft();
    const showHidden = !!D().settings.showHiddenWeights;

    // rows hierarchy
    const rows = [];
    for(const b of D().blocks){
      if(b.archived) continue;
      rows.push({ type:"block", block:b });
      const exs = exercisesOfBlock(b.id);
      for(const ex of exs){
        rows.push({ type:"exercise", ex });
        for(const w of weightsOfExercise(ex.id)){
          if(!showHidden && w.hidden) continue;
          rows.push({ type:"weight", w, ex, block:b });
        }
      }
    }

    // head
    let thead = `<thead><tr>`;
    thead += `<th>Структура</th>`;
    for(const wo of workouts){
      const isSel = wo.id === state.ui.selectedWorkoutId;
      thead += `
        <th data-workout-header="${wo.id}">
          <div class="colHeader">
            <label class="radio" title="Выбрать тренировку">
              <input type="radio" name="selectedWorkout" value="${wo.id}" ${isSel ? "checked":""} />
              <span>выбрать</span>
            </label>
            <div style="min-width:0">
              <div class="hDate">${escapeHtml(wo.date)}</div>
              <div class="hNote" title="${escapeHtml(wo.note||"")}">${escapeHtml(wo.note||"")}</div>
            </div>
          </div>
        </th>`;
    }
    thead += `</tr></thead>`;

    // body
    let tbody = `<tbody>`;
    for(const r of rows){
      if(r.type==="block"){
        tbody += `<tr><th class="rowBlock">${escapeHtml(r.block.name)}</th>`;
        for(let i=0;i<workouts.length;i++) tbody += `<td class="wCell rowBlock" style="cursor:default"></td>`;
        tbody += `</tr>`;
        continue;
      }
      if(r.type==="exercise"){
        tbody += `<tr><th class="rowExercise">${escapeHtml(r.ex.name)}</th>`;
        for(let i=0;i<workouts.length;i++) tbody += `<td class="wCell rowExercise" style="cursor:default"></td>`;
        tbody += `</tr>`;
        continue;
      }

      const w = r.w;
      const lr = w.lr ? ` <span class="submeta">L/R</span>` : "";
      const hid = w.hidden ? ` <span class="submeta">(скрыт)</span>` : "";
      tbody += `<tr><th class="rowWeight">${escapeHtml(String(w.value))} ${escapeHtml(w.unit)}${lr}${hid}</th>`;

      for(const wo of workouts){
        const cell = getCell(wo.id, w.id);
        const st = evaluateCellStatus(wo.id, w.id);
        const goals = getGoalForWeight(w.id);

        let valueLine="", goalLine="";

        if(w.lr){
          const l = cleanSetsString(cell.leftSets||"");
          const rr = cleanSetsString(cell.rightSets||"");
          valueLine = `<div class="cellValue">L: ${escapeHtml(l||"—")} | R: ${escapeHtml(rr||"—")}</div>`;

          const rec = state.cache.statsByCell.best.get(w.id) || { bestLeft:0, bestRight:0 };
          const metric = D().settings.recordMetric;
          const lval = calcMetric(parseSetsToNumbers(cell.leftSets||""), metric);
          const rval = calcMetric(parseSetsToNumbers(cell.rightSets||""), metric);
          const lRec = (lval>0) && (lval >= (rec.bestLeft||0));
          const rRec = (rval>0) && (rval >= (rec.bestRight||0));
          if(lRec || rRec){
            goalLine = `<div class="cellGoal"><span class="badge">${starSvg()} рекорд!</span></div>`;
          }else{
            goalLine = `<div class="cellGoal">надо L:${goals.left} • R:${goals.right}</div>`;
          }
        }else{
          const s = cleanSetsString(cell.sets||"");
          valueLine = `<div class="cellValue">${escapeHtml(s||"—")}</div>`;
          const rec = state.cache.statsByCell.best.get(w.id) || { best:0 };
          const metric = D().settings.recordMetric;
          const val = calcMetric(parseSetsToNumbers(cell.sets||""), metric);
          const isRec = (val>0) && (val >= (rec.best||0));
          if(isRec){
            goalLine = `<div class="cellGoal"><span class="badge">${starSvg()} рекорд!</span></div>`;
          }else{
            goalLine = `<div class="cellGoal">надо ${goals.both}</div>`;
          }
        }

        tbody += `
          <td class="wCell ${st.cls}" data-cell="${wo.id}::${w.id}">
            <div class="cellInner">
              ${valueLine}
              ${goalLine}
            </div>
          </td>`;
      }
      tbody += `</tr>`;
    }
    tbody += `</tbody>`;

    matrixTable.innerHTML = thead + tbody;

    // header events
    matrixTable.querySelectorAll('input[name="selectedWorkout"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        state.ui.selectedWorkoutId = r.value;
        renderSelectors();
      });
    });

    matrixTable.querySelectorAll("th[data-workout-header]").forEach(th=>{
      th.addEventListener("click", (e)=>{
        const woId = th.getAttribute("data-workout-header");
        if(!woId) return;
        if((e.target && e.target.tagName==="INPUT") || (e.target && e.target.closest && e.target.closest("label.radio"))) return;
        openWorkoutStats(woId);
      });
    });

    // cell click
    matrixTable.querySelectorAll("td[data-cell]").forEach(td=>{
      td.addEventListener("click", ()=>{
        const [workoutId, weightId] = td.getAttribute("data-cell").split("::");
        openCellEditor(workoutId, weightId);
      });
    });
  }

  // Drawer
  function setDrawer(open){
    state.ui.drawerOpen = open;
    if(open){
      drawerBack.classList.add("show");
      drawerBack.setAttribute("aria-hidden","false");
    }else{
      drawerBack.classList.remove("show");
      drawerBack.setAttribute("aria-hidden","true");
    }
  }

  function applyTheme(){
    app.setAttribute("data-theme", D().settings.theme);
  }

  // Modals helpers
  function showModal(backdrop){
    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden","false");
  }
  function hideModal(backdrop){
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden","true");
  }

  // Cell editor
  function openCellEditor(workoutId, weightId){
    const w = weightById(weightId);
    const wo = workoutById(workoutId);
    if(!w || !wo) return;

    state.ui.cellEdit = { workoutId, weightId };

    const ex = exerciseById(w.exerciseId);
    const b = ex ? blockById(ex.blockId) : null;

    cellModalTitle.innerHTML = `Редактор <small>${escapeHtml(wo.date)} • ${escapeHtml(ex?.name||"")} • ${escapeHtml(String(w.value))} ${escapeHtml(w.unit)}${w.lr?" • L/R":""}</small>`;
    cellModalMeta.innerHTML = `Блок: <b>${escapeHtml(b?.name||"—")}</b> • Упражнение: <b>${escapeHtml(ex?.name||"—")}</b> • Вес: <b>${escapeHtml(String(w.value))} ${escapeHtml(w.unit)}</b>`;

    const cell = getCell(workoutId, weightId);
    injuryToggle.checked = !!cell.injury;

    if(w.lr){
      cellEditorSingle.style.display="none";
      cellEditorLR.style.display="";
      leftSetsInput.value = cell.leftSets || "";
      rightSetsInput.value = cell.rightSets || "";
      setsInput.value = "";
      setTimeout(()=>leftSetsInput.focus(),0);
    }else{
      cellEditorSingle.style.display="";
      cellEditorLR.style.display="none";
      setsInput.value = cell.sets || "";
      leftSetsInput.value = "";
      rightSetsInput.value = "";
      setTimeout(()=>setsInput.focus(),0);
    }

    showModal(cellModalBack);
  }
  function closeCellEditor(){
    state.ui.cellEdit = null;
    hideModal(cellModalBack);
  }
  function saveCell(){
    const ed = state.ui.cellEdit;
    if(!ed) return;
    const w = weightById(ed.weightId);
    if(!w) return;
    const cell = getCell(ed.workoutId, ed.weightId);
    cell.injury = !!injuryToggle.checked;
    if(w.lr){
      cell.leftSets = cleanSetsString(leftSetsInput.value);
      cell.rightSets = cleanSetsString(rightSetsInput.value);
      cell.sets = "";
    }else{
      cell.sets = cleanSetsString(setsInput.value);
      cell.leftSets = "";
      cell.rightSets = "";
    }
    save();
    renderAll();
    closeCellEditor();
  }
  function clearCell(){
    const ed = state.ui.cellEdit;
    if(!ed) return;
    const cell = getCell(ed.workoutId, ed.weightId);
    cell.injury=false;
    cell.sets=""; cell.leftSets=""; cell.rightSets="";
    save();
    renderAll();
    closeCellEditor();
  }

  // Stats
  function openWorkoutStats(workoutId){
    const wo = workoutById(workoutId);
    if(!wo) return;
    computeAll();

    let recCount=0, newWCount=0, firstExCount=0, injuryCount=0;
    const setsByBlock = new Map(); // name -> {total,left,right}

    for(const w of D().weightVariants){
      const st = evaluateCellStatus(workoutId, w.id);
      const cell = getCell(workoutId, w.id);
      const ex = exerciseById(w.exerciseId);
      const b = ex ? blockById(ex.blockId) : null;
      const bName = b ? b.name : "—";
      if(!setsByBlock.has(bName)) setsByBlock.set(bName, { total:0,left:0,right:0 });

      if(st.flags.injury) injuryCount++;
      if(st.flags.isRecord) recCount++;
      if(st.flags.isNewWeight) newWCount++;
      if(st.flags.isFirstExercise) firstExCount++;

      if(w.lr){
        const l = countSets(cell.leftSets||"");
        const r = countSets(cell.rightSets||"");
        setsByBlock.get(bName).total += (l+r);
        setsByBlock.get(bName).left += l;
        setsByBlock.get(bName).right += r;
      }else{
        setsByBlock.get(bName).total += countSets(cell.sets||"");
      }
    }

    statsTitle.innerHTML = `Статистика тренировки <small>${escapeHtml(wo.date)}${wo.note? " • "+escapeHtml(wo.note):""}</small>`;
    statsKpi.innerHTML = `
      <div class="hint"><b style="color:var(--gold)">Рекорды:</b> ${recCount} •
      <b style="color:var(--green)">Новые веса:</b> ${newWCount} •
      <b style="color:var(--yellow)">Новые упражнения:</b> ${firstExCount} •
      <b style="color:var(--injury)">Травмы:</b> ${injuryCount}</div>
    `;

    const blocksSorted = [...setsByBlock.entries()].sort((a,b)=>a[0].localeCompare(b[0],'ru'));
    let html="";
    for(const [name, v] of blocksSorted){
      const lrPart = (v.left||v.right) ? ` <span class="submeta">(L/R: ${v.left}/${v.right})</span>` : "";
      html += `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
        <b style="text-transform:uppercase">${escapeHtml(name)}</b>
        <div class="hint" style="margin-top:4px">Подходов: <b>${v.total}</b>${lrPart}</div>
      </div>`;
    }
    statsByBlock.innerHTML = html || `<div class="hint">Нет данных.</div>`;
    showModal(statsModalBack);
  }

  // CRUD: workouts
  function addWorkout(){
    const nd = normalizeDate(workoutDate.value);
    if(!nd){
      alert("Дата должна быть DD.MM.YYYY (пример: 05.01.2026).");
      return;
    }
    const note = (workoutNote.value||"").trim();
    const wo = { id: uid(), date: nd, note };
    D().workouts.push(wo);
    D().cells[wo.id] = D().cells[wo.id] || {};
    state.ui.selectedWorkoutId = wo.id;
    workoutDate.value=""; workoutNote.value="";
    save(); renderAll();
  }
  function deleteSelectedWorkout(){
    const id = state.ui.selectedWorkoutId;
    if(!id){ alert("Выбери тренировку (радио в заголовке)."); return; }
    const wo = workoutById(id);
    if(!wo) return;
    if(!confirm(`Удалить тренировку ${wo.date}? Это удалит всю колонку.`)) return;
    D().workouts = D().workouts.filter(w=>w.id!==id);
    delete D().cells[id];
    state.ui.selectedWorkoutId = workoutsSortedNewestLeft()[0]?.id || null;
    save(); renderAll();
  }

  // CRUD: structure
  function addBlock(){
    const name = prompt("Название блока (в верхнем регистре):", "НОВЫЙ БЛОК");
    if(!name) return;
    const b = { id: uid(), name: name.trim().toUpperCase(), archived:false };
    D().blocks.push(b);
    state.ui.selectedBlockId = b.id;
    save(); renderAll();
  }
  function renameBlock(){
    const b = blockById(state.ui.selectedBlockId);
    if(!b){ alert("Нет выбранного блока."); return; }
    const name = prompt("Новое название блока:", b.name);
    if(!name) return;
    b.name = name.trim().toUpperCase();
    save(); renderAll();
  }
  function archiveBlock(){
    const b = blockById(state.ui.selectedBlockId);
    if(!b){ alert("Нет выбранного блока."); return; }
    if(!confirm(`Архивировать блок "${b.name}"? Он исчезнет из таблицы, история останется.`)) return;
    b.archived = true;
    state.ui.selectedBlockId = blocksVisible()[0]?.id || null;
    save(); renderAll();
  }

  function addExercise(){
    const b = blockById(state.ui.selectedBlockId);
    if(!b){ alert("Сначала выбери/создай блок."); return; }
    const name = prompt("Название упражнения (строчные):", "новое упражнение");
    if(!name) return;
    const ex = { id: uid(), blockId: b.id, name: name.trim().toLowerCase(), deleted:false };
    D().exercises.push(ex);
    state.ui.selectedExerciseId = ex.id;
    save(); renderAll();
  }
  function renameExercise(){
    const ex = exerciseById(state.ui.selectedExerciseId);
    if(!ex){ alert("Нет выбранного упражнения."); return; }
    const name = prompt("Новое название упражнения:", ex.name);
    if(!name) return;
    ex.name = name.trim().toLowerCase();
    save(); renderAll();
  }
  function deleteExerciseHard(){
    const ex = exerciseById(state.ui.selectedExerciseId);
    if(!ex){ alert("Нет выбранного упражнения."); return; }
    if(!confirm(`Удалить упражнение "${ex.name}" НАВСЕГДА? Удалятся веса и вся история.`)) return;

    const ws = D().weightVariants.filter(w=>w.exerciseId===ex.id);
    const wIds = new Set(ws.map(w=>w.id));

    D().weightVariants = D().weightVariants.filter(w=>w.exerciseId!==ex.id);
    for(const wo of D().workouts){
      const c = D().cells[wo.id] || {};
      for(const wid of wIds) delete c[wid];
      D().cells[wo.id] = c;
    }
    D().exercises = D().exercises.filter(e=>e.id!==ex.id);

    state.ui.selectedExerciseId = exercisesOfBlock(state.ui.selectedBlockId)[0]?.id || null;
    state.ui.selectedWeightId = null;

    save(); renderAll();
  }

  function addWeight(){
    const ex = exerciseById(state.ui.selectedExerciseId);
    if(!ex){ alert("Сначала выбери упражнение."); return; }
    const val = Number(addWeightVal.value);
    if(!Number.isFinite(val) || val<=0){ alert("Вес должен быть числом > 0."); return; }
    const w = { id: uid(), exerciseId: ex.id, value: val, unit:"кг", hidden:false, lr:false };
    D().weightVariants.push(w);
    state.ui.selectedWeightId = w.id;
    addWeightVal.value = "";
    save(); renderAll();
  }
  function toggleWeightHide(){
    const w = weightById(state.ui.selectedWeightId);
    if(!w){ alert("Нет выбранного веса."); return; }
    w.hidden = !w.hidden;
    save(); renderAll();
  }
  function toggleWeightLR(){
    const w = weightById(state.ui.selectedWeightId);
    if(!w){ alert("Нет выбранного веса."); return; }
    w.lr = !!lrToggle.checked;
    save(); renderAll();
  }

  // IO
  function openExport(){
    ioTitle.textContent = "Экспорт JSON";
    ioTextarea.value = JSON.stringify(D(), null, 2);
    showModal(ioModalBack);
  }
  function openImport(){
    ioTitle.textContent = "Импорт JSON";
    ioTextarea.value = "";
    showModal(ioModalBack);
  }
  function downloadJson(){
    const blob = new Blob([JSON.stringify(D(), null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `gym-matrix-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }
  function applyImport(){
    const txt = ioTextarea.value.trim();
    if(!txt){ alert("Вставь JSON или выбери файл."); return; }
    if(!confirm("Импорт заменит ВСЕ данные. Продолжить?")) return;
    try{
      const obj = JSON.parse(txt);
      state.data = migrateData(obj);
      save();
      state.ui.selectedWorkoutId=null;
      state.ui.selectedBlockId=null;
      state.ui.selectedExerciseId=null;
      state.ui.selectedWeightId=null;
      renderAll();
      hideModal(ioModalBack);
    }catch{
      alert("JSON не распарсился. Проверь формат.");
    }
  }
  function resetAll(){
    if(!confirm("Стереть всё и начать с нуля?")) return;
    state.data = defaultData(false);
    save();
    state.ui.selectedWorkoutId=null;
    state.ui.selectedBlockId=null;
    state.ui.selectedExerciseId=null;
    state.ui.selectedWeightId=null;
    renderAll();
  }

  // Tabs
  function setTab(tab){
    state.ui.activeTab = tab;
    if(tab==="table"){
      tabTable.classList.add("active");
      tabAnalytics.classList.remove("active");
      tableSection.style.display="";
      analyticsSection.classList.remove("show");
    }else{
      tabAnalytics.classList.add("active");
      tabTable.classList.remove("active");
      tableSection.style.display="none";
      analyticsSection.classList.add("show");
      renderAnalytics();
    }
  }

  // Analytics
  function renderAnalyticsSelectors(){
    const blocks = D().blocks.filter(b=>!b.archived);
    anBlock.innerHTML = blocks.map(b=>`<option value="${b.id}">${escapeHtml(b.name)}</option>`).join("");
    if(!anBlock.value || !blocks.some(b=>b.id===anBlock.value)){
      anBlock.value = state.ui.selectedBlockId || blocks[0]?.id || "";
    }
    const exs = exercisesOfBlock(anBlock.value);
    anExercise.innerHTML = exs.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join("");
    if(!anExercise.value || !exs.some(e=>e.id===anExercise.value)){
      anExercise.value = state.ui.selectedExerciseId || exs[0]?.id || "";
    }
    const ws = weightsOfExercise(anExercise.value);
    anWeight.innerHTML = ws.map(w=>`<option value="${w.id}">${escapeHtml(String(w.value))} ${escapeHtml(w.unit)}${w.lr?" L/R":""}</option>`).join("");
    if(!anWeight.value || !ws.some(w=>w.id===anWeight.value)){
      anWeight.value = state.ui.selectedWeightId || ws[0]?.id || "";
    }
    const selW = weightById(anWeight.value);
    if(selW && selW.lr){
      anSide.disabled = false;
    }else{
      anSide.value = "both";
      anSide.disabled = true;
    }
  }

  function filterWorkoutsByPeriod(workouts){
    const p = periodSelect.value;
    if(p==="all") return workouts;
    const now = NOW();
    if(p==="month"){
      const y=now.getFullYear(), m=now.getMonth();
      const start = new Date(y,m,1).getTime();
      const end = new Date(y,m+1,1).getTime();
      return workouts.filter(w=>{ const ts=parseDateToTs(w.date); return ts>=start && ts<end; });
    }
    if(p==="year"){
      const y=now.getFullYear();
      const start = new Date(y,0,1).getTime();
      const end = new Date(y+1,0,1).getTime();
      return workouts.filter(w=>{ const ts=parseDateToTs(w.date); return ts>=start && ts<end; });
    }
    return workouts;
  }

  function drawLineChart(ctx, W, H, labels, seriesA, seriesB, headerNote){
    ctx.clearRect(0,0,W,H);
    const padL=54,padR=16,padT=16,padB=34;
    const innerW=W-padL-padR, innerH=H-padT-padB;
    const maxV = Math.max(1, ...seriesA, ...(seriesB||[]));
    const minV = 0;

    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--border").trim() || "#e6e8ee";
    ctx.lineWidth=1;
    for(let i=0;i<=5;i++){
      const y=padT+(innerH*i/5);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+innerW,y); ctx.stroke();
    }

    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--muted").trim() || "#667085";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    for(let i=0;i<=5;i++){
      const v = Math.round((maxV - (maxV-minV)*i/5)*10)/10;
      const y=padT+(innerH*i/5);
      ctx.fillText(String(v), 10, y+4);
    }

    const n = seriesA.length;
    const step = n<=6 ? 1 : Math.ceil(n/6);
    for(let i=0;i<n;i+=step){
      const x = padL + (n===1 ? innerW/2 : (innerW*i/(n-1)));
      ctx.fillText(labels[i]||"", x-18, padT+innerH+24);
    }

    function draw(vals, color){
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth=2;
      ctx.beginPath();
      for(let i=0;i<n;i++){
        const x = padL + (n===1 ? innerW/2 : (innerW*i/(n-1)));
        const y = padT + innerH - (innerH*(vals[i]-minV)/(maxV-minV));
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
      for(let i=0;i<n;i++){
        const x = padL + (n===1 ? innerW/2 : (innerW*i/(n-1)));
        const y = padT + innerH - (innerH*(vals[i]-minV)/(maxV-minV));
        ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
      }
    }

    const textCol = getComputedStyle(document.body).getPropertyValue("--text").trim() || "#101318";
    const mutedCol = getComputedStyle(document.body).getPropertyValue("--muted").trim() || "#667085";

    if(n){
      draw(seriesA, textCol);
      if(seriesB) draw(seriesB, mutedCol);
    }
    ctx.fillStyle = mutedCol;
    if(headerNote) ctx.fillText(headerNote, padL, padT+12);
  }

  function drawBarChart(ctx, W, H, labels, vals, note){
    ctx.clearRect(0,0,W,H);
    const padL=54,padR=16,padT=16,padB=34;
    const innerW=W-padL-padR, innerH=H-padT-padB;
    const maxV=Math.max(1,...vals);

    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--border").trim() || "#e6e8ee";
    ctx.lineWidth=1;
    for(let i=0;i<=4;i++){
      const y=padT+(innerH*i/4);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+innerW,y); ctx.stroke();
    }
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--muted").trim() || "#667085";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    for(let i=0;i<=4;i++){
      const v=Math.round(maxV - maxV*i/4);
      const y=padT+(innerH*i/4);
      ctx.fillText(String(v), 10, y+4);
    }

    const n=vals.length;
    const barW = n ? Math.max(6, Math.floor(innerW/n)-6) : 10;
    const gold = getComputedStyle(document.body).getPropertyValue("--gold").trim() || "#f6c343";
    ctx.fillStyle = gold;

    for(let i=0;i<n;i++){
      const x = padL + (innerW * i / Math.max(1,n));
      const h = innerH*(vals[i]/maxV);
      const y = padT+innerH-h;
      ctx.fillRect(x+3, y, barW, h);
    }

    const step = n<=6 ? 1 : Math.ceil(n/6);
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue("--muted").trim() || "#667085";
    for(let i=0;i<n;i+=step){
      const x = padL + (innerW * i / Math.max(1,n));
      ctx.fillText(labels[i]||"", x, padT+innerH+24);
    }
    if(note){
      ctx.fillText(note, padL, padT+12);
    }
  }

  function detectStagnation(points, w, side){
    if(!points || points.length < 4) return false;
    let series=[];
    if(w && w.lr){
      if(side==="left") series = points.map(p=>p.lval);
      else if(side==="right") series = points.map(p=>p.rval);
      else series = points.map(p=>Math.max(p.lval,p.rval));
    }else{
      series = points.map(p=>p.val);
    }
    const nonZero = series.filter(v=>v>0);
    if(nonZero.length<4) return false;
    const last = nonZero.slice(-4);
    const maxLast=Math.max(...last);
    const prev=nonZero.slice(0,-4);
    const maxPrev=prev.length ? Math.max(...prev) : 0;
    return maxLast <= maxPrev;
  }

  function countInjuriesOnRecordDays(){
    let injOnRec=0;
    for(const wo of D().workouts){
      let hasRecord=false, hasInjury=false;
      for(const w of D().weightVariants){
        const st = evaluateCellStatus(wo.id, w.id);
        if(st.flags.isRecord) hasRecord=true;
        if(st.flags.injury) hasInjury=true;
      }
      if(hasRecord && hasInjury) injOnRec++;
    }
    return injOnRec;
  }

  function metricLabel(m){ return m==="best" ? "лучший подход" : (m==="avg" ? "среднее" : "сумма"); }

  function renderAnalytics(){
    if(state.ui.activeTab !== "analytics") return;
    computeAll();
    renderAnalyticsSelectors();

    const metric = D().settings.recordMetric;
    const workoutsOldest = [...D().workouts].sort((a,b)=>parseDateToTs(a.date)-parseDateToTs(b.date));
    const woFiltered = filterWorkoutsByPeriod(workoutsOldest);

    const weightId = anWeight.value;
    const w = weightById(weightId);
    const side = anSide.value;

    const points=[];
    for(const wo of woFiltered){
      const cell = getCell(wo.id, weightId);
      let val=0,lval=0,rval=0;
      if(w && w.lr){
        lval = calcMetric(parseSetsToNumbers(cell.leftSets||""), metric);
        rval = calcMetric(parseSetsToNumbers(cell.rightSets||""), metric);
        if(side==="left") val=lval;
        else if(side==="right") val=rval;
        else val=0;
      }else{
        val = calcMetric(parseSetsToNumbers(cell.sets||""), metric);
      }
      points.push({ date: wo.date, ts: parseDateToTs(wo.date), val, lval, rval });
    }

    const ctxT = trendCanvas.getContext("2d");
    const labels = points.map(p=>p.date);
    const showLRBoth = w && w.lr && side==="both";
    const seriesA = points.map(p=> showLRBoth ? p.lval : p.val);
    const seriesB = showLRBoth ? points.map(p=>p.rval) : null;
    drawLineChart(ctxT, trendCanvas.width, trendCanvas.height, labels, seriesA, seriesB, showLRBoth ? "L ярче / R тусклее" : "");

    trendHint.textContent = w ? `Метрика: ${metricLabel(metric)}. Период: ${periodSelect.options[periodSelect.selectedIndex].text}.` : "Выбери упражнение и вес.";

    // records per workout
    const recByWorkout = new Map();
    let totalRecords=0, totalInjuries=0;

    for(const wo of workoutsOldest){
      let c=0;
      for(const wv of D().weightVariants){
        const st = evaluateCellStatus(wo.id, wv.id);
        if(st.flags.isRecord) c++;
        if(st.flags.injury) totalInjuries++;
      }
      recByWorkout.set(wo.id, c);
      totalRecords += c;
    }

    const ctxR = recordsCanvas.getContext("2d");
    const labelsR = workoutsOldest.map(w=>w.date);
    const valsR = workoutsOldest.map(w=>recByWorkout.get(w.id)||0);
    drawBarChart(ctxR, recordsCanvas.width, recordsCanvas.height, labelsR, valsR, "Рекорды по тренировкам");

    // month compare (calendar)
    const now = NOW();
    const recByMonth = new Map();
    for(const wo of workoutsOldest){
      const mk = monthKey(parseDateToTs(wo.date));
      recByMonth.set(mk, (recByMonth.get(mk)||0) + (recByWorkout.get(wo.id)||0));
    }
    const curMonthKey = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
    const prevMonthDate = new Date(now.getFullYear(), now.getMonth()-1, 1);
    const prevMonthKey = `${prevMonthDate.getFullYear()}-${pad2(prevMonthDate.getMonth()+1)}`;
    const curMonth = recByMonth.get(curMonthKey)||0;
    const prevMonth = recByMonth.get(prevMonthKey)||0;
    const diff = curMonth - prevMonth;
    const pct = prevMonth===0 ? (curMonth===0 ? 0 : 100) : Math.round((diff/prevMonth)*100);

    kpiWrap.innerHTML = `<b style="color:var(--gold)">Рекорды:</b> всё: ${totalRecords} • месяц: ${curMonth} • травмы (всё): ${totalInjuries}`;
    recHint.textContent = "Рекорд — по каждому весу отдельно, при L/R — отдельно для L и R.";
    monthCompare.innerHTML = `<b>Этот месяц vs прошлый:</b> ${curMonthKey}: <b>${curMonth}</b>, ${prevMonthKey}: <b>${prevMonth}</b>. Изменение: <b>${diff>=0?"+":""}${diff}</b> (${pct>=0?"+":""}${pct}%).`;

    const injuryOnRecDays = countInjuriesOnRecordDays();
    const injuryShare = totalInjuries ? Math.round((injuryOnRecDays/totalInjuries)*100) : 0;
    const stagn = detectStagnation(points, w, side);

    let recText = "";
    if(totalInjuries && injuryShare >= 50){
      recText += `• <b>${injuryShare}%</b> травм совпадают с днями рекордов — возможно, стоит снизить риск (разминка/шаги/запас).<br/>`;
    }else{
      recText += `• Травмы: следи за контекстом (сон/разминка/усталость).<br/>`;
    }
    if(stagn){
      recText += `• По выбранному тренду прогресс “плоский” последние тренировки — нейтральная идея: <b>делоад</b> или изменение объёма/интенсивности.<br/>`;
    }else{
      recText += `• По выбранному тренду есть движение. Стабильность + техника = скучно и эффективно.<br/>`;
    }
    recommendations.innerHTML = `<b>Рекомендации:</b><br/>${recText}`;
  }

  // Render all
  function renderAll(){
    applyTheme();
    renderSelectors();
    renderTable();
    if(state.ui.activeTab==="analytics") renderAnalytics();
  }

  // Events
  addWorkoutBtn.addEventListener("click", addWorkout);
  delWorkoutBtn.addEventListener("click", deleteSelectedWorkout);

  openDrawerBtn.addEventListener("click", ()=>setDrawer(true));
  closeDrawerBtn.addEventListener("click", ()=>setDrawer(false));
  drawerBack.addEventListener("click", (e)=>{ if(e.target===drawerBack) setDrawer(false); });

  blockSelect.addEventListener("change", ()=>{
    state.ui.selectedBlockId = blockSelect.value;
    state.ui.selectedExerciseId = null;
    state.ui.selectedWeightId = null;
    renderAll();
  });
  exerciseSelect.addEventListener("change", ()=>{
    state.ui.selectedExerciseId = exerciseSelect.value;
    state.ui.selectedWeightId = null;
    renderAll();
  });
  weightSelect.addEventListener("change", ()=>{
    state.ui.selectedWeightId = weightSelect.value;
    renderAll();
  });

  addBlockBtn.addEventListener("click", addBlock);
  renameBlockBtn.addEventListener("click", renameBlock);
  archiveBlockBtn.addEventListener("click", archiveBlock);

  addExerciseBtn.addEventListener("click", addExercise);
  renameExerciseBtn.addEventListener("click", renameExercise);
  delExerciseBtn.addEventListener("click", deleteExerciseHard);

  addWeightBtn.addEventListener("click", addWeight);
  toggleWeightHideBtn.addEventListener("click", toggleWeightHide);
  lrToggle.addEventListener("change", toggleWeightLR);

  themeToggle.addEventListener("change", ()=>{
    D().settings.theme = themeToggle.checked ? "dark" : "light";
    save(); renderAll();
  });

  metricSelect.addEventListener("change", ()=>{
    D().settings.recordMetric = metricSelect.value;
    save(); renderAll();
  });
  showHiddenWeights.addEventListener("change", ()=>{
    D().settings.showHiddenWeights = !!showHiddenWeights.checked;
    save(); renderAll();
  });

  exportBtn.addEventListener("click", ()=>{ ioTitle.textContent="Экспорт JSON"; ioTextarea.value=JSON.stringify(D(),null,2); showModal(ioModalBack); });
  importBtn.addEventListener("click", ()=>{ ioTitle.textContent="Импорт JSON"; ioTextarea.value=""; showModal(ioModalBack); });
  resetDemoBtn.addEventListener("click", resetAll);

  tabTable.addEventListener("click", ()=>setTab("table"));
  tabAnalytics.addEventListener("click", ()=>setTab("analytics"));

  // Modals
  cellModalCloseBtn.addEventListener("click", closeCellEditor);
  saveCellBtn.addEventListener("click", saveCell);
  clearCellBtn.addEventListener("click", clearCell);
  cellModalBack.addEventListener("click", (e)=>{ if(e.target===cellModalBack) closeCellEditor(); });

  statsCloseBtn.addEventListener("click", ()=>hideModal(statsModalBack));
  statsModalBack.addEventListener("click", (e)=>{ if(e.target===statsModalBack) hideModal(statsModalBack); });

  ioCloseBtn.addEventListener("click", ()=>hideModal(ioModalBack));
  ioModalBack.addEventListener("click", (e)=>{ if(e.target===ioModalBack) hideModal(ioModalBack); });
  downloadJsonBtn.addEventListener("click", downloadJson);
  applyImportBtn.addEventListener("click", applyImport);
  importFile.addEventListener("change", async ()=>{
    const f = importFile.files && importFile.files[0];
    if(!f) return;
    ioTextarea.value = await f.text();
  });

  // analytics changes
  [periodSelect, anBlock, anExercise, anWeight, anSide].forEach(el=>{
    el.addEventListener("change", ()=>renderAnalytics());
  });
  anBlock.addEventListener("change", ()=>{ renderAnalyticsSelectors(); renderAnalytics(); });
  anExercise.addEventListener("change", ()=>{ renderAnalyticsSelectors(); renderAnalytics(); });

  // keyboard: Esc closes top-most; Enter saves cell
  document.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){
      if(cellModalBack.classList.contains("show")) closeCellEditor();
      else if(statsModalBack.classList.contains("show")) hideModal(statsModalBack);
      else if(ioModalBack.classList.contains("show")) hideModal(ioModalBack);
      else if(drawerBack.classList.contains("show")) setDrawer(false);
      return;
    }
    if(e.key==="Enter" && cellModalBack.classList.contains("show")){
      e.preventDefault();
      saveCell();
    }
  });

  // Init
  ensureSelections();
  applyTheme();
  renderAll();

})();
</script>
</body>
</html>
