<!doctype html> 
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gym Progress ‚Äî offline</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --card:#f8fafc; --card2:#f1f5f9;
      --accent:#2563eb; --danger:#dc2626;
      --shadow: 0 10px 30px rgba(2,6,23,.08);

      --stickyBg: rgba(255,255,255,.92);

      --gold:#f59e0b;     /* —Ä–µ–∫–æ—Ä–¥ */
      --green:#22c55e;    /* –Ω–æ–≤—ã–π –≤–µ—Å */
      --yellow:#eab308;   /* –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ */
      --grayFill:#f1f5f9; /* –Ω–µ —Ä–µ–∫–æ—Ä–¥ */
      --injuryFill:#ffe4f1; /* —Ç—Ä–∞–≤–º–∞ (—Ä–æ–∑–æ–≤—ã–π) */

      --radius:16px;
      --rowH: 44px;
      --leftW: 132px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#9aa7bd; --line:#1f2a44;
      --card:#0f172a; --card2:#111c33;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --stickyBg: rgba(11,18,32,.88);

      --grayFill:#101a31;
      --injuryFill:#3a1530;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    button,input,select{font:inherit}
    .app{min-height:100%;display:flex;flex-direction:column;}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: var(--stickyBg);
      border-bottom:1px solid var(--line);
      padding: 10px 12px calc(10px + env(safe-area-inset-top));
    }
    .topbar .row{display:flex;align-items:center;gap:10px;}
    .brand{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .brand b{font-weight:800;letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .spacer{flex:1}
    .btn{
      border:1px solid var(--line);
      background: var(--card);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 12px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:transparent;background:var(--accent);color:white;}
    .btn.icon{width:42px;justify-content:center;padding:10px;}
    .seg{
      display:flex;gap:6px;padding:6px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
    }
    .seg button{
      border:0;background:transparent;color:var(--muted);
      padding:8px 10px;border-radius:10px;cursor:pointer;
    }
    .seg button.active{background:var(--card2);color:var(--fg);font-weight:700;}

    .content{flex:1;display:flex;flex-direction:column;min-height:0}
    .view{flex:1;min-height:0;display:none}
    .view.active{display:flex;flex-direction:column;min-height:0}

    .tableWrap{
      flex:1;min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:10px 0;
    }
    table{
      border-collapse: separate;
      border-spacing:0;
      width:max-content;
      min-width:100%;
      position:relative;
    }
    th,td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      height:var(--rowH);
      padding:6px 8px;
      vertical-align:middle;
      background:var(--bg);
      white-space:nowrap;
    }

    thead{
      position:sticky;
      top:0;
      z-index:15;
      background:var(--stickyBg);
      backdrop-filter: blur(10px);
    }
    thead tr{background:var(--stickyBg);}
    thead th{
      position:sticky;
      top:0;
      z-index:16;
      background:var(--stickyBg);
      backdrop-filter: blur(10px);
      font-weight:800;
    }

    th:first-child, td:first-child{border-left:1px solid var(--line);}
    tr:first-child th{border-top:1px solid var(--line);}

    .stickyLeft{
      position:sticky;left:0;z-index:8;
      background:var(--stickyBg);
      backdrop-filter: blur(10px);
      width:var(--leftW);
      min-width:var(--leftW);
      max-width:var(--leftW);
      border-right:1px solid var(--line);
    }
    th.stickyLeft{z-index:18}
    .corner{z-index:25 !important;}

    .leftCell{display:flex;align-items:center;gap:8px;min-width:0;}
    .leftText{min-width:0;overflow:hidden;text-overflow:ellipsis;}
    .blockRow .leftText{text-transform:uppercase;font-weight:900;letter-spacing:.8px;}
    .exRow .leftText{font-weight:800;text-transform:lowercase;padding-left:10px;}
    .wRow .leftText{font-weight:500;text-transform:lowercase;padding-left:22px;color:var(--muted);}
    .wRow .sideTag{
      font-size:11px;padding:2px 6px;border-radius:999px;
      border:1px solid var(--line);color:var(--muted);
      background:var(--card);flex:0 0 auto;
    }

    .exRow td{height:auto;white-space:normal;}
    .exRow .stickyLeft{white-space:normal;}
    .exRow .leftText{
      white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word;
    }

    .wRow td{height:auto;white-space:normal;}
    .wRow .stickyLeft{white-space:normal;}
    .wRow .leftText{
      white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word;
    }

    .tinyIcon{
      border:0;background:transparent;color:var(--muted);
      padding:6px;margin:-6px;cursor:pointer;
    }
    .tinyIcon:active{transform: translateY(1px)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);background:var(--card);
      color:var(--muted);font-size:12px;
    }

    td.cell{
      position:relative;
      cursor:pointer;
      background:var(--bg);
      min-width:96px;
      max-width:120px;
    }
    td.cell .val{
      font-weight:800;
      font-size:13px;
      line-height:1.1;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    td.cell .sub{
      font-size:11px;color:var(--muted);
      margin-top:2px;
      overflow:hidden;text-overflow:ellipsis;
    }

    td.cell.empty .val{color:var(--muted);font-weight:400}
    td.cell:not(.empty) .sub{color:var(--fg);font-weight:800}

    td.cell.empty .sub{display:none}

    td.cell.gray{background:var(--grayFill);}
    td.cell.injury{background:var(--injuryFill);}
    td.cell.border-gold{box-shadow: inset 0 0 0 2px var(--gold);}
    td.cell.border-green{box-shadow: inset 0 0 0 2px var(--green);}
    td.cell.border-yellow{box-shadow: inset 0 0 0 2px var(--yellow);}

    .dateHead{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .dateHead .d{font-weight:900}
    .dateHead .trash{
      border:0;background:transparent;color:var(--muted);
      cursor:pointer;padding:6px;margin:-6px;border-radius:10px;
    }
    .dateHead .trash:active{transform: translateY(1px)}

    .hintRow{
      padding:0 12px 12px;
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      color:var(--muted);
    }

    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;z-index:100;}
    .overlay.show{display:block}
    .drawer{
      position:fixed;top:0;right:0;bottom:0;
      width:min(92vw,420px);
      background:var(--bg);
      border-left:1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:110;
      display:flex;flex-direction:column;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .drawer.show{transform: translateX(0)}
    .drawer header{
      display:flex;align-items:center;gap:10px;
      padding:6px 2px 10px;border-bottom:1px solid var(--line);
    }
    .drawer header b{font-size:16px}
    .drawer .body{flex:1;overflow:auto;padding-top:10px}
    .section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      margin-bottom:10px;
    }
    .section h3{
      margin:0 0 8px 0;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.8px;
      color:var(--muted);
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    .field label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="number"], select{
      border:1px solid var(--line);
      background:var(--bg);
      color:var(--fg);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    .rowActions{display:flex;gap:8px;flex-wrap:wrap}
    .danger{border-color:rgba(220,38,38,.35);color:var(--danger);background:transparent}

    .modalOverlay{
      position:fixed;inset:0;background:rgba(2,6,23,.38);
      display:none;z-index:200;padding:12px;
    }
    .modalOverlay.show{display:flex;align-items:center;justify-content:center}
    .modal{
      width:min(96vw,520px);
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      padding:12px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:var(--card);
    }
    .modal header b{font-size:14px}
    .modal main{padding:12px}
    .modal footer{
      padding:12px;border-top:1px solid var(--line);
      display:flex;gap:8px;justify-content:flex-end;
      background:var(--card);
    }
    .sets{display:flex;flex-direction:column;gap:8px;margin:8px 0 10px;}
    .setRow{display:flex;gap:8px;align-items:center;}
    .setRow input{flex:1}
    .setRow button{width:42px;}
    .toggleLine{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border:1px solid var(--line);
      border-radius:14px;background:var(--card);
      margin-top:8px;
    }
    .toggleLine .left{display:flex;align-items:center;gap:10px}
    .badge{
      font-size:12px;padding:4px 8px;border-radius:9999px;
      border:1px solid var(--line);background:var(--bg);color:var(--muted);
    }

    .analyticsWrap{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0;}
    .panel{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);padding:10px;}
    .panel h3{margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);}
    canvas{width:100%;height:180px;background:var(--bg);border:1px solid var(--line);border-radius:14px;display:block;}
    .insights{display:flex;flex-direction:column;gap:8px;color:var(--fg);}
    .insights .muted{color:var(--muted);font-size:12px}
    .kpiRow{display:flex;gap:8px;flex-wrap:wrap}
    .kpi{
      flex:1;min-width:130px;border:1px solid var(--line);
      border-radius:14px;background:var(--bg);padding:10px;
    }
    .kpi b{display:block;font-size:16px}
    .kpi small{color:var(--muted)}
    .legendLine{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:3px;border:2px solid transparent;display:inline-block}
    .dot.gold{border-color:var(--gold)}
    .dot.green{border-color:var(--green)}
    .dot.yellow{border-color:var(--yellow)}
    .dot.gray{background:var(--grayFill);border-color:var(--line)}
    .dot.pink{background:var(--injuryFill);border-color:var(--line)}

    @media (max-width: 380px){
      :root{ --leftW: 120px; --rowH: 42px; }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="row">
      <button class="btn icon" id="btnMenu" aria-label="–ú–µ–Ω—é">‚ò∞</button>
      <div class="brand">
        <b>Gym Progress</b>
        <small id="subTitle">offline ‚Ä¢ —Ç–∞–±–ª–∏—Ü–∞</small>
      </div>
      <div class="spacer"></div>
      <div class="seg" role="tablist" aria-label="–≠–∫—Ä–∞–Ω—ã">
        <button id="tabTable" class="active" role="tab" aria-selected="true">–¢–∞–±–ª–∏—Ü–∞</button>
        <button id="tabAnalytics" role="tab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>
      <button class="btn primary" id="btnAddWorkout">+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
      <button class="btn icon" id="btnHelp" aria-label="–õ–µ–≥–µ–Ω–¥–∞">?</button>
    </div>
  </div>

  <div class="content">
    <div class="hintRow" id="hintRow">
      <span class="pill">–¢–∞–ø –ø–æ —è—á–µ–π–∫–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
      <span class="pill">Long-press –ø–æ –¥–∞—Ç–µ (~0.7s) ‚Üí —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </div>

    <section class="view active" id="viewTable" aria-label="–¢–∞–±–ª–∏—Ü–∞">
      <div class="tableWrap" id="tableWrap"></div>
    </section>

    <section class="view" id="viewAnalytics" aria-label="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞">
      <div class="analyticsWrap">
        <div class="panel">
          <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
          <div class="grid2">
            <div class="field">
              <label>–ë–ª–æ–∫</label>
              <select id="anBlock"></select>
            </div>
            <div class="field">
              <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
              <select id="anExercise"></select>
            </div>
          </div>
          <div class="field" style="margin-bottom:0">
            <label>–ú–µ—Ç—Ä–∏–∫–∞</label>
            <select id="anMetric">
              <option value="volume">–û–±—ä—ë–º (sets √ó reps √ó weight)</option>
              <option value="reps">–ü–æ–≤—Ç–æ—Ä—ã (—Å—É–º–º–∞ reps)</option>
              <option value="records">–†–µ–∫–æ—Ä–¥—ã (–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)</option>
              <option value="injuries">–¢—Ä–∞–≤–º—ã (–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)</option>
            </select>
          </div>
        </div>

        <div class="panel">
          <h3>–ì—Ä–∞—Ñ–∏–∫</h3>
          <canvas id="chart" width="800" height="360"></canvas>
          <div class="legendLine" style="margin-top:8px; color:var(--muted); font-size:12px">
            <span>–ü—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫. –ú–∞—Å—à—Ç–∞–± –∞–≤—Ç–æ.</span>
          </div>
        </div>

        <div class="panel">
          <h3>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
          <div class="kpiRow" id="kpiRow"></div>
          <div class="insights" id="insights" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer" aria-label="–ú–µ–Ω—é">
  <header>
    <b>–ú–µ–Ω—é</b>
    <div class="spacer"></div>
    <button class="btn icon" id="btnCloseDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
  </header>

  <div class="body">
    <div class="section">
      <h3>–¢–µ–º–∞</h3>
      <div class="toggleLine">
        <div class="left">
          <span class="badge">üåô</span>
          <div>
            <b style="display:block">–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</b>
            <small style="color:var(--muted)">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</small>
          </div>
        </div>
        <button class="btn" id="btnTheme">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>

    <div class="section">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
      <div class="field">
        <label>–ë–ª–æ–∫</label>
        <select id="selBlockAddEx"></select>
      </div>
      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ö–æ—á–µ—à—å)</label>
        <input id="inExName" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∂–∏–º –ª—ë–∂–∞" />
      </div>
      <div class="rowActions">
        <button class="btn primary" id="btnAddExercise">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="section">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</h3>
      <div class="field">
        <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
        <select id="selExAddWeight"></select>
      </div>
      <div class="field">
        <label>–í–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 40 –∏–ª–∏ 60-50)</label>
        <input id="inWeightLabel" type="text" placeholder="40" />
      </div>
      <div class="rowActions">
        <button class="btn primary" id="btnAddWeight">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</button>
      </div>
    </div>

    <div class="section">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
      <div class="field">
        <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
        <select id="selManageExercise"></select>
      </div>

      <div class="toggleLine" style="margin-top:0">
        <div class="left">
          <span class="badge">L/R</span>
          <div>
            <b style="display:block">Split L/R</b>
            <small style="color:var(--muted)">–†–∞–∑–¥–µ–ª—å–Ω—ã–π –≤–≤–æ–¥</small>
          </div>
        </div>
        <button class="btn" id="btnToggleSplit">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">üóÑÔ∏è</span>
          <div>
            <b style="display:block">–ê—Ä—Ö–∏–≤</b>
            <small style="color:var(--muted)">–°–∫—Ä—ã—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ (–Ω–µ —É–¥–∞–ª—è—Ç—å)</small>
          </div>
        </div>
        <button class="btn" id="btnToggleArchive">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div style="margin-top:10px">
        <div style="font-size:12px; color:var(--muted); margin-bottom:6px">–í–µ—Å–∞ (–ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç—å)</div>
        <div id="weightsList"></div>
      </div>

      <div style="margin-top:12px" class="rowActions">
        <button class="btn danger" id="btnDeleteExercise">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞‚Ä¶</button>
      </div>
    </div>

    <div class="section">
      <h3>–î–∞–Ω–Ω—ã–µ</h3>
      <div class="rowActions">
        <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON</button>
        <button class="btn danger" id="btnReset">–°–±—Ä–æ—Å (seed)</button>
      </div>
    </div>
  </div>
</aside>

<div class="modalOverlay" id="cellModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–†–µ–¥–∞–∫—Ç–æ—Ä">
    <header>
      <div>
        <b id="cellTitle">–Ø—á–µ–π–∫–∞</b><br/>
        <small id="cellSubtitle" style="color:var(--muted)"></small>
      </div>
      <button class="btn icon" id="btnCloseCellModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>
    <main>
      <div class="sets" id="setsWrap"></div>
      <div class="rowActions">
        <button class="btn" id="btnAddSet">+ —Å–µ—Ç</button>
        <button class="btn" id="btnClearSets">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">‚≠ê</span>
          <div>
            <b style="display:block">–ü–ª–∞–Ω (–∑–≤–µ–∑–¥–∞)</b>
            <small style="color:var(--muted)">–ü–æ–º–µ—Ç–∫–∞ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</small>
          </div>
        </div>
        <button class="btn" id="btnTogglePlanned">–í—ã–∫–ª</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">ü©π</span>
          <div>
            <b style="display:block">–¢—Ä–∞–≤–º–∞</b>
            <small style="color:var(--muted)">–†–æ–∑–æ–≤—ã–π —Ñ–æ–Ω</small>
          </div>
        </div>
        <button class="btn" id="btnToggleInjury">–í—ã–∫–ª</button>
      </div>
    </main>
    <footer>
      <button class="btn" id="btnCancelCell">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveCell">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </footer>
  </div>
</div>

<div class="modalOverlay" id="infoModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–ò–Ω—Ñ–æ">
    <header>
      <b id="infoTitle">–ò–Ω—Ñ–æ</b>
      <button class="btn icon" id="btnCloseInfoModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>
    <main id="infoBody"></main>
    <footer>
      <button class="btn primary" id="btnCloseInfoModal2">–û–∫</button>
    </footer>
  </div>
</div>

<script>
const LS_KEY = "gymProgress.v1";
const DEFAULT_BLOCKS = ["–ì–†–£–î–¨","–ë–ò–¶–ï–ü–°","–°–ü–ò–ù–ê","–î–ï–õ–¨–¢–´","–ù–û–ì–ò"];

const STATUS = {
  RECORD: "record",
  NEW_WEIGHT: "new_weight",
  NEW_EX: "new_ex",
  NOT_RECORD: "not_record",
};

const nowId = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

const clampInt = (v) => {
  const n = parseInt(String(v||"").trim(), 10);
  return Number.isFinite(n) && n>=0 ? n : null;
};

function parseDDMMYYYY(s){
  if(!s) return null;
  const m = String(s).trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yyyy = +m[3];
  const d = new Date(yyyy, mm-1, dd);
  if(d.getFullYear()!==yyyy || (d.getMonth()+1)!==mm || d.getDate()!==dd) return null;
  return d;
}
function fmtDate(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function sortWorkoutsAsc(workouts){
  return [...workouts].sort((a,b)=>{
    const da = parseDDMMYYYY(a.date), db = parseDDMMYYYY(b.date);
    const ta = da?da.getTime():0, tb = db?db.getTime():0;
    return ta-tb;
  });
}

function weightMaxNumber(label){
  const s = String(label||"").trim();
  const nums = s.match(/(\d+(?:[.,]\d+)?)/g);
  if(!nums) return Number.POSITIVE_INFINITY;
  let max = -Infinity;
  for(const t of nums){
    const n = parseFloat(t.replace(",","."));
    if(Number.isFinite(n)) max = Math.max(max,n);
  }
  return Number.isFinite(max) ? max : Number.POSITIVE_INFINITY;
}

function weightStepsFromLabel(weightLabel){
  const s = String(weightLabel||"").trim();
  if(!s.includes("-")) return 1;
  const parts = s.split("-").map(x=>x.trim()).filter(Boolean);
  return parts.length >= 2 ? parts.length : 1;
}

function parseRepsValue(raw, steps){
  const s = String(raw ?? "").trim();
  if(!s) return null;
  if(steps<=1) return clampInt(s);
  const parts = s.split("-").map(x=>x.trim()).filter(x=>x.length>0);
  if(parts.length !== steps) return null;
  const nums = parts.map(clampInt);
  if(nums.some(n=>n==null)) return null;
  return nums.join("-");
}

function repsMeta(val, steps){
  if(steps<=1){
    const n = (typeof val === "number") ? val : clampInt(val);
    if(n==null) return null;
    return {parts:[n], prefixKey:"", last:n, str:String(n)};
  }
  if(typeof val !== "string") return null;
  const parts = val.split("-").map(x=>clampInt(x.trim()));
  if(parts.length !== steps || parts.some(n=>n==null)) return null;
  const last = parts[parts.length-1];
  const prefixKey = parts.slice(0,-1).join("-");
  return {parts, prefixKey, last, str: parts.join("-")};
}

function seedState(){
  const mkW = (label) => ({id: nowId(), label, hidden:false});
  const mkE = (name, weights, splitLR=false) => ({
    id: nowId(), name, archived:false, splitLR,
    weights: weights.map(mkW)
  });
  const mkB = (name, exs) => ({id: nowId(), name, collapsed:false, exercises: exs});

  const w1 = {id: nowId(), date:"02.01.2026"};
  const w2 = {id: nowId(), date:"05.01.2026"};

  const chest = mkB("–ì–†–£–î–¨", [mkE("–∂–∏–º –ª—ë–∂–∞", ["40","50","60-50"])]);
  const biceps = mkB("–ë–ò–¶–ï–ü–°", [mkE("–ø–æ–¥—ä—ë–º –Ω–∞ –±–∏—Ü–µ–ø—Å", ["10"], true)]);
  
  const state = {
    theme: "light",
    blocks: [chest, biceps],
    workouts: [w1, w2],
    entries: {}
  };

  state.workouts = sortWorkoutsAsc(state.workouts);
  return state;
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return seedState();
    const st = JSON.parse(raw);
    st.workouts = sortWorkoutsAsc(st.workouts || []);
    return st;
  }catch(e){ return seedState(); }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

let state = loadState();

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const tableWrap = $("#tableWrap");
const subTitle = $("#subTitle");
const viewTable = $("#viewTable");
const viewAnalytics = $("#viewAnalytics");
const tabTable = $("#tabTable");
const tabAnalytics = $("#tabAnalytics");
const overlay = $("#overlay");
const drawer = $("#drawer");
const cellModalOverlay = $("#cellModalOverlay");
const infoModalOverlay = $("#infoModalOverlay");

function setTab(name){
  const isTable = name==="table";
  viewTable.classList.toggle("active", isTable);
  viewAnalytics.classList.toggle("active", !isTable);
  tabTable.classList.toggle("active", isTable);
  tabAnalytics.classList.toggle("active", !isTable);
  if(!isTable) renderAnalytics();
}
tabTable.addEventListener("click", ()=>setTab("table"));
tabAnalytics.addEventListener("click", ()=>setTab("analytics"));

function applyTheme(){ document.documentElement.dataset.theme = state.theme; }
applyTheme();

function openDrawer(){ overlay.classList.add("show"); drawer.classList.add("show"); refreshMenuSelects(); }
function closeDrawer(){ overlay.classList.remove("show"); drawer.classList.remove("show"); }
$("#btnMenu").addEventListener("click", openDrawer);
$("#btnCloseDrawer").addEventListener("click", closeDrawer);
overlay.addEventListener("click", closeDrawer);

function renderAll(){
  const workouts = state.workouts;
  if(!workouts.length){
    tableWrap.innerHTML = `<div style="padding:40px;text-align:center;color:var(--muted)">–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ù–∞–∂–º–∏ "+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞"</div>`;
    return;
  }

  let html = `<table><thead><tr><th class="stickyLeft corner">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</th>`;
  workouts.forEach(w => {
    html += `<th><div class="dateHead"><span class="d">${w.date.split('.').slice(0,2).join('.')}</span>
            <button class="trash" onclick="deleteWorkout('${w.id}')">‚úï</button></div></th>`;
  });
  html += `</tr></thead><tbody>`;

  state.blocks.forEach(block => {
    html += `<tr class="blockRow"><td class="stickyLeft" colspan="${workouts.length+1}">
            <div class="leftCell"><span class="leftText">${block.name}</span></div></td></tr>`;
    
    block.exercises.filter(ex => !ex.archived).forEach(ex => {
      html += `<tr class="exRow"><td class="stickyLeft"><div class="leftCell"><span class="leftText">${ex.name}</span></div></td>
              <td colspan="${workouts.length}"></td></tr>`;
      
      ex.weights.filter(w => !w.hidden).forEach(wObj => {
        html += `<tr class="wRow"><td class="stickyLeft"><div class="leftCell"><span class="leftText">${wObj.label}</span>
                <span class="sideTag">${ex.splitLR?'L/R':'set'}</span></div></td>`;
        
        workouts.forEach((w, wIdx) => {
          const entry = state.entries[w.id]?.[ex.id]?.[wObj.id];
          const isLastWorkout = (wIdx === workouts.length - 1);
          const cellData = getCellDisplay(entry, ex, wObj, w.id, isLastWorkout);
          
          html += `<td class="cell ${cellData.classes}" onclick="openCellModal('${w.id}','${ex.id}','${wObj.id}')">
                  <div class="val">${cellData.val}</div><div class="sub">${cellData.sub}</div></td>`;
        });
        html += `</tr>`;
      });
    });
  });

  html += `</tbody></table>`;
  tableWrap.innerHTML = html;
}

function getCellDisplay(entry, ex, wObj, workoutId, isLastWorkout){
  let classes = "";
  let val = "";
  let sub = "";
  
  const hasData = entry && (ex.splitLR ? (entry.L?.sets.length || entry.R?.sets.length) : entry.sets?.length);

  if(!hasData){
    classes = "empty";
    // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ "–ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è"
    if(entry?.planned) {
      val += ` ‚≠ê`;
    }
    
    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É "–Ω–∞–¥–æ X"
    const target = getTargetReps(workoutId, ex.id, wObj.id);
    if(target && isLastWorkout){
      val = `–Ω–∞–¥–æ ${target}` + val;
    } else if (val === " ‚≠ê") {
      val = "–ü–ª–∞–Ω ‚≠ê";
    }
  } else {
    const status = getEntryStatus(workoutId, ex.id, wObj.id);
    if(status === STATUS.RECORD) classes += " border-gold";
    else if(status === STATUS.NEW_WEIGHT) classes += " border-green";
    else if(status === STATUS.NEW_EX) classes += " border-yellow";
    else if(status === STATUS.NOT_RECORD) classes += " gray";

    const isInjury = ex.splitLR ? (entry.L?.injury || entry.R?.injury) : entry.injury;
    if(isInjury) classes += " injury";

    if(ex.splitLR){
      const lReps = entry.L?.sets.join('-') || "";
      const rReps = entry.R?.sets.join('-') || "";
      sub = lReps || rReps ? `L:${lReps || '‚Äî'} R:${rReps || '‚Äî'}` : "";
      val = lReps || rReps ? "–í–µ—Å" : "";
    } else {
      val = entry.sets.join('-');
      sub = "–ø–æ–≤—Ç–æ—Ä—ã";
    }
  }
  return { classes, val, sub };
}

function getTargetReps(workoutId, exId, weightId){
  const workouts = state.workouts;
  const idx = workouts.findIndex(w => w.id === workoutId);
  if(idx <= 0) return null;
  
  for(let i = idx-1; i >= 0; i--){
    const e = state.entries[workouts[i].id]?.[exId]?.[weightId];
    if(e){
      const ex = state.blocks.flatMap(b=>b.exercises).find(x=>x.id===exId);
      if(ex.splitLR){
        const lMax = e.L?.sets.length ? Math.max(...e.L.sets) : 0;
        const rMax = e.R?.sets.length ? Math.max(...e.R.sets) : 0;
        return lMax || rMax ? Math.max(lMax, rMax) : null;
      } else {
        return e.sets?.length ? Math.max(...e.sets) : null;
      }
    }
  }
  return null;
}

function getEntryStatus(workoutId, exId, weightId){
  const workouts = state.workouts;
  const idx = workouts.findIndex(w => w.id === workoutId);
  const entry = state.entries[workoutId]?.[exId]?.[weightId];
  if(!entry) return null;

  const ex = state.blocks.flatMap(b=>b.exercises).find(e=>e.id===exId);
  const getVol = (ent) => {
    if(!ent) return 0;
    if(ex.splitLR){
      const l = (ent.L?.sets || []).reduce((a,b)=>a+b,0);
      const r = (ent.R?.sets || []).reduce((a,b)=>a+b,0);
      return l + r;
    }
    return (ent.sets || []).reduce((a,b)=>a+b,0);
  };

  const currentVol = getVol(entry);
  if(currentVol === 0) return null;

  let hasHistoryForWeight = false;
  let hasHistoryForEx = false;
  let maxPrevVol = 0;

  for(let i=0; i<idx; i++){
    const prevWorkoutEntries = state.entries[workouts[i].id];
    if(!prevWorkoutEntries) continue;
    
    if(prevWorkoutEntries[exId]){
      hasHistoryForEx = true;
      const prevEntry = prevWorkoutEntries[exId][weightId];
      if(prevEntry){
        hasHistoryForWeight = true;
        maxPrevVol = Math.max(maxPrevVol, getVol(prevEntry));
      }
    }
  }

  if(!hasHistoryForEx) return STATUS.NEW_EX;
  if(!hasHistoryForWeight) return STATUS.NEW_WEIGHT;
  return currentVol > maxPrevVol ? STATUS.RECORD : STATUS.NOT_RECORD;
}

let activeCell = null;
function openCellModal(wId, exId, weightId){
  activeCell = { wId, exId, weightId };
  const workout = state.workouts.find(w=>w.id===wId);
  const ex = state.blocks.flatMap(b=>b.exercises).find(e=>e.id===exId);
  const wObj = ex.weights.find(w=>w.id===weightId);
  const entry = state.entries[wId]?.[exId]?.[weightId] || {};

  $("#cellTitle").textContent = ex.name;
  $("#cellSubtitle").textContent = `${workout.date} ‚Ä¢ –í–µ—Å: ${wObj.label}`;
  
  const setsWrap = $("#setsWrap");
  setsWrap.innerHTML = "";

  const renderSide = (sideKey, label) => {
    const data = ex.splitLR ? (entry[sideKey] || {sets:[], injury:false}) : entry;
    const sideDiv = document.createElement("div");
    sideDiv.innerHTML = `<h4 style="margin:10px 0 5px">${label}</h4>`;
    const container = document.createElement("div");
    container.className = "sets-container";
    
    const sets = data.sets || [];
    sets.forEach((s, i) => {
      const row = document.createElement("div");
      row.className = "setRow";
      row.innerHTML = `<input type="number" value="${s}" placeholder="–ü–æ–≤—Ç–æ—Ä—ã"><button class="btn" onclick="this.parentElement.remove()">‚úï</button>`;
      container.appendChild(row);
    });
    sideDiv.appendChild(container);
    
    const btn = document.createElement("button");
    btn.className = "btn"; btn.textContent = "+ —Å–µ—Ç";
    btn.onclick = () => {
      const row = document.createElement("div");
      row.className = "setRow";
      row.innerHTML = `<input type="number" placeholder="–ü–æ–≤—Ç–æ—Ä—ã"><button class="btn" onclick="this.parentElement.remove()">‚úï</button>`;
      container.appendChild(row);
    };
    sideDiv.appendChild(btn);
    setsWrap.appendChild(sideDiv);
  };

  if(ex.splitLR){
    renderSide("L", "–õ–µ–≤–∞—è (L)");
    renderSide("R", "–ü—Ä–∞–≤–∞—è (R)");
  } else {
    renderSide(null, "–°–µ—Ç—ã");
  }

  const planned = !!entry.planned;
  $("#btnTogglePlanned").textContent = planned ? "–í–∫–ª" : "–í—ã–∫–ª";
  $("#btnTogglePlanned").onclick = () => {
    const isNow = $("#btnTogglePlanned").textContent === "–í–∫–ª";
    $("#btnTogglePlanned").textContent = isNow ? "–í—ã–∫–ª" : "–í–∫–ª";
  };

  const isInjury = ex.splitLR ? (entry.L?.injury || entry.R?.injury) : entry.injury;
  $("#btnToggleInjury").textContent = isInjury ? "–í–∫–ª" : "–í—ã–∫–ª";
  $("#btnToggleInjury").onclick = () => {
    const isNow = $("#btnToggleInjury").textContent === "–í–∫–ª";
    $("#btnToggleInjury").textContent = isNow ? "–í—ã–∫–ª" : "–í–∫–ª";
  };

  cellModalOverlay.classList.add("show");
}

$("#btnSaveCell").onclick = () => {
  const { wId, exId, weightId } = activeCell;
  const ex = state.blocks.flatMap(b=>b.exercises).find(e=>e.id===exId);
  const entry = state.entries[wId]?.[exId]?.[weightId] || {};
  
  const isInjury = $("#btnToggleInjury").textContent === "–í–∫–ª";
  const isPlanned = $("#btnTogglePlanned").textContent === "–í–∫–ª";

  if(ex.splitLR){
    const containers = $$(".sets-container");
    const getSets = (c) => $$( "input", c).map(i => clampInt(i.value)).filter(v=>v!==null);
    entry.L = { sets: getSets(containers[0]), injury: isInjury };
    entry.R = { sets: getSets(containers[1]), injury: isInjury };
  } else {
    const container = $(".sets-container");
    entry.sets = $$( "input", container).map(i => clampInt(i.value)).filter(v=>v!==null);
    entry.injury = isInjury;
  }
  
  entry.planned = isPlanned;

  if(!state.entries[wId]) state.entries[wId] = {};
  if(!state.entries[wId][exId]) state.entries[wId][exId] = {};
  state.entries[wId][exId][weightId] = entry;

  saveState();
  renderAll();
  closeCellModal();
};

function closeCellModal(){ cellModalOverlay.classList.remove("show"); }
$("#btnCloseCellModal").onclick = closeCellModal;
$("#btnCancelCell").onclick = closeCellModal;

$("#btnAddWorkout").onclick = () => {
  const dateStr = prompt("–î–∞—Ç–∞ (–î–î.–ú–ú.–ì–ì–ì–ì):", fmtDate(new Date()));
  if(!dateStr || !parseDDMMYYYY(dateStr)) return;
  state.workouts.push({ id: nowId(), date: dateStr });
  state.workouts = sortWorkoutsAsc(state.workouts);
  saveState();
  renderAll();
};

function deleteWorkout(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?")) return;
  state.workouts = state.workouts.filter(w => w.id !== id);
  delete state.entries[id];
  saveState();
  renderAll();
}

function refreshMenuSelects(){
  const bSel = $("#selBlockAddEx");
  bSel.innerHTML = state.blocks.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
  
  const eSel1 = $("#selExAddWeight");
  const eSel2 = $("#selManageExercise");
  const exs = state.blocks.flatMap(b=>b.exercises);
  const opts = exs.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
  eSel1.innerHTML = opts; eSel2.innerHTML = opts;
}

$("#btnAddExercise").onclick = () => {
  const bId = $("#selBlockAddEx").value;
  const name = $("#inExName").value.trim();
  if(!name) return;
  const block = state.blocks.find(b=>b.id===bId);
  block.exercises.push({ id: nowId(), name, weights: [], archived: false, splitLR: false });
  $("#inExName").value = "";
  saveState();
  closeDrawer();
  renderAll();
};

$("#btnAddWeight").onclick = () => {
  const eId = $("#selExAddWeight").value;
  const label = $("#inWeightLabel").value.trim();
  if(!label) return;
  const ex = state.blocks.flatMap(b=>b.exercises).find(e=>e.id===eId);
  ex.weights.push({ id: nowId(), label, hidden: false });
  ex.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
  $("#inWeightLabel").value = "";
  saveState();
  closeDrawer();
  renderAll();
};

$("#btnReset").onclick = () => {
  if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë?")) { state = seedState(); saveState(); location.reload(); }
};

renderAll();
</script>
</body>
</html>
