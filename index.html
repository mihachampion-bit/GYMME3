<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gym Progress Tracker (Offline)</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --card:#f8fafc;
      --border:#e5e7eb;
      --accent:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#ca8a04;
      --gold:#b45309;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius: 14px;
      --tap: 44px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    [data-theme="dark"]{
      --bg:#0b1020;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --card:#111a33;
      --border:#253055;
      --accent:#60a5fa;
      --danger:#fb7185;
      --ok:#34d399;
      --warn:#fbbf24;
      --gold:#f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--fg);
      overflow:hidden;
    }

    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      height:100%;
    }
    @media (max-width: 960px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; height:auto; min-height:100%; }
    }

    .header{
      position:sticky;
      top:0;
      z-index:20;
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
      padding: 10px max(12px, env(safe-area-inset-left)) 10px max(12px, env(safe-area-inset-right));
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand{
      display:flex; flex-direction:column;
      min-width: 160px;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: .3px;
      font-size: 14px;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-left:auto;
      align-items:center;
      justify-content:flex-end;
    }

    button, input, select, textarea{ font: inherit; color: inherit; }
    .btn{
      height: var(--tap);
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ border-color: color-mix(in srgb, var(--border) 60%, var(--accent)); }
    .btn.primary{
      background: color-mix(in srgb, var(--accent) 14%, var(--card));
      border-color: color-mix(in srgb, var(--accent) 40%, var(--border));
    }
    .btn.danger{
      background: color-mix(in srgb, var(--danger) 12%, var(--card));
      border-color: color-mix(in srgb, var(--danger) 35%, var(--border));
    }
    .btn.ghost{ background: transparent; }
    .icon{ width:18px; height:18px; display:inline-block; }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      height: 34px;
    }

    .input, .select{
      height: var(--tap);
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--card);
      padding: 0 12px;
      min-width: 160px;
      outline:none;
    }
    .input:focus, .select:focus, textarea:focus{
      border-color: color-mix(in srgb, var(--accent) 65%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 15%, transparent);
    }
    textarea{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--card);
      padding: 10px 12px;
      outline:none;
      min-height: 90px;
      resize: vertical;
    }

    .sidebar{
      border-right:1px solid var(--border);
      background: var(--bg);
      height:100%;
      overflow:auto;
    }
    @media (max-width: 960px){
      .sidebar{ border-right:none; border-bottom:1px solid var(--border); }
    }
    .main{
      height:100%;
      overflow:auto;
      background: var(--bg);
    }

    .section{
      padding: 14px;
      border-bottom:1px solid var(--border);
    }
    .section h3{
      margin: 0 0 10px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .spacer{ flex: 1; }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .tree{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .treeItem{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 10px;
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .treeItem .meta{ flex:1; min-width: 0; }
    .treeItem .name{
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing:.02em;
      font-size: 13px;
      line-height: 1.2;
    }
    .treeItem.archived{ opacity: .65; }
    .treeItem .small{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--border);
      background: transparent;
      border-radius:999px;
      padding: 3px 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .miniBtns{ display:flex; gap:6px; flex-wrap:wrap; }
    .miniBtn{
      height: 34px;
      padding:0 10px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: transparent;
      cursor:pointer;
    }
    .miniBtn:hover{ border-color: color-mix(in srgb, var(--border) 60%, var(--accent)); }

    .tableWrap{ padding: 14px; }
    .tableCard{
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--bg);
    }
    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    table{
      border-collapse: separate;
      border-spacing: 0;
      width: max(900px, 100%);
      font-size: 13px;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
      padding: 10px;
      text-align:left;
      white-space:nowrap;
      min-width: 150px;
    }
    thead th:first-child{
      left:0;
      z-index: 6;
      position: sticky;
      min-width: 340px;
    }
    tbody td, tbody th{
      border-bottom:1px solid var(--border);
      padding: 8px 10px;
      vertical-align: top;
      background: var(--bg);
    }
    tbody th{
      position: sticky;
      left:0;
      z-index: 4;
      background: var(--bg);
      min-width: 340px;
      max-width: 380px;
    }

    .rowBlock{
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.02em;
    }
    .rowExercise{
      padding-left: 16px;
      font-weight: 800;
      text-transform: lowercase;
    }
    .rowWeight{
      padding-left: 32px;
      font-weight: 500;
      text-transform: lowercase;
      color: color-mix(in srgb, var(--fg) 92%, var(--muted));
    }

    .cellBtn{
      width: 100%;
      min-height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 70%, var(--bg));
      padding: 8px 10px;
      cursor:pointer;
      text-align:left;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .cellBtn:hover{ border-color: color-mix(in srgb, var(--border) 55%, var(--accent)); }
    .cellMain{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
      flex:1;
    }
    .cellTop{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .cellValue{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--fg);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 240px;
    }
    .cellGoal{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .badge{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      flex: 0 0 auto;
      border: 1px solid var(--border);
    }
    .bGold{ background: color-mix(in srgb, var(--gold) 70%, transparent); border-color: color-mix(in srgb, var(--gold) 70%, var(--border)); }
    .bGreen{ background: color-mix(in srgb, var(--ok) 70%, transparent); border-color: color-mix(in srgb, var(--ok) 70%, var(--border)); }
    .bYellow{ background: color-mix(in srgb, var(--warn) 70%, transparent); border-color: color-mix(in srgb, var(--warn) 70%, var(--border)); }
    .bRed{ background: color-mix(in srgb, var(--danger) 70%, transparent); border-color: color-mix(in srgb, var(--danger) 70%, var(--border)); }
    .cellGray{ background: color-mix(in srgb, var(--muted) 10%, var(--card)); }

    /* Selected training column highlight */
    .colSelected{
      outline: 2px solid color-mix(in srgb, var(--accent) 55%, transparent);
      outline-offset: -2px;
      background: color-mix(in srgb, var(--accent) 8%, var(--bg));
    }
    thead th.colSelected{
      background: color-mix(in srgb, var(--accent) 10%, var(--bg));
    }

    .backdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.38);
      display:none;
      z-index: 50;
    }
    .backdrop.show{ display:block; }

    .sheet{
      position: fixed;
      left:0; right:0; bottom:0;
      max-width: 980px;
      margin: 0 auto;
      background: var(--bg);
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      border: 1px solid var(--border);
      border-bottom: none;
      box-shadow: var(--shadow);
      transform: translateY(105%);
      transition: transform .18s ease;
      z-index: 60;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    .sheet.show{ transform: translateY(0); }
    .sheetHeader{
      padding: 12px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sheetHeader .ttl{
      font-weight: 900;
      font-size: 14px;
      min-width:0;
    }
    .sheetHeader .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top:2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sheetBody{
      padding: 14px;
      display:grid;
      gap:12px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 640px){ .grid2{ grid-template-columns: 1fr; } }

    .fieldLabel{ font-size: 12px; color: var(--muted); margin-bottom:6px; }
    .toggleRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .toast{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      z-index: 80;
      display:none;
    }
    .toast.show{ display:block; }
    .toastInner{
      max-width: 980px;
      margin: 0 auto;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 90%, transparent);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toastMsg{ font-size: 13px; color: var(--fg); }

    .panel{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding: 12px;
    }
    .panel h4{
      margin:0 0 8px;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: var(--muted);
    }
    canvas{
      width:100%;
      height:160px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: var(--bg);
    }

    .muted{ color: var(--muted); }
    .mono{ font-family: var(--mono); }
    .hr{ height:1px; background: var(--border); margin: 10px 0; }
    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      border:1px solid var(--border);
      padding: 1px 6px;
      border-radius: 8px;
      background: var(--bg);
      color: var(--muted);
    }

    /* clickable header */
    .thClick{
      cursor:pointer;
      border-radius: 10px;
      padding: 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .thClick:hover{
      background: color-mix(in srgb, var(--accent) 8%, transparent);
    }
    .thDate{ font-weight: 900; }
    .thMeta{ font-size: 12px; color: var(--muted); margin-top: 4px; }
    .thBtns{ display:flex; gap:6px; }
    .thBtn{
      height: 34px;
      padding: 0 10px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: transparent;
      cursor:pointer;
      white-space:nowrap;
    }
    .thBtn:hover{ border-color: color-mix(in srgb, var(--border) 60%, var(--danger)); }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="title">GYM PROGRESS (OFFLINE)</div>
      <div class="sub" id="statusLine">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ‚Ä¶</div>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="btnAddTraining" title="–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É">
        <span class="icon">‚ûï</span> –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
      </button>

      <button class="btn" id="btnExport" title="–°–∫–∞—á–∞—Ç—å JSON">
        <span class="icon">‚¨áÔ∏è</span> –≠–∫—Å–ø–æ—Ä—Ç
      </button>

      <label class="btn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON">
        <span class="icon">‚¨ÜÔ∏è</span> –ò–º–ø–æ—Ä—Ç
        <input type="file" id="fileImport" accept="application/json" style="display:none">
      </label>

      <button class="btn" id="btnCopy" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON –≤ –±—É—Ñ–µ—Ä">
        <span class="icon">üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
      </button>

      <button class="btn" id="btnTheme" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <span class="icon">üåô</span> –ù–æ—á—å
      </button>

      <button class="btn" id="btnSettings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <span class="icon">‚öôÔ∏è</span>
      </button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="section">
        <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="row">
          <input class="input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º‚Ä¶" />
          <button class="btn" id="btnToggleEmpty" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏">–ü—É—Å—Ç—ã–µ</button>
        </div>
        <div class="hint" style="margin-top:8px">
          –í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–∏–¥–Ω—ã —Å—Ç–æ–ª–±—Ü–∞–º–∏. –°–ª–µ–≤–∞ ‚Äî —Å–∞–º–∞—è –Ω–æ–≤–∞—è. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –≤ —à–∞–ø–∫–µ —Å—Ç–æ–ª–±—Ü–∞, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
        </div>
      </div>

      <div class="section">
        <h3>–ë–ª–æ–∫–∏ / —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è / –≤–µ—Å–∞</h3>
        <div class="row">
          <button class="btn primary" id="btnAddBlock">+ –ë–ª–æ–∫</button>
          <button class="btn" id="btnAddExercise">+ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
          <button class="btn" id="btnAddWeight">+ –í–µ—Å</button>
        </div>
        <div class="hint" style="margin-top:8px">
          –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–∞—Å–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <b>–∞—Ä—Ö–∏–≤</b>.
        </div>
        <div class="hr"></div>
        <div class="tree" id="tree"></div>
      </div>

      <div class="section">
        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</h3>
        <div class="row">
          <span class="pill">–≤—ã–±—Ä–∞–Ω–æ: <b id="selectedTrainingLabel" style="margin-left:6px; color:var(--fg)">‚Äî</b></span>
          <button class="btn" id="btnTrash">–ö–æ—Ä–∑–∏–Ω–∞</button>
        </div>
        <div style="margin-top:10px" id="statsPanel" class="panel"></div>
      </div>

      <div class="section">
        <h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
        <div class="panel" style="margin-bottom:10px">
          <h4>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –±–ª–æ–∫–∞–º</h4>
          <div class="row" style="margin-bottom:8px">
            <span class="pill">–º–µ—Ç—Ä–∏–∫–∞: <span id="progressMetricLabel" style="font-weight:700; color:var(--fg); margin-left:6px">–æ–±—ä—ë–º</span></span>
          </div>
          <canvas id="chartBlocks" width="900" height="220"></canvas>
          <div class="hint" id="chartBlocksHint" style="margin-top:8px"></div>
        </div>

        <div class="panel">
          <h4>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é</h4>
          <div class="row" style="margin-bottom:8px">
            <select class="select" id="exerciseSelect"></select>
          </div>
          <canvas id="chartExercise" width="900" height="220"></canvas>
          <div class="hint" id="chartExerciseHint" style="margin-top:8px"></div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="tableWrap">
        <div class="tableCard">
          <div class="tableScroll" id="tableScroll">
            <table id="grid">
              <thead id="gridHead"></thead>
              <tbody id="gridBody"></tbody>
            </table>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">
          –¶–≤–µ—Ç–∞: <span class="kbd">–∑–æ–ª–æ—Ç–æ</span> —Ä–µ–∫–æ—Ä–¥, <span class="kbd">–∑–µ–ª—ë–Ω—ã–π</span> –Ω–æ–≤—ã–π –≤–µ—Å, <span class="kbd">–∂—ë–ª—Ç—ã–π</span> –≤–ø–µ—Ä–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ,
          <span class="kbd">—Å–µ—Ä—ã–π</span> –Ω–∏–∂–µ —Ä–µ–∫–æ—Ä–¥–∞, <span class="kbd">–∫—Ä–∞—Å–Ω—ã–π</span> —Ç—Ä–∞–≤–º–∞.
        </div>
      </div>
    </main>
  </div>

  <!-- Cell editor -->
  <div class="backdrop" id="backdrop"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHeader">
      <div style="min-width:0">
        <div class="ttl" id="sheetTitle">–Ø—á–µ–π–∫–∞</div>
        <div class="sub" id="sheetSub">‚Ä¶</div>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnCloseSheet">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="sheetBody">
      <div class="panel">
        <h4>–¶–µ–ª—å –∏ —Å—Ç–∞—Ç—É—Å</h4>
        <div class="row">
          <span class="pill">—Ü–µ–ª—å: <span id="sheetGoal" style="font-weight:800; color:var(--fg); margin-left:6px">‚Äî</span></span>
          <span class="pill">—Å—Ç–∞—Ç—É—Å: <span id="sheetStatus" style="font-weight:800; color:var(--fg); margin-left:6px">‚Äî</span></span>
        </div>
        <div class="hint" id="sheetStatusHint" style="margin-top:8px"></div>
      </div>

      <div class="panel">
        <h4>–°–µ—Ç—ã</h4>
        <div id="setsNone">
          <div class="fieldLabel">–ü–æ–≤—Ç–æ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é). –ü—Ä–∏–º–µ—Ä: <span class="mono">12,10,8</span></div>
          <input class="input" id="setsInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12,10,8" style="width:100%">
        </div>

        <div id="setsLR" style="display:none">
          <div class="grid2">
            <div>
              <div class="fieldLabel">–õ–µ–≤–∞—è (L) ‚Äî –ø–æ–≤—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>
              <input class="input" id="setsInputL" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12,10" style="width:100%">
            </div>
            <div>
              <div class="fieldLabel">–ü—Ä–∞–≤–∞—è (R) ‚Äî –ø–æ–≤—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>
              <input class="input" id="setsInputR" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12,11" style="width:100%">
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:8px">
          –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å 2‚Äì3+ –ø–æ–¥—Ö–æ–¥–æ–≤ –≤ –æ–¥–Ω—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤–µ—Å–∞. –ü—É—Å—Ç–æ = –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.
        </div>
      </div>

      <div class="panel">
        <h4>–¢—Ä–∞–≤–º–∞</h4>
        <div class="toggleRow">
          <label class="pill" style="cursor:pointer">
            <input type="checkbox" id="injuryFlag" style="transform: scale(1.2); margin-right:8px"> —Ç—Ä–∞–≤–º–∞
          </label>
          <span class="hint">–ö—Ä–∞—Å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ.</span>
        </div>
        <div style="margin-top:10px">
          <div class="fieldLabel">–ó–∞–º–µ—Ç–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</div>
          <textarea id="injuryNote" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ä–µ–∑–∫–∞—è –±–æ–ª—å –≤ –ø–ª–µ—á–µ –Ω–∞ –≤—Ç–æ—Ä–æ–º –ø–æ–¥—Ö–æ–¥–µ‚Ä¶"></textarea>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="btn" id="btnClearCell" title="–û—á–∏—Å—Ç–∏—Ç—å —è—á–µ–π–∫—É (—Å–µ—Ç—ã/—Ç—Ä–∞–≤–º–∞)">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="row">
          <button class="btn" id="btnCancelCell">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" id="btnSaveCell">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="sheet" id="settingsSheet">
    <div class="sheetHeader">
      <div style="min-width:0">
        <div class="ttl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="sub">–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å —Ä–µ–∫–æ—Ä–¥, —Ü–µ–ª–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnCloseSettings">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="sheetBody">
      <div class="panel">
        <h4>–†–µ–∫–æ—Ä–¥ (–∑–æ–ª–æ—Ç–æ)</h4>
        <div class="hint">–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ ‚Äú—Ä–µ–∫–æ—Ä–¥‚Äù –≤ —è—á–µ–π–∫–µ –≤–µ—Å√ó—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞.</div>
        <div class="row" style="margin-top:10px">
          <select class="select" id="settingRecordMetric">
            <option value="sumReps">–°—É–º–º–∞ –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø–æ –≤—Å–µ–º —Å–µ—Ç–∞–º</option>
            <option value="bestSet">–õ—É—á—à–∏–π —Å–µ—Ç (–º–∞–∫—Å–∏–º—É–º –ø–æ–≤—Ç–æ—Ä–æ–≤)</option>
          </select>
        </div>
      </div>

      <div class="panel">
        <h4>–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ü–µ–ª–∏ (‚Äú–Ω–∞–¥–æ 15‚Äù)</h4>
        <div class="hint">–¶–µ–ª—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ —Ä–µ–∫–æ—Ä–¥–∞ –¥–ª—è —ç—Ç–æ–≥–æ –≤–µ—Å–∞ (–≤ —Ä–∞–º–∫–∞—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è).</div>
        <div class="row" style="margin-top:10px">
          <select class="select" id="settingGoalStrategy">
            <option value="plusOne">–†–µ–∫–æ—Ä–¥ + 1</option>
            <option value="roundUpNice">–û–∫—Ä—É–≥–ª–∏—Ç—å –≤–≤–µ—Ä—Ö –¥–æ ‚Äú–ª–æ–≥–∏—á–Ω–æ–≥–æ‚Äù</option>
          </select>
        </div>
      </div>

      <div class="panel">
        <h4>–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞)</h4>
        <div class="hint">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ —Å—Ç—Ä–æ—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤.</div>
        <div class="row" style="margin-top:10px">
          <select class="select" id="settingProgressMetric">
            <option value="volume">–û–±—ä—ë–º (–≤–µ—Å √ó –ø–æ–≤—Ç–æ—Ä—ã)</option>
            <option value="recordPoints">–û—á–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤ (—Å–∫–æ–ª—å–∫–æ ‚Äú–∑–æ–ª–æ—Ç–∞‚Äù)</option>
          </select>
        </div>
      </div>

      <div class="panel">
        <h4>–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
        <div class="row">
          <label class="pill" style="cursor:pointer">
            <input type="checkbox" id="settingHideEmpty" style="transform:scale(1.2); margin-right:8px">
            —Å–∫—Ä—ã—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
          </label>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button class="btn primary" id="btnSaveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
  </div>

  <!-- Trash -->
  <div class="sheet" id="trashSheet">
    <div class="sheetHeader">
      <div style="min-width:0">
        <div class="ttl">–ö–æ—Ä–∑–∏–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        <div class="sub">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnCloseTrash">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="sheetBody">
      <div class="panel" id="trashList"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toastInner">
      <div class="toastMsg" id="toastMsg">‚Ä¶</div>
      <div class="row">
        <button class="btn" id="toastUndo">Undo</button>
        <button class="btn ghost" id="toastClose">OK</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   Gym Progress Tracker ‚Äî Single-file, Offline-first (no libs)
   Storage: IndexedDB (autosave) + Export/Import JSON + Copy JSON
   Table: all trainings are columns (newest on the left)
   Select training: click column header
   ========================================================= */

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function uid(prefix){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function parseDateDDMMYYYY(s){
  const m = /^(\\d{2})\\.(\\d{2})\\.(\\d{4})$/.exec((s||"").trim());
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yyyy = +m[3];
  if(mm < 1 || mm > 12) return null;
  if(dd < 1 || dd > 31) return null;
  const d = new Date(yyyy, mm-1, dd);
  if(d.getFullYear() !== yyyy || d.getMonth() !== (mm-1) || d.getDate() !== dd) return null;
  return { dd, mm, yyyy, ts: d.getTime() };
}
function formatNowStamp(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}${mm}${dd}-${hh}${mi}`;
}
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* ---------- IndexedDB ---------- */
const DB_NAME = "gym_progress_db_v1";
const DB_STORE = "app_state";
const DB_KEY = "state";

function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        db.createObjectStore(DB_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbGet(){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readonly");
    const st = tx.objectStore(DB_STORE);
    const req = st.get(DB_KEY);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}
async function idbSet(value){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    const st = tx.objectStore(DB_STORE);
    const req = st.put(value, DB_KEY);
    req.onsuccess = () => resolve(true);
    req.onerror = () => reject(req.error);
  });
}

/* ---------- State ---------- */
const DEFAULT_STATE = () => ({
  version: 1,
  settings: {
    theme: "light",
    recordMetric: "sumReps",     // sumReps | bestSet
    goalStrategy: "plusOne",     // plusOne | roundUpNice
    progressMetric: "volume",    // volume | recordPoints
    hideEmptyRows: false
  },
  trainings: [],
  blocks: [],
  records: {},
  trash: { trainings: [] }
});

let state = DEFAULT_STATE();
let dirty = false;
let lastSavedAt = 0;
let saveTimer = null;

// UI state (not persisted)
let selectedTrainingId = "";

/* ---------- Boot ---------- */
(async function init(){
  const loaded = await safeLoad();
  if(!loaded){
    seedSampleData();
    await saveNow("init");
  }
  applyTheme();
  bindUI();
  ensureSelectedTraining();
  renderAll();
  setStatusLine();

  scheduleSave();

  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "hidden"){
      if(dirty) saveNow("visibility");
    }
  });
})();

async function safeLoad(){
  try{
    const x = await idbGet();
    if(x && x.version === 1){
      state = x;
      return true;
    }
    return false;
  }catch(e){
    console.warn("Load failed", e);
    return false;
  }
}
function markDirty(){
  dirty = true;
  setStatusLine();
  scheduleSave();
}
function scheduleSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> saveNow("autosave"), 600);
}
async function saveNow(reason){
  try{
    await idbSet(state);
    dirty = false;
    lastSavedAt = Date.now();
    setStatusLine(reason);
  }catch(e){
    console.warn("Save failed", e);
    try{
      localStorage.setItem("gym_progress_fallback", JSON.stringify(state));
      dirty = false;
      lastSavedAt = Date.now();
      setStatusLine(reason + " (fallback)");
    }catch(_){}
  }
}
function setStatusLine(reason=""){
  const el = $("#statusLine");
  const when = lastSavedAt ? new Date(lastSavedAt).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "‚Äî";
  if(dirty){
    el.textContent = "–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è‚Ä¶";
  }else{
    el.textContent = `–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: OK (${when})${reason? " ¬∑ " + reason : ""}`;
  }
}

/* ---------- Sample ---------- */
function seedSampleData(){
  const t1 = { id: uid("t"), date:"03.01.2026", createdAt: Date.now()-86400000*2 };
  const t2 = { id: uid("t"), date:"05.01.2026", createdAt: Date.now() };

  const b1 = { id: uid("b"), name:"–ì–†–£–î–¨", archived:false, order:100, exercises:[] };
  const e1 = { id: uid("e"), name:"–∂–∏–º –ª–µ–∂–∞", lrMode:"none", weights:[] };
  const w1 = { id: uid("w"), value:60, hidden:false };
  const w2 = { id: uid("w"), value:65, hidden:false };
  e1.weights.push(w1, w2);
  b1.exercises.push(e1);

  const b2 = { id: uid("b"), name:"–°–ü–ò–ù–ê", archived:false, order:200, exercises:[] };
  const e2 = { id: uid("e"), name:"—Ç—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", lrMode:"none", weights:[] };
  const w3 = { id: uid("w"), value:50, hidden:false };
  e2.weights.push(w3);
  b2.exercises.push(e2);

  state.trainings = [t1, t2];
  state.blocks = [b1, b2];
  state.records = {};

  setCell(t1.id, e1.id, w1.id, { sets: [{reps:12, side:""},{reps:10, side:""},{reps:8, side:""}], injury:{flag:false, note:""} }, false);
  setCell(t2.id, e1.id, w1.id, { sets: [{reps:13, side:""},{reps:10, side:""},{reps:8, side:""}], injury:{flag:false, note:""} }, false);
  setCell(t2.id, e2.id, w3.id, { sets: [{reps:12, side:""},{reps:12, side:""}], injury:{flag:false, note:""} }, false);
}

/* ---------- Data helpers ---------- */
function getBlock(blockId){ return state.blocks.find(b=>b.id===blockId) || null; }
function getExercise(exId){
  for(const b of state.blocks){
    for(const e of b.exercises){
      if(e.id===exId) return e;
    }
  }
  return null;
}
function getBlockByExercise(exId){
  for(const b of state.blocks){
    if(b.exercises.some(e=>e.id===exId)) return b;
  }
  return null;
}
function getWeight(exId, wId){
  const e = getExercise(exId);
  return e?.weights?.find(w=>w.id===wId) || null;
}
function getCell(tid, exId, wId){
  return state.records?.[tid]?.[exId]?.[wId] || null;
}
function setCell(tid, exId, wId, data, doMarkDirty=true){
  state.records[tid] ||= {};
  state.records[tid][exId] ||= {};
  state.records[tid][exId][wId] = data;
  if(doMarkDirty) markDirty();
}
function clearCell(tid, exId, wId){
  if(state.records?.[tid]?.[exId]?.[wId]){
    delete state.records[tid][exId][wId];
    if(Object.keys(state.records[tid][exId]).length === 0) delete state.records[tid][exId];
    if(Object.keys(state.records[tid]).length === 0) delete state.records[tid];
    markDirty();
  }
}
function isCellEmpty(cell){
  if(!cell) return true;
  const hasSets = Array.isArray(cell.sets) && cell.sets.some(s => (s?.reps||0) > 0);
  const hasInjury = !!cell?.injury?.flag || (cell?.injury?.note || "").trim().length>0;
  return !hasSets && !hasInjury;
}
function cellMetric(cell){
  if(!cell || !Array.isArray(cell.sets)) return 0;
  const reps = cell.sets.filter(s=>Number.isFinite(s.reps) && s.reps>0).map(s=>s.reps);
  if(reps.length===0) return 0;
  if(state.settings.recordMetric === "bestSet") return Math.max(...reps);
  return reps.reduce((a,b)=>a+b,0);
}
function cellVolume(cell, weightValue){
  if(!cell) return 0;
  const repsSum = (cell.sets||[]).reduce((a,s)=>a + (Number.isFinite(s.reps)&&s.reps>0 ? s.reps : 0), 0);
  return repsSum * (Number(weightValue)||0);
}

/* ---------- Trainings sorting: NEWEST FIRST (leftmost) ---------- */
function sortedTrainingsDesc(){
  return [...state.trainings].sort((a,b)=>{
    const da = parseDateDDMMYYYY(a.date)?.ts ?? 0;
    const db = parseDateDDMMYYYY(b.date)?.ts ?? 0;
    if(da !== db) return db - da; // desc
    return (b.createdAt||0) - (a.createdAt||0);
  });
}
function ensureSelectedTraining(){
  const trainings = sortedTrainingsDesc();
  if(trainings.length===0){
    selectedTrainingId = "";
    $("#selectedTrainingLabel").textContent = "‚Äî";
    return;
  }
  if(!selectedTrainingId || !trainings.some(t=>t.id===selectedTrainingId)){
    selectedTrainingId = trainings[0].id; // newest
  }
  const t = trainings.find(x=>x.id===selectedTrainingId);
  $("#selectedTrainingLabel").textContent = t?.date || "‚Äî";
}

/* ---------- Status/goal computation ---------- */
function computeFirstsAndBests(){
  // IMPORTANT: firsts/bests use chronological order (oldest -> newest)
  const trainingsAsc = [...state.trainings].sort((a,b)=>{
    const da = parseDateDDMMYYYY(a.date)?.ts ?? 0;
    const db = parseDateDDMMYYYY(b.date)?.ts ?? 0;
    if(da !== db) return da - db;
    return (a.createdAt||0) - (b.createdAt||0);
  });

  const exerciseFirst = {};
  const weightFirst = {};
  const bestSoFar = {};
  const bestBefore = {};

  for(const t of trainingsAsc){
    const tid = t.id;

    for(const b of state.blocks){
      for(const e of b.exercises){
        const exId = e.id;
        for(const w of e.weights){
          const wId = w.id;
          const cell = getCell(tid, exId, wId);
          const hasSets = cell && (cell.sets||[]).some(s=>s.reps>0);

          bestBefore[exId] ||= {};
          bestBefore[exId][wId] ||= {};
          bestSoFar[exId] ||= {};
          bestSoFar[exId][wId] ||= 0;

          bestBefore[exId][wId][tid] = bestSoFar[exId][wId];

          if(hasSets){
            if(!exerciseFirst[exId]) exerciseFirst[exId] = tid;
            weightFirst[exId] ||= {};
            if(!weightFirst[exId][wId]) weightFirst[exId][wId] = tid;

            const m = cellMetric(cell);
            if(m > bestSoFar[exId][wId]) bestSoFar[exId][wId] = m;
          }
        }
      }
    }
  }
  return { exerciseFirst, weightFirst, bestBefore };
}
function computeGoalFromBest(best){
  if(!best || best<=0) return null;
  if(state.settings.goalStrategy === "plusOne") return best + 1;
  if(state.settings.recordMetric === "bestSet"){
    const step = 2;
    return Math.ceil((best + 0.01) / step) * step;
  }else{
    const step = 5;
    return Math.ceil((best + 0.01) / step) * step;
  }
}
function computeCellStatus(tid, exId, wId, cache){
  const cell = getCell(tid, exId, wId);
  if(!cell || isCellEmpty(cell)) return { label:"‚Äî", badges:[], gray:false, goal:null, hint:"" };

  const { exerciseFirst, weightFirst, bestBefore } = cache;
  const prevBest = bestBefore?.[exId]?.[wId]?.[tid] ?? 0;
  const cur = cellMetric(cell);
  const goal = computeGoalFromBest(prevBest);

  if(cell?.injury?.flag){
    return { label:"—Ç—Ä–∞–≤–º–∞", badges:["red"], gray:false, goal, hint:"–¢—Ä–∞–≤–º–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é." };
  }

  const badges = [];
  const isFirstExercise = (exerciseFirst?.[exId] === tid);
  const isFirstWeight = (weightFirst?.[exId]?.[wId] === tid);
  const isRecord = (cur > prevBest && cur > 0);

  if(isRecord) badges.push("gold");
  if(isFirstWeight) badges.push("green");
  if(isFirstExercise) badges.push("yellow");

  const hasPrevRecord = prevBest > 0;
  const gray = hasPrevRecord && cur > 0 && cur < prevBest && badges.length===0;

  let label = "–æ–±—ã—á–Ω–æ";
  let hint = hasPrevRecord ? `–†–µ–∫–æ—Ä–¥: ${prevBest}, —Å–µ–π—á–∞—Å: ${cur}.` : `–°–µ–π—á–∞—Å: ${cur}.`;
  if(isRecord){ label="—Ä–µ–∫–æ—Ä–¥"; hint=`–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: –±—ã–ª–æ ${prevBest}, —Å—Ç–∞–ª–æ ${cur}.`; }
  else if(isFirstWeight){ label="–Ω–æ–≤—ã–π –≤–µ—Å"; hint="–ü–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –≤–µ—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."; }
  else if(isFirstExercise){ label="–ø–µ—Ä–≤—ã–π —Ä–∞–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"; hint="–ü–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –≥–¥–µ –µ—Å—Ç—å —Å–µ—Ç—ã –ø–æ —ç—Ç–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é."; }
  else if(gray){ label="–Ω–∏–∂–µ —Ä–µ–∫–æ—Ä–¥–∞"; hint=`–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ä–µ–∫–æ—Ä–¥: ${prevBest}, —Å–µ–π—á–∞—Å: ${cur}.`; }

  return { label, badges, gray, goal, hint };
}

/* ---------- Rendering ---------- */
function applyTheme(){
  document.documentElement.dataset.theme = state.settings.theme;
  $("#btnTheme").innerHTML = state.settings.theme === "dark"
    ? `<span class="icon">‚òÄÔ∏è</span> –î–µ–Ω—å`
    : `<span class="icon">üåô</span> –ù–æ—á—å`;
}
function listAllExercises(){
  const out = [];
  for(const b of state.blocks){
    for(const e of b.exercises){
      out.push({ block:b, exercise:e });
    }
  }
  return out;
}
function renderAll(){
  ensureSelectedTraining();
  renderTree();
  renderExerciseSelect();
  renderGrid();
  renderStats();
  renderAnalytics();
}

function renderTree(){
  const tree = $("#tree");
  tree.innerHTML = "";

  const q = ($("#searchInput").value || "").trim().toLowerCase();
  const blocks = [...state.blocks].sort((a,b)=> (a.order||0)-(b.order||0));

  for(const b of blocks){
    if(b.archived) continue;
    const wrap = document.createElement("div");
    wrap.className = "treeItem";
    wrap.innerHTML = `
      <div class="meta">
        <div class="name">${escapeHtml(b.name || "–ë–õ–û–ö")}</div>
        <div class="small">
          <span class="chip">${b.exercises.length} —É–ø—Ä.</span>
        </div>
        <div class="small" style="margin-top:6px; gap:6px">
          ${b.exercises.map(e=>{
            const match = !q || e.name.toLowerCase().includes(q) || (b.name||"").toLowerCase().includes(q);
            if(!match) return "";
            return `<span class="chip">${escapeHtml(e.name)}${e.lrMode==="lr" ? " (L/R)" : ""}</span>`;
          }).join("") || `<span class="chip">‚Äî</span>`}
        </div>
      </div>
      <div class="miniBtns">
        <button class="miniBtn" data-act="renameBlock" data-id="${b.id}" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
        <button class="miniBtn" data-act="toggleArchive" data-id="${b.id}" title="–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å">üóÑÔ∏è</button>
        <button class="miniBtn" data-act="deleteBlock" data-id="${b.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
      </div>
    `;
    tree.appendChild(wrap);
  }

  $$(".miniBtn", tree).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(act==="renameBlock") renameBlock(id);
      if(act==="toggleArchive") toggleArchiveBlock(id);
      if(act==="deleteBlock") deleteBlock(id);
    });
  });
}

function renderExerciseSelect(){
  const sel = $("#exerciseSelect");
  const all = listAllExercises().filter(x=>!x.block.archived);
  sel.innerHTML = "";
  const o0 = document.createElement("option");
  o0.value = "";
  o0.textContent = all.length ? "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ‚Ä¶" : "–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π";
  sel.appendChild(o0);
  for(const x of all){
    const o = document.createElement("option");
    o.value = x.exercise.id;
    o.textContent = `${x.block.name} ¬∑ ${x.exercise.name}`;
    sel.appendChild(o);
  }
}

function renderGrid(){
  const head = $("#gridHead");
  const body = $("#gridBody");
  head.innerHTML = "";
  body.innerHTML = "";

  const trainings = sortedTrainingsDesc(); // NEWEST FIRST => leftmost
  const cache = computeFirstsAndBests();

  // Header row
  const trh = document.createElement("tr");
  const th0 = document.createElement("th");
  th0.textContent = "–ë–ª–æ–∫ / —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ / –≤–µ—Å";
  trh.appendChild(th0);

  trainings.forEach((t, colIndex)=>{
    const th = document.createElement("th");
    th.dataset.col = String(colIndex);
    th.dataset.tid = t.id;

    if(t.id === selectedTrainingId) th.classList.add("colSelected");

    th.innerHTML = `
      <div class="thClick" data-select-tid="${t.id}" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏">
        <div style="min-width:0">
          <div class="thDate">${escapeHtml(t.date)}</div>
          <div class="thMeta">—Ç–∞–ø –ø–æ —è—á–µ–π–∫–µ ‚Üí –≤–≤–æ–¥</div>
        </div>
        <div class="thBtns">
          <button class="thBtn" data-del-tid="${t.id}" title="–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `;
    trh.appendChild(th);
  });
  head.appendChild(trh);

  // Header actions
  $$("[data-del-tid]", head).forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      deleteTraining(btn.dataset.delTid);
    });
  });
  $$("[data-select-tid]", head).forEach(box=>{
    box.addEventListener("click", ()=>{
      selectedTrainingId = box.dataset.selectTid;
      ensureSelectedTraining();
      renderGrid();   // for highlight
      renderStats();  // for selected stats
    });
  });

  // Rows
  const q = ($("#searchInput").value || "").trim().toLowerCase();
  const hideEmpty = !!state.settings.hideEmptyRows;

  const blocks = [...state.blocks].sort((a,b)=>(a.order||0)-(b.order||0));
  for(const b of blocks){
    if(b.archived) continue;

    // block row
    const trB = document.createElement("tr");
    const thB = document.createElement("th");
    thB.className = "rowBlock";
    thB.textContent = b.name || "–ë–õ–û–ö";
    trB.appendChild(thB);
    trainings.forEach((t, colIndex)=>{
      const td = document.createElement("td");
      if(t.id === selectedTrainingId) td.classList.add("colSelected");
      td.innerHTML = `<span class="muted">‚Äî</span>`;
      trB.appendChild(td);
    });
    body.appendChild(trB);

    for(const e of b.exercises){
      const matchExercise = !q || e.name.toLowerCase().includes(q) || (b.name||"").toLowerCase().includes(q);

      const trE = document.createElement("tr");
      const thE = document.createElement("th");
      thE.className = "rowExercise";
      thE.innerHTML = `${escapeHtml(e.name)} ${e.lrMode==="lr" ? `<span class="chip">L/R</span>` : ""}`;
      trE.appendChild(thE);
      trainings.forEach((t)=>{
        const td = document.createElement("td");
        if(t.id === selectedTrainingId) td.classList.add("colSelected");
        td.innerHTML = `<span class="muted">‚Äî</span>`;
        trE.appendChild(td);
      });
      body.appendChild(trE);

      for(const w of e.weights){
        if(w.hidden) continue;

        if(hideEmpty){
          let any=false;
          for(const t of trainings){
            const c = getCell(t.id, e.id, w.id);
            if(c && !isCellEmpty(c)){ any=true; break; }
          }
          if(!any) continue;
        }

        const matchWeightRow = matchExercise || `${w.value}`.includes(q);
        if(q && !matchWeightRow) continue;

        const trW = document.createElement("tr");
        const thW = document.createElement("th");
        thW.className = "rowWeight";
        thW.innerHTML = `${escapeHtml(e.name)} ¬∑ <span class="mono">${escapeHtml(String(w.value))} –∫–≥</span>`;
        trW.appendChild(thW);

        trainings.forEach((t)=>{
          const td = document.createElement("td");
          if(t.id === selectedTrainingId) td.classList.add("colSelected");

          const cell = getCell(t.id, e.id, w.id);
          const st = computeCellStatus(t.id, e.id, w.id, cache);

          const badgesHtml = (st.badges || []).slice(0,3).map(bdg=>{
            if(bdg==="gold") return `<span class="badge bGold" title="–†–µ–∫–æ—Ä–¥"></span>`;
            if(bdg==="green") return `<span class="badge bGreen" title="–ù–æ–≤—ã–π –≤–µ—Å"></span>`;
            if(bdg==="yellow") return `<span class="badge bYellow" title="–ü–µ—Ä–≤—ã–π —Ä–∞–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"></span>`;
            if(bdg==="red") return `<span class="badge bRed" title="–¢—Ä–∞–≤–º–∞"></span>`;
            return "";
          }).join("");

          const cellText = formatCellText(cell, e.lrMode);
          const goalText = st.goal ? `–Ω–∞–¥–æ ${st.goal}` : "";
          const grayClass = st.gray ? "cellGray" : "";

          td.innerHTML = `
            <button class="cellBtn ${grayClass}" data-tid="${t.id}" data-ex="${e.id}" data-w="${w.id}">
              <div class="cellMain">
                <div class="cellTop">
                  ${badgesHtml || `<span class="badge" title="–Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞"></span>`}
                  <div class="cellValue">${escapeHtml(cellText || "‚Äî")}</div>
                </div>
                <div class="cellGoal">${escapeHtml(goalText)}</div>
              </div>
              <div class="muted" style="font-size:12px; white-space:nowrap">${escapeHtml(st.label)}</div>
            </button>
          `;
          trW.appendChild(td);
        });

        body.appendChild(trW);
      }
    }
  }

  $$(".cellBtn", body).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      openCellEditor(btn.dataset.tid, btn.dataset.ex, btn.dataset.w);
    });
  });
}

function formatCellText(cell, lrMode){
  if(!cell || isCellEmpty(cell)) return "";
  const sets = cell.sets || [];
  const injury = cell?.injury?.flag ? " ‚öë" : "";
  if(lrMode === "lr"){
    const L = sets.filter(s=>s.side==="L").map(s=>s.reps).filter(x=>x>0);
    const R = sets.filter(s=>s.side==="R").map(s=>s.reps).filter(x=>x>0);
    const ltxt = L.length ? `L:${L.join(",")}` : "L:‚Äî";
    const rtxt = R.length ? `R:${R.join(",")}` : "R:‚Äî";
    return `${ltxt} | ${rtxt}${injury}`;
  }else{
    const reps = sets.map(s=>s.reps).filter(x=>x>0);
    return reps.length ? reps.join(",") + injury : (injury ? "‚öë" : "");
  }
}

/* ---------- Stats (for selected column) ---------- */
function renderStats(){
  ensureSelectedTraining();
  const tid = selectedTrainingId;
  const panel = $("#statsPanel");
  const trainings = sortedTrainingsDesc();
  const t = trainings.find(x=>x.id===tid);

  if(!t){
    panel.innerHTML = `<div class="hint">–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–Ω–æ–ø–∫–æ–π ‚Äú–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞‚Äù.</div>`;
    return;
  }

  $("#selectedTrainingLabel").textContent = t.date;

  const cache = computeFirstsAndBests();

  let gold=0, green=0, yellow=0, injuries=0;
  const setsPerBlock = {};
  const goalFails = { totalWithGoal:0, failed:0 };

  for(const b of state.blocks){
    if(b.archived) continue;
    for(const e of b.exercises){
      for(const w of e.weights){
        if(w.hidden) continue;
        const cell = getCell(tid, e.id, w.id);
        if(!cell || isCellEmpty(cell)) continue;

        const st = computeCellStatus(tid, e.id, w.id, cache);
        if((st.badges||[]).includes("gold")) gold++;
        if((st.badges||[]).includes("green")) green++;
        if((st.badges||[]).includes("yellow")) yellow++;
        if((st.badges||[]).includes("red")) injuries++;

        const setsCount = (cell.sets||[]).filter(s=>s.reps>0).length;
        setsPerBlock[b.name] = (setsPerBlock[b.name]||0) + setsCount;

        if(st.goal){
          goalFails.totalWithGoal++;
          const cur = cellMetric(cell);
          if(cur < st.goal) goalFails.failed++;
        }
      }
    }
  }

  const legend = `
    <div class="hint" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:6px">
      <span><span class="badge bGold"></span> —Ä–µ–∫–æ—Ä–¥</span>
      <span><span class="badge bGreen"></span> –Ω–æ–≤—ã–π –≤–µ—Å</span>
      <span><span class="badge bYellow"></span> –≤–ø–µ—Ä–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</span>
      <span><span class="badge bRed"></span> —Ç—Ä–∞–≤–º–∞</span>
      <span class="muted">(—Å–µ—Ä—ã–π —Ñ–æ–Ω = –Ω–∏–∂–µ —Ä–µ–∫–æ—Ä–¥–∞)</span>
    </div>
  `;

  const blocksLines = Object.entries(setsPerBlock)
    .sort((a,b)=>b[1]-a[1])
    .map(([k,v])=> `<div class="row" style="justify-content:space-between"><div>${escapeHtml(k)}</div><div class="mono">${v}</div></div>`)
    .join("") || `<div class="hint">–ù–µ—Ç —Å–µ—Ç–æ–≤ –≤ —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.</div>`;

  const failPct = goalFails.totalWithGoal ? Math.round((goalFails.failed/goalFails.totalWithGoal)*100) : 0;

  panel.innerHTML = `
    <div class="row" style="justify-content:space-between; margin-bottom:10px">
      <div>
        <div style="font-weight:900">${escapeHtml(t.date)}</div>
        <div class="hint">–í—ã–±–æ—Ä ‚Äî –∫–ª–∏–∫–æ–º –ø–æ –¥–∞—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü–µ</div>
      </div>
      <span class="pill">—Ä–µ–∫–æ—Ä–¥-–º–µ—Ç—Ä–∏–∫–∞: <b style="margin-left:6px; color:var(--fg)">${state.settings.recordMetric==="sumReps" ? "—Å—É–º–º–∞" : "–ª—É—á—à–∏–π —Å–µ—Ç"}</b></span>
    </div>

    <div class="grid2">
      <div class="panel">
        <h4>–ò—Ç–æ–≥–∏</h4>
        <div class="row" style="justify-content:space-between"><div>–†–µ–∫–æ—Ä–¥—ã (–∑–æ–ª–æ—Ç–æ)</div><div class="mono">${gold}</div></div>
        <div class="row" style="justify-content:space-between"><div>–ù–æ–≤—ã–µ –≤–µ—Å–∞ (–∑–µ–ª—ë–Ω—ã–π)</div><div class="mono">${green}</div></div>
        <div class="row" style="justify-content:space-between"><div>–ù–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–∂—ë–ª—Ç—ã–π)</div><div class="mono">${yellow}</div></div>
        <div class="row" style="justify-content:space-between"><div>–¢—Ä–∞–≤–º—ã (–∫—Ä–∞—Å–Ω—ã–π)</div><div class="mono">${injuries}</div></div>
        <div class="hr"></div>
        <div class="row" style="justify-content:space-between"><div>–ü—Ä–æ–≤–∞–ª —Ü–µ–ª–∏</div><div class="mono">${goalFails.failed}/${goalFails.totalWithGoal} (${failPct}%)</div></div>
        ${legend}
      </div>

      <div class="panel">
        <h4>–°–µ—Ç—ã –ø–æ –±–ª–æ–∫–∞–º</h4>
        ${blocksLines}
      </div>
    </div>
  `;
}

/* ---------- Analytics ---------- */
function renderAnalytics(){
  $("#progressMetricLabel").textContent =
    state.settings.progressMetric === "volume" ? "–æ–±—ä—ë–º" : "–æ—á–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤";
  drawBlocksChart();
  drawExerciseChart();
  buildAnalyticsHints();
}
function computeTrainingTotalsAsc(){
  // charts/comparisons need time order oldest->newest
  const trainingsAsc = [...state.trainings].sort((a,b)=>{
    const da = parseDateDDMMYYYY(a.date)?.ts ?? 0;
    const db = parseDateDDMMYYYY(b.date)?.ts ?? 0;
    if(da !== db) return da - db;
    return (a.createdAt||0) - (b.createdAt||0);
  });

  const cache = computeFirstsAndBests();

  return trainingsAsc.map(t=>{
    const perBlock = {};
    let overall = 0;
    let recordPoints = 0;
    let injuries = 0;

    for(const b of state.blocks){
      if(b.archived) continue;
      for(const e of b.exercises){
        for(const w of e.weights){
          if(w.hidden) continue;
          const cell = getCell(t.id, e.id, w.id);
          if(!cell || isCellEmpty(cell)) continue;

          const st = computeCellStatus(t.id, e.id, w.id, cache);

          if(state.settings.progressMetric === "volume"){
            const vol = cellVolume(cell, w.value);
            perBlock[b.name] = (perBlock[b.name]||0) + vol;
            overall += vol;
          }else{
            if((st.badges||[]).includes("gold")) recordPoints++;
          }
          if((st.badges||[]).includes("red")) injuries++;
        }
      }
    }
    return { training:t, perBlock, overall, recordPoints, injuries };
  });
}
function drawBlocksChart(){
  const cnv = $("#chartBlocks");
  const ctx = cnv.getContext("2d");
  const W = cnv.width, H = cnv.height;
  ctx.clearRect(0,0,W,H);

  const totals = computeTrainingTotalsAsc();
  if(totals.length < 2){
    $("#chartBlocksHint").textContent = "–î–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.";
    return;
  }

  const sums = {};
  for(const t of totals){
    for(const [bn,v] of Object.entries(t.perBlock)){
      sums[bn] = (sums[bn]||0) + v;
    }
  }
  const topBlocks = Object.entries(sums).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);
  if(topBlocks.length === 0){
    $("#chartBlocksHint").textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ç–∞–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞.";
    return;
  }

  const padding = 26;
  const innerW = W - padding*2;
  const innerH = H - padding*2;

  let maxV = 0;
  for(const t of totals){
    for(const bn of topBlocks){
      maxV = Math.max(maxV, t.perBlock[bn]||0);
    }
  }
  maxV = maxV || 1;

  ctx.globalAlpha = 1;
  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(128,128,128,0.35)";
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, H-padding);
  ctx.lineTo(W-padding, H-padding);
  ctx.stroke();

  topBlocks.forEach((bn, idx)=>{
    ctx.globalAlpha = 0.85 - idx*0.12;
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(80,120,220,0.9)";
    ctx.beginPath();
    totals.forEach((t, i)=>{
      const x = padding + (i/(totals.length-1))*innerW;
      const v = (t.perBlock[bn]||0);
      const y = (H-padding) - (v/maxV)*innerH;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  });
  ctx.globalAlpha = 1;

  $("#chartBlocksHint").textContent =
    `–õ–∏–Ω–∏–∏ (—Ç–æ–ø-4 –±–ª–æ–∫–∞): ${topBlocks.join(", ")}. ` +
    (state.settings.progressMetric === "volume"
      ? "–ú–µ—Ç—Ä–∏–∫–∞: –æ–±—ä—ë–º (–≤–µ—Å√ó–ø–æ–≤—Ç–æ—Ä—ã), —Å—É–º–º–∞—Ä–Ω–æ –ø–æ –±–ª–æ–∫—É."
      : "–ú–µ—Ç—Ä–∏–∫–∞: –æ—á–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤ (—Å–∫–æ–ª—å–∫–æ ‚Äú–∑–æ–ª–æ—Ç–∞‚Äù).");
}
function drawExerciseChart(){
  const cnv = $("#chartExercise");
  const ctx = cnv.getContext("2d");
  const W = cnv.width, H = cnv.height;
  ctx.clearRect(0,0,W,H);

  const exId = $("#exerciseSelect").value;
  if(!exId){
    $("#chartExerciseHint").textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –≥—Ä–∞—Ñ–∏–∫.";
    return;
  }
  const ex = getExercise(exId);
  if(!ex){
    $("#chartExerciseHint").textContent = "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
    return;
  }

  const trainingsAsc = [...state.trainings].sort((a,b)=>{
    const da = parseDateDDMMYYYY(a.date)?.ts ?? 0;
    const db = parseDateDDMMYYYY(b.date)?.ts ?? 0;
    if(da !== db) return da - db;
    return (a.createdAt||0) - (b.createdAt||0);
  });

  const cache = computeFirstsAndBests();

  const values = trainingsAsc.map(t=>{
    let v = 0;
    for(const w of ex.weights){
      const cell = getCell(t.id, exId, w.id);
      if(!cell || isCellEmpty(cell)) continue;
      if(state.settings.progressMetric === "volume"){
        v += cellVolume(cell, w.value);
      }else{
        const st = computeCellStatus(t.id, exId, w.id, cache);
        if((st.badges||[]).includes("gold")) v += 1;
      }
    }
    return v;
  });

  const maxV = Math.max(...values, 1);
  const padding = 26;
  const innerW = W - padding*2;
  const innerH = H - padding*2;

  ctx.strokeStyle = "rgba(128,128,128,0.35)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, H-padding);
  ctx.lineTo(W-padding, H-padding);
  ctx.stroke();

  ctx.strokeStyle = "rgba(80,120,220,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x = padding + (i/(values.length-1 || 1))*innerW;
    const y = (H-padding) - (v/maxV)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  const b = getBlockByExercise(exId);
  $("#chartExerciseHint").textContent =
    `${b?.name || "–ë–ª–æ–∫"} ¬∑ ${ex.name}. ` +
    (state.settings.progressMetric === "volume"
      ? "–ú–µ—Ç—Ä–∏–∫–∞: –æ–±—ä—ë–º (–≤–µ—Å√ó–ø–æ–≤—Ç–æ—Ä—ã), —Å—É–º–º–∞—Ä–Ω–æ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é."
      : "–ú–µ—Ç—Ä–∏–∫–∞: –æ—á–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤ ‚Äî —Å–∫–æ–ª—å–∫–æ ‚Äú–∑–æ–ª–æ—Ç–∞‚Äù –≤–Ω—É—Ç—Ä–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.");
}
function buildAnalyticsHints(){
  const totals = computeTrainingTotalsAsc();
  if(totals.length < 2) return;

  function monthKey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }

  const keyed = totals.map(x=>{
    const ts = parseDateDDMMYYYY(x.training.date)?.ts ?? x.training.createdAt ?? 0;
    const key = monthKey(ts);
    const val = (state.settings.progressMetric === "volume") ? x.overall : x.recordPoints;
    return { key, val, injuries: x.injuries };
  });

  const months = [...new Set(keyed.map(x=>x.key))].sort();
  const curM = months[months.length-1];
  const prevM = months.length>=2 ? months[months.length-2] : null;

  const sum = (m)=> keyed.filter(x=>x.key===m).reduce((a,b)=>a+b.val,0);
  const curVal = sum(curM);
  const prevVal = prevM ? sum(prevM) : 0;

  let deltaText = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤.";
  if(prevM && prevVal>0){
    const pct = Math.round(((curVal - prevVal)/prevVal)*100);
    deltaText = `–í –º–µ—Å—è—Ü–µ ${curM} –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ ${Math.abs(pct)}% ${pct>=0 ? "–ª—É—á—à–µ" : "—Ö—É–∂–µ"}, —á–µ–º –≤ ${prevM}.`;
  }

  const hintBlocks = $("#chartBlocksHint").textContent;
  $("#chartBlocksHint").textContent = hintBlocks + " " + deltaText;
}

/* ---------- Sheets/Toast ---------- */
function openBackdrop(){ $("#backdrop").classList.add("show"); }
function closeBackdrop(){ $("#backdrop").classList.remove("show"); }
function showSheet(el){ openBackdrop(); el.classList.add("show"); }
function hideSheet(el){
  el.classList.remove("show");
  const any = [$("#sheet"), $("#settingsSheet"), $("#trashSheet")].some(s=>s.classList.contains("show"));
  if(!any) closeBackdrop();
}

let editing = null;

function openCellEditor(tid, exId, wId){
  const ex = getExercise(exId);
  const w = getWeight(exId, wId);
  const t = sortedTrainingsDesc().find(x=>x.id===tid);

  editing = { tid, exId, wId };

  $("#sheetTitle").textContent = `${ex?.name || "—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"} ¬∑ ${w?.value ?? "?"} –∫–≥`;
  $("#sheetSub").textContent = `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${t?.date || "?"}`;

  const cache = computeFirstsAndBests();
  const st = computeCellStatus(tid, exId, wId, cache);
  $("#sheetGoal").textContent = st.goal ? `–Ω–∞–¥–æ ${st.goal}` : "‚Äî";
  $("#sheetStatus").textContent = st.label || "‚Äî";
  $("#sheetStatusHint").textContent = st.hint || "";

  const cell = getCell(tid, exId, wId) || { sets: [], injury:{flag:false, note:""} };
  const lr = ex?.lrMode === "lr";

  $("#setsNone").style.display = lr ? "none" : "";
  $("#setsLR").style.display = lr ? "" : "none";

  if(lr){
    const L = (cell.sets||[]).filter(s=>s.side==="L").map(s=>s.reps).filter(x=>x>0).join(",");
    const R = (cell.sets||[]).filter(s=>s.side==="R").map(s=>s.reps).filter(x=>x>0).join(",");
    $("#setsInputL").value = L;
    $("#setsInputR").value = R;
  }else{
    const reps = (cell.sets||[]).map(s=>s.reps).filter(x=>x>0).join(",");
    $("#setsInput").value = reps;
  }

  $("#injuryFlag").checked = !!cell?.injury?.flag;
  $("#injuryNote").value = cell?.injury?.note || "";

  showSheet($("#sheet"));
}
function closeCellEditor(){ editing=null; hideSheet($("#sheet")); }

function toast(msg, undoFn=null){
  $("#toastMsg").textContent = msg;
  $("#toast").classList.add("show");

  const undoBtn = $("#toastUndo");
  undoBtn.style.display = undoFn ? "" : "none";
  undoBtn.onclick = undoFn ? ()=>{
    undoFn();
    $("#toast").classList.remove("show");
  } : null;

  $("#toastClose").onclick = ()=> $("#toast").classList.remove("show");
}

/* ---------- CRUD Trainings ---------- */
function addTraining(){
  const date = prompt("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–î–î.–ú–ú.–ì–ì–ì–ì):", "");
  if(date === null) return;
  const p = parseDateDDMMYYYY(date);
  if(!p){
    alert("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞. –§–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–æ–π.");
    return;
  }
  const t = { id: uid("t"), date: date.trim(), createdAt: Date.now() };
  state.trainings.push(t);
  selectedTrainingId = t.id; // newly created becomes selected
  markDirty();
  renderAll();
}

function deleteTraining(tid){
  const t = state.trainings.find(x=>x.id===tid);
  if(!t) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ${t.date}?\n–ï—ë –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.`)) return;

  const rec = state.records?.[tid] ? deepClone(state.records[tid]) : {};
  state.trainings = state.trainings.filter(x=>x.id!==tid);
  if(state.records?.[tid]) delete state.records[tid];

  state.trash.trainings.unshift({
    deletedAt: Date.now(),
    training: deepClone(t),
    records: rec
  });
  state.trash.trainings = state.trash.trainings.slice(0, 50);

  // fix selection
  if(selectedTrainingId === tid) selectedTrainingId = "";
  ensureSelectedTraining();

  markDirty();
  renderAll();

  toast(`–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ${t.date} —É–¥–∞–ª–µ–Ω–∞.`, ()=>{
    restoreTrainingFromTrash(0);
  });
}

function restoreTrainingFromTrash(index){
  const item = state.trash.trainings[index];
  if(!item) return;

  const tid = item.training.id;
  if(state.trainings.some(x=>x.id===tid)){
    item.training.id = uid("t");
  }

  state.trainings.push(item.training);
  state.records[item.training.id] ||= item.records || {};
  state.trash.trainings.splice(index, 1);

  selectedTrainingId = item.training.id;

  markDirty();
  renderAll();
}

/* ---------- CRUD Blocks/Exercises/Weights ---------- */
function addBlock(){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ (–±—É–¥–µ—Ç –≤ –í–ï–†–•–ù–ï–ú –†–ï–ì–ò–°–¢–†–ï):", "");
  if(!name) return;
  state.blocks.push({
    id: uid("b"),
    name: name.trim().toUpperCase(),
    archived:false,
    order: (state.blocks.length+1)*100,
    exercises:[]
  });
  markDirty();
  renderAll();
}
function renameBlock(blockId){
  const b = getBlock(blockId);
  if(!b) return;
  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞:", b.name);
  if(!name) return;
  b.name = name.trim().toUpperCase();
  markDirty();
  renderAll();
}
function toggleArchiveBlock(blockId){
  const b = getBlock(blockId);
  if(!b) return;
  b.archived = !b.archived;
  markDirty();
  renderAll();
}
function blockHasHistory(block){
  for(const t of state.trainings){
    for(const e of block.exercises){
      for(const w of e.weights){
        const c = getCell(t.id, e.id, w.id);
        if(c && !isCellEmpty(c)) return true;
      }
    }
  }
  return false;
}
function deleteBlock(blockId){
  const b = getBlock(blockId);
  if(!b) return;

  const hasAnyData = blockHasHistory(b);
  if(hasAnyData){
    const ok = confirm(`–í –±–ª–æ–∫–µ "${b.name}" –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è.\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å.\n\n–£–¥–∞–ª–∏—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ?`);
    if(!ok) return;
  }else{
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫ "${b.name}"?`)) return;
  }

  const exIds = b.exercises.map(e=>e.id);
  for(const tid of Object.keys(state.records)){
    for(const exId of exIds){
      if(state.records[tid]?.[exId]) delete state.records[tid][exId];
    }
    if(Object.keys(state.records[tid]).length===0) delete state.records[tid];
  }

  state.blocks = state.blocks.filter(x=>x.id!==blockId);
  markDirty();
  renderAll();
}

function addExercise(){
  const blocks = state.blocks.filter(b=>!b.archived);
  if(blocks.length===0){ alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–ª–æ–∫."); return; }
  const blockName = prompt("–í –∫–∞–∫–æ–π –±–ª–æ–∫ –¥–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ)", blocks[0].name);
  if(!blockName) return;
  const b = blocks.find(x => (x.name||"").toUpperCase() === blockName.trim().toUpperCase());
  if(!b){ alert("–ë–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞."); return; }

  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (—Å—Ç—Ä–æ—á–Ω—ã–º–∏):", "");
  if(!name) return;

  const lr = confirm("–ù—É–∂–Ω–æ –ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å L/R?\nOK = –¥–∞, Cancel = –Ω–µ—Ç");

  b.exercises.push({
    id: uid("e"),
    name: name.trim().toLowerCase(),
    lrMode: lr ? "lr" : "none",
    weights: []
  });
  markDirty();
  renderAll();
}

function addWeight(){
  const exList = listAllExercises().filter(x=>!x.block.archived);
  if(exList.length===0){ alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ."); return; }
  const pick = prompt("–î–ª—è –∫–∞–∫–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–∏—Ç—å –≤–µ—Å?\n–§–æ—Ä–º–∞—Ç: –ë–õ–û–ö ¬∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ", exList[0].block.name+" ¬∑ "+exList[0].exercise.name);
  if(!pick) return;
  const norm = pick.split("¬∑").map(s=>s.trim());
  if(norm.length<2){ alert("–§–æ—Ä–º–∞—Ç: –ë–õ–û–ö ¬∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"); return; }
  const bn = norm[0].toUpperCase();
  const en = norm.slice(1).join("¬∑").trim().toLowerCase();

  const found = exList.find(x => x.block.name.toUpperCase()===bn && x.exercise.name.toLowerCase()===en);
  if(!found){ alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ."); return; }

  const valStr = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å (–∫–≥), —á–∏—Å–ª–æ:", "60");
  if(valStr===null) return;
  const val = Number(valStr.replace(",", "."));
  if(!Number.isFinite(val) || val<=0){ alert("–í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0."); return; }

  found.exercise.weights.push({ id: uid("w"), value: val, hidden:false });
  found.exercise.weights.sort((a,b)=>(a.value||0)-(b.value||0));
  markDirty();
  renderAll();
}

/* ---------- Export/Import/Copy ---------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `gym-progress-${formatNowStamp()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
}
async function copyJSON(){
  const txt = JSON.stringify(state);
  try{
    await navigator.clipboard.writeText(txt);
    toast("JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.");
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); toast("JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback)."); }
    catch(_){ alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≠–∫—Å–ø–æ—Ä—Ç JSON."); }
    ta.remove();
  }
}
async function importFromFile(file){
  const text = await file.text();
  importFromText(text);
}
function validateState(obj){
  if(!obj || typeof obj!=="object") return "–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON-–æ–±—ä–µ–∫—Ç–æ–º.";
  if(obj.version !== 1) return "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö.";
  if(!Array.isArray(obj.trainings) || !Array.isArray(obj.blocks) || typeof obj.records!=="object") return "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ –Ω–µ–≤–µ—Ä–Ω–∞.";
  return null;
}
function importFromText(text){
  let obj;
  try{ obj = JSON.parse(text); }
  catch(e){ alert("JSON –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω."); return; }

  const err = validateState(obj);
  if(err){ alert("–ò–º–ø–æ—Ä—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω: " + err); return; }

  if(!confirm("–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.\n–ü–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≠–∫—Å–ø–æ—Ä—Ç.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;

  state = obj;
  dirty = true;
  selectedTrainingId = "";
  applyTheme();
  renderAll();
  saveNow("import");
  toast("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.");
}

/* ---------- Settings ---------- */
function openSettings(){
  $("#settingRecordMetric").value = state.settings.recordMetric;
  $("#settingGoalStrategy").value = state.settings.goalStrategy;
  $("#settingProgressMetric").value = state.settings.progressMetric;
  $("#settingHideEmpty").checked = !!state.settings.hideEmptyRows;
  showSheet($("#settingsSheet"));
}
function saveSettings(){
  state.settings.recordMetric = $("#settingRecordMetric").value;
  state.settings.goalStrategy = $("#settingGoalStrategy").value;
  state.settings.progressMetric = $("#settingProgressMetric").value;
  state.settings.hideEmptyRows = !!$("#settingHideEmpty").checked;
  markDirty();
  renderAll();
  hideSheet($("#settingsSheet"));
}

/* ---------- Trash ---------- */
function openTrash(){
  renderTrashList();
  showSheet($("#trashSheet"));
}
function renderTrashList(){
  const el = $("#trashList");
  const list = state.trash.trainings || [];
  if(list.length===0){
    el.innerHTML = `<div class="hint">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</div>`;
    return;
  }
  el.innerHTML = `
    <div class="hint" style="margin-bottom:10px">–•—Ä–∞–Ω–∏—Ç—Å—è –¥–æ 50 —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</div>
    ${list.map((x, idx)=>{
      const d = new Date(x.deletedAt||Date.now()).toLocaleString();
      return `
        <div class="panel" style="margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:900">${escapeHtml(x.training?.date || "‚Äî")}</div>
              <div class="hint">–£–¥–∞–ª–µ–Ω–æ: ${escapeHtml(d)}</div>
            </div>
            <button class="btn primary" data-restore="${idx}">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
      `;
    }).join("")}
  `;
  $$("button[data-restore]", el).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.dataset.restore);
      restoreTrainingFromTrash(idx);
      renderTrashList();
    });
  });
}

/* ---------- Cell editor save ---------- */
function parseSetsCSV(s){
  if(!s) return [];
  return s.split(",")
    .map(x=>x.trim())
    .filter(Boolean)
    .map(x=>Number(x.replace(",", ".")))
    .filter(n=>Number.isFinite(n) && n>0)
    .map(n=>Math.round(n));
}
function saveCellFromEditor(){
  if(!editing) return;
  const { tid, exId, wId } = editing;
  const ex = getExercise(exId);
  const lr = ex?.lrMode === "lr";

  const injuryFlag = !!$("#injuryFlag").checked;
  const injuryNote = ($("#injuryNote").value || "").trim();

  let sets = [];
  if(lr){
    const L = parseSetsCSV($("#setsInputL").value);
    const R = parseSetsCSV($("#setsInputR").value);
    sets = [
      ...L.map(reps=>({reps, side:"L"})),
      ...R.map(reps=>({reps, side:"R"}))
    ];
  }else{
    const reps = parseSetsCSV($("#setsInput").value);
    sets = reps.map(reps=>({reps, side:""}));
  }

  if(sets.length===0 && !injuryFlag && !injuryNote){
    clearCell(tid, exId, wId);
    closeCellEditor();
    renderAll();
    return;
  }

  setCell(tid, exId, wId, {
    sets,
    injury: { flag: injuryFlag, note: injuryNote }
  });

  closeCellEditor();
  renderAll();
}
function clearCellFromEditor(){
  if(!editing) return;
  const { tid, exId, wId } = editing;
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å —è—á–µ–π–∫—É (—É–¥–∞–ª–∏—Ç—å —Å–µ—Ç—ã –∏ –æ—Ç–º–µ—Ç–∫—É —Ç—Ä–∞–≤–º—ã)?")) return;
  clearCell(tid, exId, wId);
  closeCellEditor();
  renderAll();
}

/* ---------- Bind UI ---------- */
function bindUI(){
  $("#btnAddTraining").addEventListener("click", addTraining);
  $("#btnExport").addEventListener("click", exportJSON);
  $("#btnCopy").addEventListener("click", copyJSON);

  $("#fileImport").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    e.target.value = "";
    if(!f) return;
    try{ await importFromFile(f); }
    catch(err){ alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª."); }
  });

  $("#btnTheme").addEventListener("click", ()=>{
    state.settings.theme = state.settings.theme === "dark" ? "light" : "dark";
    applyTheme();
    markDirty();
  });

  $("#btnSettings").addEventListener("click", openSettings);
  $("#btnSaveSettings").addEventListener("click", saveSettings);
  $("#btnCloseSettings").addEventListener("click", ()=> hideSheet($("#settingsSheet")));

  $("#btnAddBlock").addEventListener("click", addBlock);
  $("#btnAddExercise").addEventListener("click", addExercise);
  $("#btnAddWeight").addEventListener("click", addWeight);

  $("#searchInput").addEventListener("input", ()=> renderAll());
  $("#btnToggleEmpty").addEventListener("click", ()=>{
    state.settings.hideEmptyRows = !state.settings.hideEmptyRows;
    markDirty();
    renderAll();
  });

  $("#exerciseSelect").addEventListener("change", ()=>{
    drawExerciseChart();
    buildAnalyticsHints();
  });

  $("#btnCloseSheet").addEventListener("click", closeCellEditor);
  $("#btnCancelCell").addEventListener("click", closeCellEditor);
  $("#btnSaveCell").addEventListener("click", saveCellFromEditor);
  $("#btnClearCell").addEventListener("click", clearCellFromEditor);

  $("#backdrop").addEventListener("click", ()=>{
    if($("#sheet").classList.contains("show")) closeCellEditor();
    if($("#settingsSheet").classList.contains("show")) hideSheet($("#settingsSheet"));
    if($("#trashSheet").classList.contains("show")) hideSheet($("#trashSheet"));
  });

  $("#toastClose").addEventListener("click", ()=> $("#toast").classList.remove("show"));

  $("#btnTrash").addEventListener("click", openTrash);
  $("#btnCloseTrash").addEventListener("click", ()=> hideSheet($("#trashSheet")));

  window.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){
      if($("#sheet").classList.contains("show")) closeCellEditor();
      if($("#settingsSheet").classList.contains("show")) hideSheet($("#settingsSheet"));
      if($("#trashSheet").classList.contains("show")) hideSheet($("#trashSheet"));
      $("#toast").classList.remove("show");
    }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault();
      exportJSON();
    }
  });
}
</script>
</body>
</html>
