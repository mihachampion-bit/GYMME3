<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gym Progress ‚Äî offline</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --card:#f8fafc; --card2:#f1f5f9;
      --accent:#2563eb; --danger:#dc2626;
      --shadow: 0 10px 30px rgba(2,6,23,.08);

      --stickyBg: rgba(255,255,255,.92);

      --gold:#f59e0b;     /* —Ä–µ–∫–æ—Ä–¥ */
      --green:#22c55e;    /* –Ω–æ–≤—ã–π –≤–µ—Å */
      --yellow:#eab308;   /* –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ */
      --grayFill:#f1f5f9; /* –Ω–µ —Ä–µ–∫–æ—Ä–¥ */
      --injuryFill:#ffe4f1; /* —Ç—Ä–∞–≤–º–∞ (—Ä–æ–∑–æ–≤—ã–π) */

      --radius:16px;
      --rowH: 44px;
      --leftW: 132px; /* —É–∑–∫–æ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å 2 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ */
    }
    [data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#9aa7bd; --line:#1f2a44;
      --card:#0f172a; --card2:#111c33;
      --accent:#60a5fa; --danger:#f87171;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --stickyBg: rgba(11,18,32,.88);

      --grayFill:#101a31;
      --injuryFill:#3a1530;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    button,input,select{font:inherit}
    .app{
      min-height:100%;
      display:flex; flex-direction:column;
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: var(--stickyBg);
      border-bottom:1px solid var(--line);
      padding: 10px 12px calc(10px + env(safe-area-inset-top));
    }
    .topbar .row{
      display:flex; align-items:center; gap:10px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width: 0;
    }
    .brand b{font-weight:800; letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .spacer{flex:1}
    .btn{
      border:1px solid var(--line);
      background: var(--card);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 12px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: none;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: transparent;
      background: var(--accent);
      color: white;
    }
    .btn.icon{
      width:42px; justify-content:center; padding:10px;
    }
    .seg{
      display:flex; gap:6px; padding:6px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
    }
    .seg button{
      border:0; background:transparent; color:var(--muted);
      padding:8px 10px; border-radius: 10px;
      cursor:pointer;
    }
    .seg button.active{
      background: var(--card2);
      color: var(--fg);
      font-weight:700;
    }

    .content{flex:1; display:flex; flex-direction:column; min-height:0}
    .view{flex:1; min-height:0; display:none}
    .view.active{display:flex; flex-direction:column; min-height:0}

    /* TABLE */
    .tableWrap{
      flex:1; min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 0;
    }
    table{
      border-collapse: separate;
      border-spacing: 0;
      width:max-content;
      min-width: 100%;
    }
    th, td{
      border-bottom: 1px solid var(--line);
      border-right: 1px solid var(--line);
      height: var(--rowH);
      padding: 6px 8px;
      vertical-align: middle;
      background: var(--bg);
      white-space: nowrap;
    }
    th{
      position: sticky; top: 0; z-index: 5;
      background: var(--stickyBg);
      backdrop-filter: blur(10px);
      font-weight: 800;
    }
    th:first-child, td:first-child{
      border-left: 1px solid var(--line);
    }
    tr:first-child th{
      border-top: 1px solid var(--line);
    }

    .stickyLeft{
      position: sticky; left: 0; z-index: 8;
      background: var(--stickyBg);
      backdrop-filter: blur(10px);
      width: var(--leftW);
      min-width: var(--leftW);
      max-width: var(--leftW);
      border-right: 1px solid var(--line);
    }
    th.stickyLeft{z-index: 12}
    .corner{
      z-index: 20 !important;
    }

    .leftCell{
      display:flex; align-items:center; gap:8px;
      min-width: 0;
    }
    .leftText{
      min-width:0; overflow:hidden; text-overflow: ellipsis;
    }
    .blockRow .leftText{
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: .8px;
    }
    .exRow .leftText{
      font-weight: 800;
      text-transform: lowercase;
      padding-left: 10px;
    }
    .wRow .leftText{
      font-weight: 500;
      text-transform: lowercase;
      padding-left: 22px;
      color: var(--muted);
    }
    .wRow .sideTag{
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: var(--card);
      flex: 0 0 auto;
    }

    .tinyIcon{
      border:0; background:transparent; color:var(--muted);
      padding:6px; margin:-6px;
      cursor:pointer;
    }
    .tinyIcon:active{transform: translateY(1px)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--muted);
      font-size: 12px;
    }

    td.cell{
      position: relative;
      cursor: pointer;
      background: var(--bg);
      min-width: 96px;
      max-width: 120px;
    }
    td.cell .val{
      font-weight: 800;
      font-size: 13px;
      line-height: 1.1;
    }
    td.cell .sub{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      overflow:hidden; text-overflow: ellipsis;
    }
    td.cell.empty .val{color: var(--muted); font-weight: 700}
    td.cell.empty .sub{display:none}

    /* statuses */
    td.cell.gray{ background: var(--grayFill); }
    td.cell.injury{ background: var(--injuryFill); }
    td.cell.border-gold{ box-shadow: inset 0 0 0 2px var(--gold); }
    td.cell.border-green{ box-shadow: inset 0 0 0 2px var(--green); }
    td.cell.border-yellow{ box-shadow: inset 0 0 0 2px var(--yellow); }

    /* header date cell controls */
    .dateHead{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .dateHead .d{font-weight:900}
    .dateHead .trash{
      border:0; background:transparent; color:var(--muted);
      cursor:pointer; padding:6px; margin:-6px; border-radius:10px;
    }
    .dateHead .trash:active{transform: translateY(1px)}
    .hintRow{
      padding: 0 12px 12px;
      display:flex; align-items:center; gap:8px; flex-wrap: wrap;
      color: var(--muted);
    }

    /* Drawer */
    .overlay{
      position:fixed; inset:0; background: rgba(2,6,23,.35);
      display:none; z-index:100;
    }
    .overlay.show{display:block}
    .drawer{
      position:fixed; top:0; right:0; bottom:0;
      width:min(92vw, 420px);
      background: var(--bg);
      border-left: 1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:110;
      display:flex; flex-direction:column;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .drawer.show{transform: translateX(0)}
    .drawer header{
      display:flex; align-items:center; gap:10px;
      padding: 6px 2px 10px;
      border-bottom:1px solid var(--line);
    }
    .drawer header b{font-size:16px}
    .drawer .body{flex:1; overflow:auto; padding-top: 10px}
    .section{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      margin-bottom: 10px;
    }
    .section h3{
      margin:0 0 8px 0; font-size: 13px; text-transform: uppercase;
      letter-spacing: .8px; color: var(--muted);
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:8px}
    .field label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="number"], select{
      border:1px solid var(--line);
      background: var(--bg);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 10px;
      outline:none;
    }
    .rowActions{display:flex; gap:8px; flex-wrap: wrap}
    .danger{border-color: rgba(220,38,38,.35); color: var(--danger); background: transparent}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; background: rgba(2,6,23,.38);
      display:none; z-index:200;
      padding: 12px;
    }
    .modalOverlay.show{display:flex; align-items:center; justify-content:center}
    .modal{
      width:min(96vw, 520px);
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      padding: 12px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: var(--card);
    }
    .modal header b{font-size: 14px}
    .modal main{padding: 12px}
    .modal footer{
      padding: 12px;
      border-top: 1px solid var(--line);
      display:flex; gap:8px; justify-content:flex-end;
      background: var(--card);
    }
    .sets{
      display:flex; flex-direction:column; gap:8px;
      margin: 8px 0 10px;
    }
    .setRow{
      display:flex; gap:8px; align-items:center;
    }
    .setRow input{flex:1}
    .setRow button{
      width: 42px;
    }
    .toggleLine{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
      margin-top: 8px;
    }
    .toggleLine .left{display:flex; align-items:center; gap:10px}
    .badge{
      font-size:12px; padding: 4px 8px; border-radius:999px; border:1px solid var(--line);
      background: var(--bg); color: var(--muted);
    }

    /* Analytics */
    .analyticsWrap{
      padding: 12px;
      display:flex; flex-direction:column; gap:10px;
      min-height:0;
    }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      padding: 10px;
    }
    .panel h3{
      margin:0 0 8px 0; font-size: 13px; text-transform: uppercase; letter-spacing:.8px; color: var(--muted);
    }
    canvas{
      width:100%; height: 180px;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 14px;
      display:block;
    }
    .insights{
      display:flex; flex-direction:column; gap:8px;
      color: var(--fg);
    }
    .insights .muted{color:var(--muted); font-size:12px}
    .kpiRow{display:flex; gap:8px; flex-wrap:wrap}
    .kpi{
      flex:1; min-width: 130px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--bg);
      padding: 10px;
    }
    .kpi b{display:block; font-size:16px}
    .kpi small{color:var(--muted)}
    .legendLine{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .dot{width:10px; height:10px; border-radius:3px; border:2px solid transparent; display:inline-block}
    .dot.gold{border-color: var(--gold)}
    .dot.green{border-color: var(--green)}
    .dot.yellow{border-color: var(--yellow)}
    .dot.gray{background: var(--grayFill); border-color: var(--line)}
    .dot.pink{background: var(--injuryFill); border-color: var(--line)}
    .helpLink{
      text-decoration:none; color: var(--accent); font-weight:700;
    }

    /* small screens */
    @media (max-width: 380px){
      :root{ --leftW: 120px; --rowH: 42px; }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="row">
      <button class="btn icon" id="btnMenu" aria-label="–ú–µ–Ω—é">‚ò∞</button>
      <div class="brand">
        <b>Gym Progress</b>
        <small id="subTitle">offline ‚Ä¢ —Ç–∞–±–ª–∏—Ü–∞</small>
      </div>

      <div class="spacer"></div>

      <div class="seg" role="tablist" aria-label="–≠–∫—Ä–∞–Ω—ã">
        <button id="tabTable" class="active" role="tab" aria-selected="true">–¢–∞–±–ª–∏—Ü–∞</button>
        <button id="tabAnalytics" role="tab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>

      <button class="btn primary" id="btnAddWorkout">+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
      <button class="btn icon" id="btnHelp" aria-label="–õ–µ–≥–µ–Ω–¥–∞">?</button>
    </div>
  </div>

  <div class="content">
    <div class="hintRow" id="hintRow">
      <span class="pill">–¢–∞–ø –ø–æ —è—á–µ–π–∫–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
      <span class="pill">Long-press –ø–æ –¥–∞—Ç–µ (~0.7s) ‚Üí —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </div>

    <section class="view active" id="viewTable" aria-label="–¢–∞–±–ª–∏—Ü–∞">
      <div class="tableWrap" id="tableWrap"></div>
    </section>

    <section class="view" id="viewAnalytics" aria-label="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞">
      <div class="analyticsWrap">
        <div class="panel">
          <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
          <div class="grid2">
            <div class="field">
              <label>–ë–ª–æ–∫</label>
              <select id="anBlock"></select>
            </div>
            <div class="field">
              <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
              <select id="anExercise"></select>
            </div>
          </div>
          <div class="field" style="margin-bottom:0">
            <label>–ú–µ—Ç—Ä–∏–∫–∞</label>
            <select id="anMetric">
              <option value="volume">–û–±—ä—ë–º (sets √ó reps √ó weight)</option>
              <option value="reps">–ü–æ–≤—Ç–æ—Ä—ã (—Å—É–º–º–∞ reps)</option>
              <option value="records">–†–µ–∫–æ—Ä–¥—ã (–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)</option>
              <option value="injuries">–¢—Ä–∞–≤–º—ã (–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)</option>
            </select>
          </div>
        </div>

        <div class="panel">
          <h3>–ì—Ä–∞—Ñ–∏–∫</h3>
          <canvas id="chart" width="800" height="360"></canvas>
          <div class="legendLine" style="margin-top:8px; color:var(--muted); font-size:12px">
            <span>–ü—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫. –ú–∞—Å—à—Ç–∞–± –∞–≤—Ç–æ.</span>
          </div>
        </div>

        <div class="panel">
          <h3>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
          <div class="kpiRow" id="kpiRow"></div>
          <div class="insights" id="insights" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Drawer -->
<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer" aria-label="–ú–µ–Ω—é">
  <header>
    <b>–ú–µ–Ω—é</b>
    <div class="spacer"></div>
    <button class="btn icon" id="btnCloseDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
  </header>

  <div class="body">
    <div class="section">
      <h3>–¢–µ–º–∞</h3>
      <div class="toggleLine">
        <div class="left">
          <span class="badge">üåô</span>
          <div>
            <b style="display:block">–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</b>
            <small style="color:var(--muted)">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</small>
          </div>
        </div>
        <button class="btn" id="btnTheme">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>

    <div class="section">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
      <div class="field">
        <label>–ë–ª–æ–∫</label>
        <select id="selBlockAddEx"></select>
      </div>
      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ö–æ—á–µ—à—å)</label>
        <input id="inExName" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∂–∏–º –ª—ë–∂–∞" />
      </div>
      <div class="rowActions">
        <button class="btn primary" id="btnAddExercise">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:12px">
        –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏, –Ω–æ –∏—Å—Ç–æ—Ä–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.
      </div>
    </div>

    <div class="section">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</h3>
      <div class="field">
        <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
        <select id="selExAddWeight"></select>
      </div>
      <div class="field">
        <label>–í–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 40 –∏–ª–∏ 60-50)</label>
        <input id="inWeightLabel" type="text" placeholder="40" />
      </div>
      <div class="rowActions">
        <button class="btn primary" id="btnAddWeight">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:12px">
        –í–µ—Å–∞ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é. ‚Äú60-50‚Äù —Å—Ç–∞–≤–∏—Ç—Å—è –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —á–∏—Å–ª—É (60).
      </div>
    </div>

    <div class="section">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
      <div class="field">
        <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
        <select id="selManageExercise"></select>
      </div>

      <div class="toggleLine" style="margin-top:0">
        <div class="left">
          <span class="badge">L/R</span>
          <div>
            <b style="display:block">Split L/R</b>
            <small style="color:var(--muted)">–†–∞–∑–¥–µ–ª—å–Ω—ã–π –≤–≤–æ–¥</small>
          </div>
        </div>
        <button class="btn" id="btnToggleSplit">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">üóÑÔ∏è</span>
          <div>
            <b style="display:block">–ê—Ä—Ö–∏–≤</b>
            <small style="color:var(--muted)">–°–∫—Ä—ã—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ (–Ω–µ —É–¥–∞–ª—è—Ç—å)</small>
          </div>
        </div>
        <button class="btn" id="btnToggleArchive">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div style="margin-top:10px">
        <div style="font-size:12px; color:var(--muted); margin-bottom:6px">–í–µ—Å–∞ (–ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç—å)</div>
        <div id="weightsList"></div>
      </div>

      <div style="margin-top:12px" class="rowActions">
        <button class="btn danger" id="btnDeleteExercise">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞‚Ä¶</button>
      </div>
      <div style="margin-top:6px; color:var(--muted); font-size:12px">
        –£–¥–∞–ª–µ–Ω–∏–µ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é. –ê—Ä—Ö–∏–≤ –æ–±—ã—á–Ω–æ –ª—É—á—à–µ.
      </div>
    </div>

    <div class="section">
      <h3>–î–∞–Ω–Ω—ã–µ</h3>
      <div class="rowActions">
        <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON</button>
        <button class="btn danger" id="btnReset">–°–±—Ä–æ—Å (seed)</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:12px">
        –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ LocalStorage. –ò–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.
      </div>
    </div>
  </div>
</aside>

<!-- Cell editor modal -->
<div class="modalOverlay" id="cellModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–†–µ–¥–∞–∫—Ç–æ—Ä">
    <header>
      <div>
        <b id="cellTitle">–Ø—á–µ–π–∫–∞</b><br/>
        <small id="cellSubtitle" style="color:var(--muted)"></small>
      </div>
      <button class="btn icon" id="btnCloseCellModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>
    <main>
      <div class="sets" id="setsWrap"></div>
      <div class="rowActions">
        <button class="btn" id="btnAddSet">+ —Å–µ—Ç</button>
        <button class="btn" id="btnClearSets">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">ü©π</span>
          <div>
            <b style="display:block">–¢—Ä–∞–≤–º–∞</b>
            <small style="color:var(--muted)">–†–æ–∑–æ–≤—ã–π —Ñ–æ–Ω, –Ω–æ —Å—Ç–∞—Ç—É—Å–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</small>
          </div>
        </div>
        <button class="btn" id="btnToggleInjury">–í—ã–∫–ª</button>
      </div>
    </main>
    <footer>
      <button class="btn" id="btnCancelCell">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveCell">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </footer>
  </div>
</div>

<!-- Stats / Help modal (shared) -->
<div class="modalOverlay" id="infoModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–ò–Ω—Ñ–æ">
    <header>
      <b id="infoTitle">–ò–Ω—Ñ–æ</b>
      <button class="btn icon" id="btnCloseInfoModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>
    <main id="infoBody"></main>
    <footer>
      <button class="btn primary" id="btnCloseInfoModal2">–û–∫</button>
    </footer>
  </div>
</div>

<script>
/* ===========================
   –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã + —É—Ç–∏–ª–∏—Ç—ã
=========================== */
const LS_KEY = "gymProgress.v1";
const DEFAULT_BLOCKS = ["–ì–†–£–î–¨","–ë–ò–¶–ï–ü–°","–°–ü–ò–ù–ê","–î–ï–õ–¨–¢–´","–ù–û–ì–ò"];

const STATUS = {
  RECORD: "record",
  NEW_WEIGHT: "new_weight",
  NEW_EX: "new_ex",
  NOT_RECORD: "not_record",
};

const nowId = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
const clampInt = (v) => {
  const n = parseInt(String(v||"").trim(), 10);
  return Number.isFinite(n) && n>=0 ? n : null;
};

function parseDDMMYYYY(s){
  if(!s) return null;
  const m = String(s).trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yyyy = +m[3];
  const d = new Date(yyyy, mm-1, dd);
  if(d.getFullYear()!==yyyy || (d.getMonth()+1)!==mm || d.getDate()!==dd) return null;
  return d;
}
function fmtDate(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function sortWorkoutsAsc(workouts){
  return [...workouts].sort((a,b)=>{
    const da = parseDDMMYYYY(a.date), db = parseDDMMYYYY(b.date);
    const ta = da?da.getTime():0, tb = db?db.getTime():0;
    return ta-tb;
  });
}
/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: —Å–∞–º–∞—è —Å–≤–µ–∂–∞—è —Å–ª–µ–≤–∞ */
function sortWorkoutsDesc(workouts){
  return [...workouts].sort((a,b)=>{
    const da = parseDDMMYYYY(a.date), db = parseDDMMYYYY(b.date);
    const ta = da?da.getTime():0, tb = db?db.getTime():0;
    return tb-ta;
  });
}

/* –í–µ—Å: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —á–∏—Å–ª—É –∏–∑ —Å—Ç—Ä–æ–∫–∏.
   –ü—Ä–∏–º–µ—Ä "60-50" -> 60. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∏ –∑–∞–ø—è—Ç—ã—Ö. */
function weightMaxNumber(label){
  const s = String(label||"").trim();
  const nums = s.match(/(\d+(?:[.,]\d+)?)/g);
  if(!nums) return Number.POSITIVE_INFINITY; // —ç–∫–∑–æ—Ç–∏–∫–∞: —É–ª–µ—Ç–∞–µ—Ç –≤–Ω–∏–∑
  let max = -Infinity;
  for(const t of nums){
    const n = parseFloat(t.replace(",","."));
    if(Number.isFinite(n)) max = Math.max(max,n);
  }
  return Number.isFinite(max) ? max : Number.POSITIVE_INFINITY;
}

/* ===========================
   –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
=========================== */
/*
state = {
  theme: "light"|"dark",
  blocks: [
    {id,name,collapsed:false, exercises:[
      {id,name, archived:false, splitLR:false, weights:[
        {id,label, hidden:false}
      ]}
    ]}
  ],
  workouts: [{id,date}],
  entries: {
    [workoutId]: {
      [exerciseId]: {
        [weightId]: {
          // –µ—Å–ª–∏ splitLR=false:
          sets:[number], injury:boolean
          // –µ—Å–ª–∏ splitLR=true:
          L:{sets:[number], injury:boolean}, R:{sets:[number], injury:boolean}
        }
      }
    }
  }
}
*/
function seedState(){
  const mkW = (label) => ({id: nowId(), label, hidden:false});
  const mkE = (name, weights, splitLR=false) => ({
    id: nowId(), name, archived:false, splitLR,
    weights: weights.map(mkW)
  });
  const mkB = (name, exs) => ({id: nowId(), name, collapsed:false, exercises: exs});

  const w1 = {id: nowId(), date:"02.01.2026"};
  const w2 = {id: nowId(), date:"05.01.2026"};
  const w3 = {id: nowId(), date:"06.01.2026"};

  const chest = mkB("–ì–†–£–î–¨", [
    mkE("–∂–∏–º –ª—ë–∂–∞", ["40","50","60-50"]),
    mkE("—Ä–∞–∑–≤–æ–¥–∫–∞", ["10","12.5"])
  ]);
  const biceps = mkB("–ë–ò–¶–ï–ü–°", [
    mkE("–ø–æ–¥—ä—ë–º –Ω–∞ –±–∏—Ü–µ–ø—Å", ["10","12.5"], true)
  ]);
  const back = mkB("–°–ü–ò–ù–ê", [
    mkE("—Ç—è–≥–∞ –≤ –Ω–∞–∫–ª–æ–Ω–µ", ["40","50"])
  ]);
  const delts = mkB("–î–ï–õ–¨–¢–´", [
    mkE("–∂–∏–º —Å—Ç–æ—è", ["20","25"])
  ]);
  const legs = mkB("–ù–û–ì–ò", [
    mkE("–ø—Ä–∏—Å–µ–¥", ["40","60"])
  ]);

  const state = {
    theme: "light",
    blocks: [chest,biceps,back,delts,legs],
    workouts: [w1,w2,w3],
    entries: {}
  };

  // –ø—Ä–∏–º–µ—Ä—ã –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  // –∂–∏–º –ª—ë–∂–∞ 40: 10,10; 50: 8,8; 60-50: –ø—É—Å—Ç–æ
  const exBench = chest.exercises[0];
  const w40 = exBench.weights.find(x=>x.label==="40").id;
  const w50 = exBench.weights.find(x=>x.label==="50").id;

  state.entries[w1.id] = {
    [exBench.id]: {
      [w40]: {sets:[10,10], injury:false},
      [w50]: {sets:[8,8], injury:false}
    }
  };
  state.entries[w2.id] = {
    [exBench.id]: {
      [w40]: {sets:[11,10], injury:false}, // —Ä–µ–∫–æ—Ä–¥ –ø–æ —Å—É–º–º–µ (21 vs 20)
      [w50]: {sets:[8,8,7], injury:false}  // —Ä–µ–∫–æ—Ä–¥ –ø–æ —Å—É–º–º–µ (23 vs 16)
    }
  };

  const exCurl = biceps.exercises[0];
  const w10 = exCurl.weights.find(x=>x.label==="10").id;
  state.entries[w2.id][exCurl.id] = {
    [w10]: {
      L:{sets:[10,10], injury:false},
      R:{sets:[10,9], injury:false}
    }
  };

  state.workouts = sortWorkoutsAsc(state.workouts);
  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤–µ—Å–∞ –≤ seed
  for(const b of state.blocks){
    for(const e of b.exercises){
      e.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
    }
  }
  return state;
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return seedState();
    const st = JSON.parse(raw);
    // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è / –∑–∞—â–∏—Ç–∞
    if(!st || !Array.isArray(st.blocks) || !Array.isArray(st.workouts) || typeof st.entries!=="object"){
      return seedState();
    }
    st.workouts = sortWorkoutsAsc(st.workouts);
    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª—è
    st.theme = st.theme==="dark" ? "dark" : "light";
    for(const b of st.blocks){
      b.collapsed = !!b.collapsed;
      b.exercises = b.exercises || [];
      for(const e of b.exercises){
        e.archived = !!e.archived;
        e.splitLR = !!e.splitLR;
        e.weights = e.weights || [];
        for(const w of e.weights) w.hidden = !!w.hidden;
        e.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
      }
    }
    return st;
  }catch(e){
    console.warn("loadState failed", e);
    return seedState();
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* ===========================
   –ì–ª–æ–±–∞–ª—å–Ω—ã–π state
=========================== */
let state = loadState();

/* ===========================
   DOM refs
=========================== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const tableWrap = $("#tableWrap");
const subTitle = $("#subTitle");

const viewTable = $("#viewTable");
const viewAnalytics = $("#viewAnalytics");
const tabTable = $("#tabTable");
const tabAnalytics = $("#tabAnalytics");

const overlay = $("#overlay");
const drawer = $("#drawer");

const cellModalOverlay = $("#cellModalOverlay");
const infoModalOverlay = $("#infoModalOverlay");

const anBlock = $("#anBlock");
const anExercise = $("#anExercise");
const anMetric = $("#anMetric");
const chart = $("#chart");
const kpiRow = $("#kpiRow");
const insights = $("#insights");

/* ===========================
   –†–æ—É—Ç–∏–Ω–≥ –≤–∫–ª–∞–¥–æ–∫
=========================== */
function setTab(name){
  const isTable = name==="table";
  viewTable.classList.toggle("active", isTable);
  viewAnalytics.classList.toggle("active", !isTable);

  tabTable.classList.toggle("active", isTable);
  tabAnalytics.classList.toggle("active", !isTable);
  tabTable.setAttribute("aria-selected", String(isTable));
  tabAnalytics.setAttribute("aria-selected", String(!isTable));

  subTitle.textContent = isTable ? "offline ‚Ä¢ —Ç–∞–±–ª–∏—Ü–∞" : "offline ‚Ä¢ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞";
  if(!isTable) renderAnalytics();
}
tabTable.addEventListener("click", ()=>setTab("table"));
tabAnalytics.addEventListener("click", ()=>setTab("analytics"));

/* ===========================
   –¢–µ–º–∞
=========================== */
function applyTheme(){
  document.documentElement.dataset.theme = state.theme === "dark" ? "dark" : "light";
}
applyTheme();

/* ===========================
   –û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å drawer
=========================== */
function openDrawer(){
  overlay.classList.add("show");
  drawer.classList.add("show");
  refreshMenuSelects();
}
function closeDrawer(){
  overlay.classList.remove("show");
  drawer.classList.remove("show");
}
$("#btnMenu").addEventListener("click", openDrawer);
$("#btnCloseDrawer").addEventListener("click", closeDrawer);
overlay.addEventListener("click", closeDrawer);

/* ===========================
   –•–µ–ª–ø (–ª–µ–≥–µ–Ω–¥–∞)
=========================== */
function showInfo(title, html){
  $("#infoTitle").textContent = title;
  $("#infoBody").innerHTML = html;
  infoModalOverlay.classList.add("show");
  infoModalOverlay.setAttribute("aria-hidden","false");
}
function closeInfo(){
  infoModalOverlay.classList.remove("show");
  infoModalOverlay.setAttribute("aria-hidden","true");
}
$("#btnHelp").addEventListener("click", ()=>{
  showInfo("–õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤", `
    <div style="display:flex; flex-direction:column; gap:10px">
      <div class="legendLine">
        <span class="dot gold"></span><b>–†–µ–∫–æ—Ä–¥</b><span style="color:var(--muted)">‚Äî –∑–æ–ª–æ—Ç–∞—è –æ–±–≤–æ–¥–∫–∞</span>
      </div>
      <div class="legendLine">
        <span class="dot green"></span><b>–ù–æ–≤—ã–π –≤–µ—Å</b><span style="color:var(--muted)">‚Äî –∑–µ–ª—ë–Ω–∞—è –æ–±–≤–æ–¥–∫–∞</span>
      </div>
      <div class="legendLine">
        <span class="dot yellow"></span><b>–ü–µ—Ä–≤—ã–π —Ä–∞–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</b><span style="color:var(--muted)">‚Äî –∂—ë–ª—Ç–∞—è –æ–±–≤–æ–¥–∫–∞</span>
      </div>
      <div class="legendLine">
        <span class="dot gray"></span><b>–ù–µ —Ä–µ–∫–æ—Ä–¥</b><span style="color:var(--muted)">‚Äî —Å–µ—Ä—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –±—ã–ª–∏ –ø—Ä–æ—à–ª—ã–µ –¥–∞–Ω–Ω—ã–µ)</span>
      </div>
      <div class="legendLine">
        <span class="dot pink"></span><b>–¢—Ä–∞–≤–º–∞</b><span style="color:var(--muted)">‚Äî —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–æ–±–≤–æ–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)</span>
      </div>
      <hr style="border:none; border-top:1px solid var(--line)">
      <div style="color:var(--muted); font-size:12px">
        <b>–¶–µ–ª—å ‚Äú–Ω–∞–¥–æ X‚Äù</b> –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—É—Å—Ç—ã—Ö —è—á–µ–π–∫–∞—Ö, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –ø–æ —ç—Ç–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é+–≤–µ—Å—É.
      </div>
    </div>
  `);
});
$("#btnCloseInfoModal").addEventListener("click", closeInfo);
$("#btnCloseInfoModal2").addEventListener("click", closeInfo);

/* ===========================
   –ú–µ–Ω—é: —Ç–µ–º–∞ + —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç/reset
=========================== */
$("#btnTheme").addEventListener("click", ()=>{
  state.theme = (state.theme==="dark") ? "light" : "dark";
  applyTheme();
  saveState();
});
$("#btnExport").addEventListener("click", ()=>{
  const json = JSON.stringify(state, null, 2);
  // –º–∏–Ω–∏-UX: –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å textarea –∏ –∞–≤—Ç–æ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  showInfo("–≠–∫—Å–ø–æ—Ä—Ç JSON", `
    <div style="display:flex; flex-direction:column; gap:10px">
      <div style="color:var(--muted); font-size:12px">–°–∫–æ–ø–∏—Ä—É–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –≥–¥–µ-–Ω–∏–±—É–¥—å. –≠—Ç–æ —Ç–≤–æ–π –±—ç–∫–∞–ø.</div>
      <textarea id="exportArea" style="width:100%; height:260px; padding:10px; border-radius:14px; border:1px solid var(--line); background:var(--bg); color:var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px"></textarea>
      <div class="rowActions">
        <button class="btn primary" id="btnCopyExport">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  `);
  setTimeout(()=>{
    const ta = $("#exportArea");
    if(ta){ ta.value = json; ta.focus(); ta.select(); }
    const btn = $("#btnCopyExport");
    if(btn){
      btn.addEventListener("click", ()=>{
        ta.select();
        document.execCommand("copy");
        btn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì";
        setTimeout(()=>btn.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 1200);
      });
    }
  },0);
});
$("#btnImport").addEventListener("click", ()=>{
  showInfo("–ò–º–ø–æ—Ä—Ç JSON", `
    <div style="display:flex; flex-direction:column; gap:10px">
      <div style="color:var(--muted); font-size:12px">
        –í—Å—Ç–∞–≤—å JSON. –ò–º–ø–æ—Ä—Ç <b>–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç</b> —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.
      </div>
      <textarea id="importArea" style="width:100%; height:260px; padding:10px; border-radius:14px; border:1px solid var(--line); background:var(--bg); color:var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px"></textarea>
      <div class="rowActions">
        <button class="btn danger" id="btnDoImport">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  `);
  setTimeout(()=>{
    const btn = $("#btnDoImport");
    const ta = $("#importArea");
    if(btn && ta){
      btn.addEventListener("click", ()=>{
        try{
          const obj = JSON.parse(ta.value);
          localStorage.setItem(LS_KEY, JSON.stringify(obj));
          state = loadState();
          applyTheme();
          renderAll();
          closeInfo();
          closeDrawer();
        }catch(e){
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: –ø—Ä–æ–≤–µ—Ä—å JSON.");
        }
      });
    }
  },0);
});
$("#btnReset").addEventListener("click", ()=>{
  if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å seed-–¥–∞–Ω–Ω—ã–µ?")){
    state = seedState();
    applyTheme();
    saveState();
    renderAll();
    closeDrawer();
  }
});

/* ===========================
   –î–∞–ª—å—à–µ ‚Äî —á–∞—Å—Ç—å 2 (–ª–æ–≥–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã, —Å—Ç–∞—Ç—É—Å—ã, —Ä–µ–¥–∞–∫—Ç–æ—Ä, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
=========================== */
</script>
<script>
/* ===========================
   –ü–æ–∏—Å–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π
=========================== */
function findBlock(blockId){
  return state.blocks.find(b=>b.id===blockId) || null;
}
function findExercise(exId){
  for(const b of state.blocks){
    const e = b.exercises.find(x=>x.id===exId);
    if(e) return {block:b, ex:e};
  }
  return null;
}
function findWeight(exId, wId){
  const fe = findExercise(exId);
  if(!fe) return null;
  const w = fe.ex.weights.find(x=>x.id===wId);
  if(!w) return null;
  return {block:fe.block, ex:fe.ex, w};
}
function allExercises(){
  const res = [];
  for(const b of state.blocks){
    for(const e of b.exercises) res.push({block:b, ex:e});
  }
  return res;
}

/* ===========================
   Entries helpers
=========================== */
function getCellEntry(workoutId, exId, wId){
  return (((state.entries[workoutId]||{})[exId]||{})[wId]) || null;
}
function ensureEntryContainer(workoutId, exId){
  state.entries[workoutId] ||= {};
  state.entries[workoutId][exId] ||= {};
  return state.entries[workoutId][exId];
}
function setCellEntry(workoutId, exId, wId, entry){
  const exCont = ensureEntryContainer(workoutId, exId);
  if(entry==null){
    delete exCont[wId];
  }else{
    exCont[wId] = entry;
  }
}

/* –°—É–º–º–∞ reps –≤ —è—á–µ–π–∫–µ (—É—á–∏—Ç—ã–≤–∞—è L/R –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) */
function sumSets(sets){ return (sets||[]).reduce((a,b)=>a+(+b||0),0); }
function entryTotalReps(entry, splitLR, side){
  if(!entry) return 0;
  if(!splitLR){
    return sumSets(entry.sets);
  }
  const part = entry[side] || {sets:[]};
  return sumSets(part.sets);
}
function entrySetsCount(entry, splitLR, side){
  if(!entry) return 0;
  if(!splitLR) return (entry.sets||[]).filter(n=>Number.isFinite(n)).length;
  const part = entry[side] || {sets:[]};
  return (part.sets||[]).filter(n=>Number.isFinite(n)).length;
}
function entryHasData(entry, splitLR, side){
  if(!entry) return false;
  if(!splitLR) return (entry.sets||[]).length>0;
  const p = entry[side];
  return !!p && (p.sets||[]).length>0;
}
function entryInjury(entry, splitLR, side){
  if(!entry) return false;
  if(!splitLR) return !!entry.injury;
  return !!(entry[side] && entry[side].injury);
}

/* ===========================
   –ü—Ä–∞–≤–∏–ª–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è)
   - –†–µ–∫–æ—Ä–¥: reps(—è—á–µ–π–∫–∞) > max reps –ø–æ —ç—Ç–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é+–≤–µ—Å—É —Ä–∞–Ω–µ–µ (–ø–æ –¥–∞—Ç–µ)
   - –ù–æ–≤—ã–π –≤–µ—Å: –ø–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–µ—Å–∞ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é (—Ä–∞–Ω—å—à–µ –Ω–µ –±—ã–ª–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–º—É –≤–µ—Å—É)
   - –ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –ø–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (—Ä–∞–Ω—å—à–µ –Ω–µ –±—ã–ª–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ª—é–±–æ–º—É –≤–µ—Å—É)
   - –°–µ—Ä—ã–π —Ñ–æ–Ω: –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é+–≤–µ—Å—É –∏ —Ç–µ–∫—É—â–∞—è —è—á–µ–π–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ —Ä–µ–∫–æ—Ä–¥ –Ω–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω
   - –¢—Ä–∞–≤–º–∞: —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω –≤—Ä—É—á–Ω—É—é (–Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞–µ—Ç –æ–±–≤–æ–¥–∫—É)
=========================== */
function buildChronoIndex(){
  // –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ exId/wId: –∏—Å—Ç–æ—Ä–∏—è –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º (asc)
  const workouts = sortWorkoutsAsc(state.workouts);
  const wOrder = workouts.map(w=>w.id);

  // history[exId][wId][side?] = [{workoutId, total, hasData, injury}]
  const history = {};
  for(const wid of wOrder){
    const wEntries = state.entries[wid] || {};
    for(const exId of Object.keys(wEntries)){
      history[exId] ||= {};
      const weightsMap = wEntries[exId] || {};
      for(const wId of Object.keys(weightsMap)){
        const fe = findExercise(exId);
        if(!fe) continue;
        const split = fe.ex.splitLR;

        const entry = weightsMap[wId];
        history[exId][wId] ||= { N: [], L: [], R: [] };

        if(!split){
          const has = entryHasData(entry,false);
          const total = entryTotalReps(entry,false);
          history[exId][wId].N.push({
            workoutId: wid, total, hasData: has, injury: !!entry?.injury
          });
        }else{
          for(const side of ["L","R"]){
            const has = entryHasData(entry,true,side);
            const total = entryTotalReps(entry,true,side);
            const inj = entryInjury(entry,true,side);
            history[exId][wId][side].push({
              workoutId: wid, total, hasData: has, injury: inj
            });
          }
        }
      }
    }
  }

  return {workouts, wOrder, history};
}

function goalForEmptyCell(chrono, workoutId, exId, wId, sideKey){
  // –ø–æ–∫–∞–∑–∞—Ç—å "–Ω–∞–¥–æ max+1" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ –±—ã–ª–∞ –∏—Å—Ç–æ—Ä–∏—è (hasData)
  const seq = ((chrono.history[exId]||{})[wId]||{})[sideKey] || [];
  let maxPrev = -Infinity;
  let hasPrev = false;
  for(const it of seq){
    if(it.workoutId === workoutId) break; // –¥–∞–ª—å—à–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –Ω–µ –Ω–∞–¥–æ
    if(it.hasData){
      hasPrev = true;
      maxPrev = Math.max(maxPrev, it.total);
    }
  }
  if(!hasPrev) return null;
  return (maxPrev + 1);
}

function computeCellStatus(chrono, workoutId, exId, wId, sideKey){
  const fe = findExercise(exId);
  if(!fe) return {border:null, gray:false, injury:false, isRecord:false, isNewWeight:false, isNewEx:false};
  const split = fe.ex.splitLR;

  const entry = getCellEntry(workoutId, exId, wId);
  const has = entryHasData(entry, split, sideKey==="N"?null:sideKey);
  const injury = entryInjury(entry, split, sideKey==="N"?null:sideKey);
  const total = split ? entryTotalReps(entry,true,sideKey) : entryTotalReps(entry,false);

  // –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å: –±—ã–ª –ª–∏ —ç—Ç–æ—Ç –≤–µ—Å —Ä–∞–Ω—å—à–µ
  const seq = ((chrono.history[exId]||{})[wId]||{})[sideKey] || [];
  let maxPrev = -Infinity;
  let hadPrevDataForThisWeight = false;
  for(const it of seq){
    if(it.workoutId === workoutId) break;
    if(it.hasData){
      hadPrevDataForThisWeight = true;
      maxPrev = Math.max(maxPrev, it.total);
    }
  }
  const isRecord = has && hadPrevDataForThisWeight && (total > maxPrev);

  // –Ω–æ–≤—ã–π –≤–µ—Å: –ø–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–º—É –≤–µ—Å—É (–ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏)
  let isNewWeight = false;
  if(has){
    let seenBefore = false;
    for(const it of seq){
      if(it.workoutId === workoutId) break;
      if(it.hasData){ seenBefore = true; break; }
    }
    isNewWeight = !seenBefore;
  }

  // –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –ø–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –ª—é–±–æ–º—É –≤–µ—Å—É —ç—Ç–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  let isNewEx = false;
  if(has){
    // –ø—Ä–æ–π–¥—ë–º –ø–æ –≤—Å–µ–º –≤–µ—Å–∞–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º –±—ã–ª –ª–∏ –ª—é–±–æ–π hasData —Ä–∞–Ω—å—à–µ
    let anyBefore = false;
    const wOrder = chrono.wOrder;
    for(const wid of wOrder){
      if(wid === workoutId) break;
      const wEntries = state.entries[wid] || {};
      const exMap = wEntries[exId] || {};
      if(!exMap) continue;
      for(const wKey of Object.keys(exMap)){
        const ent = exMap[wKey];
        if(!split){
          if(entryHasData(ent,false)){ anyBefore = true; break; }
        }else{
          if(entryHasData(ent,true,"L") || entryHasData(ent,true,"R")){ anyBefore = true; break; }
        }
      }
      if(anyBefore) break;
    }
    isNewEx = !anyBefore;
  }

  // —Å–µ—Ä—ã–π —Ñ–æ–Ω: –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —ç—Ç–æ–º—É –≤–µ—Å—É –∏ —Ç–µ–∫—É—â–∞—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ —Ä–µ–∫–æ—Ä–¥ –Ω–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω
  const gray = has && hadPrevDataForThisWeight && !isRecord;

  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±–≤–æ–¥–∫–∏: —Ä–µ–∫–æ—Ä–¥ > –Ω–æ–≤—ã–π –≤–µ—Å > –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
  let border = null;
  if(isRecord) border = "gold";
  else if(isNewWeight) border = "green";
  else if(isNewEx) border = "yellow";

  return {border, gray, injury, isRecord, isNewWeight, isNewEx};
}

/* ===========================
   –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
=========================== */
let chronoCache = null;

function renderTable(){
  state.workouts = sortWorkoutsAsc(state.workouts);
  // –∫–µ—à –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤/—Ü–µ–ª–µ–π
  chronoCache = buildChronoIndex();

  const workouts = sortWorkoutsDesc(chronoCache.workouts);

  // —à–∞–ø–∫–∞
  let html = `<table><thead><tr>`;
  html += `<th class="stickyLeft corner"> </th>`;
  for(const w of workouts){
    html += `<th data-workout-head="${w.id}">
      <div class="dateHead">
        <span class="d">${w.date}</span>
        <button class="trash" data-del-workout="${w.id}" title="–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É">üóëÔ∏è</button>
      </div>
    </th>`;
  }
  html += `</tr></thead><tbody>`;

  for(const block of state.blocks){
    // BLOCK row
    html += `<tr class="blockRow" data-block="${block.id}">
      <td class="stickyLeft">
        <div class="leftCell">
          <button class="tinyIcon" data-toggle-block="${block.id}" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">${block.collapsed ? "‚ñ∂" : "‚ñº"}</button>
          <div class="leftText">${escapeHtml(block.name)}</div>
        </div>
      </td>`;
    for(let i=0;i<workouts.length;i++) html += `<td></td>`;
    html += `</tr>`;

    if(block.collapsed) continue;

    for(const ex of block.exercises){
      if(ex.archived) continue;

      // Exercise header row (no cells)
      html += `<tr class="exRow" data-ex="${ex.id}">
        <td class="stickyLeft">
          <div class="leftCell">
            <div class="leftText">${escapeHtml(ex.name)}</div>
            ${ex.splitLR ? `<span class="pill" title="Split L/R">L/R</span>` : ``}
          </div>
        </td>`;
      for(let i=0;i<workouts.length;i++) html += `<td></td>`;
      html += `</tr>`;

      // Weights (sorted asc)
      ex.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));

      for(const w of ex.weights){
        if(w.hidden) continue;

        if(!ex.splitLR){
          html += renderWeightRow(workouts, block, ex, w, "N");
        }else{
          html += renderWeightRow(workouts, block, ex, w, "L");
          html += renderWeightRow(workouts, block, ex, w, "R");
        }
      }
    }
  }

  html += `</tbody></table>`;
  tableWrap.innerHTML = html;

  // Wire events (–¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ innerHTML)
  wireTableEvents();

  // –º–µ–ª–∫–∏–π UX: —Å–∫—Ä–æ–ª–ª –∫ —Å–∞–º—ã–º —Å–≤–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º (—Å–ª–µ–≤–∞)
  if(!renderTable._didAutoScroll){
    renderTable._didAutoScroll = true;
    setTimeout(()=>{
      tableWrap.scrollLeft = 0;
    }, 0);
  }
}

function renderWeightRow(workouts, block, ex, w, side){
  const sideTag = side==="N" ? "" : `<span class="sideTag">${side}</span>`;
  const label = `${escapeHtml(w.label)}`;

  let row = `<tr class="wRow" data-ex="${ex.id}" data-weight="${w.id}" data-side="${side}">
    <td class="stickyLeft">
      <div class="leftCell">
        ${sideTag}
        <div class="leftText">${label}</div>
        <button class="tinyIcon" data-toggle-weight="${ex.id}:${w.id}" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å">üëÅÔ∏è</button>
      </div>
    </td>`;

  for(const wo of workouts){
    const entry = getCellEntry(wo.id, ex.id, w.id);
    const split = ex.splitLR;
    const has = entryHasData(entry, split, side==="N"?null:side);

    const status = computeCellStatus(chronoCache, wo.id, ex.id, w.id, side);
    const goal = (!has) ? goalForEmptyCell(chronoCache, wo.id, ex.id, w.id, side) : null;

    const total = has ? (split ? entryTotalReps(entry,true,side) : entryTotalReps(entry,false)) : 0;
    const setsStr = has ? (split ? (entry[side].sets||[]) : (entry.sets||[])).join("/") : "";
    const valText = has ? `${total}` : (goal!=null ? `–Ω–∞–¥–æ ${goal}` : "");

    let cls = "cell";
    if(!has) cls += " empty";
    if(status.gray) cls += " gray";
    if(status.injury) cls += " injury";
    if(status.border==="gold") cls += " border-gold";
    if(status.border==="green") cls += " border-green";
    if(status.border==="yellow") cls += " border-yellow";

    row += `<td class="${cls}"
      data-cell="${wo.id}|${ex.id}|${w.id}|${side}">
        <div class="val">${escapeHtml(valText)}</div>
        <div class="sub">${escapeHtml(setsStr)}</div>
      </td>`;
  }

  row += `</tr>`;
  return row;
}

function wireTableEvents(){
  // toggle block collapse
  $$("[data-toggle-block]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-toggle-block");
      const b = findBlock(id);
      if(!b) return;
      b.collapsed = !b.collapsed;
      saveState();
      renderAll();
    });
  });

  // toggle weight hidden (soft-hide)
  $$("[data-toggle-weight]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const [exId, wId] = btn.getAttribute("data-toggle-weight").split(":");
      const fw = findWeight(exId, wId);
      if(!fw) return;
      fw.w.hidden = !fw.w.hidden;
      saveState();
      renderAll();
      // –º–µ–Ω—é —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–º, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
      if(drawer.classList.contains("show")) refreshWeightsList();
    });
  });

  // delete workout
  $$("[data-del-workout]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const wid = btn.getAttribute("data-del-workout");
      const w = state.workouts.find(x=>x.id===wid);
      if(!w) return;
      if(confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ${w.date}?`)){
        state.workouts = state.workouts.filter(x=>x.id!==wid);
        delete state.entries[wid];
        saveState();
        renderAll();
      }
    });
  });

  // cell click -> editor
  $$(".cell[data-cell]").forEach(td=>{
    td.addEventListener("click", ()=>{
      openCellEditor(td.getAttribute("data-cell"));
    });
  });

  // long-press on date header -> stats
  // + dblclick as fallback
  $$("th[data-workout-head]").forEach(th=>{
    const wid = th.getAttribute("data-workout-head");
    let timer = null;
    let moved = false;

    const start = (ev)=>{
      moved = false;
      timer = setTimeout(()=>{
        timer = null;
        openWorkoutStats(wid);
      }, 700);
    };
    const cancel = ()=>{
      if(timer){ clearTimeout(timer); timer = null; }
    };

    th.addEventListener("touchstart", start, {passive:true});
    th.addEventListener("touchmove", ()=>{ moved=true; cancel(); }, {passive:true});
    th.addEventListener("touchend", ()=>{ if(!moved) cancel(); }, {passive:true});
    th.addEventListener("touchcancel", cancel, {passive:true});

    th.addEventListener("mousedown", start);
    th.addEventListener("mouseup", cancel);
    th.addEventListener("mouseleave", cancel);

    th.addEventListener("dblclick", ()=>openWorkoutStats(wid));
  });
}

/* ===========================
   –≠–∫—Ä–∞–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
=========================== */
$("#btnAddWorkout").addEventListener("click", ()=>{
  const s = prompt("–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (DD.MM.YYYY):", fmtDate(new Date()));
  if(s==null) return;
  const d = parseDDMMYYYY(s.trim());
  if(!d){
    alert("–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞. –§–æ—Ä–º–∞—Ç: DD.MM.YYYY");
    return;
  }
  const date = fmtDate(d);
  // –¥–æ–ø—É—Å–∫–∞–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–∞—Ç—ã? –æ–±—ã—á–Ω–æ –Ω–µ—Ç, –Ω–æ –ø—É—Å—Ç—å –º–æ–∂–Ω–æ.
  state.workouts.push({id: nowId(), date});
  state.workouts = sortWorkoutsAsc(state.workouts);
  saveState();
  renderAll();
});

/* ===========================
   –†–µ–¥–∞–∫—Ç–æ—Ä —è—á–µ–π–∫–∏
=========================== */
let cellCtx = null; // {workoutId, exId, wId, side}
function openCellEditor(cellKey){
  const [workoutId, exId, wId, side] = cellKey.split("|");
  const fe = findExercise(exId);
  const fw = findWeight(exId, wId);
  const wo = state.workouts.find(w=>w.id===workoutId);
  if(!fe || !fw || !wo) return;

  const ex = fe.ex;
  const split = ex.splitLR;

  const entry = getCellEntry(workoutId, exId, wId) || (split ? {L:{sets:[],injury:false},R:{sets:[],injury:false}} : {sets:[],injury:false});
  const sideName = side==="N" ? "" : ` ‚Ä¢ ${side}`;

  cellCtx = {workoutId, exId, wId, side};

  $("#cellTitle").textContent = `${ex.name} ‚Ä¢ ${fw.w.label}${sideName}`;
  $("#cellSubtitle").textContent = `${wo.date} ‚Ä¢ –≤–≤–æ–¥: –ø–æ–≤—Ç–æ—Ä—ã –ø–æ —Å–µ—Ç–∞–º`;

  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å sets
  const sets = split ? (entry[side].sets||[]) : (entry.sets||[]);
  renderSetsEditor(sets);

  // injury
  const inj = split ? !!entry[side].injury : !!entry.injury;
  $("#btnToggleInjury").textContent = inj ? "–í–∫–ª" : "–í—ã–∫–ª";
  $("#btnToggleInjury").dataset.on = inj ? "1" : "0";

  cellModalOverlay.classList.add("show");
  cellModalOverlay.setAttribute("aria-hidden","false");
}
function closeCellEditor(){
  cellModalOverlay.classList.remove("show");
  cellModalOverlay.setAttribute("aria-hidden","true");
  cellCtx = null;
}
$("#btnCloseCellModal").addEventListener("click", closeCellEditor);
$("#btnCancelCell").addEventListener("click", closeCellEditor);
cellModalOverlay.addEventListener("click", (e)=>{
  if(e.target === cellModalOverlay) closeCellEditor();
});

function renderSetsEditor(sets){
  const wrap = $("#setsWrap");
  if(!sets || sets.length===0){
    sets = [""];
  }
  wrap.innerHTML = sets.map((v, idx)=>`
    <div class="setRow" data-set-row="${idx}">
      <input type="number" inputmode="numeric" min="0" placeholder="–ø–æ–≤—Ç–æ—Ä—ã" value="${escapeAttr(v)}" />
      <button class="btn icon" data-del-set="${idx}" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–µ—Ç">‚àí</button>
    </div>
  `).join("");

  $$("[data-del-set]", wrap).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.getAttribute("data-del-set");
      const rows = $$('[data-set-row] input', wrap).map(inp=>inp.value);
      rows.splice(i,1);
      renderSetsEditor(rows);
    });
  });
}

$("#btnAddSet").addEventListener("click", ()=>{
  const wrap = $("#setsWrap");
  const rows = $$('[data-set-row] input', wrap).map(inp=>inp.value);
  rows.push("");
  renderSetsEditor(rows);
});
$("#btnClearSets").addEventListener("click", ()=>{
  renderSetsEditor([""]);
});
$("#btnToggleInjury").addEventListener("click", ()=>{
  const btn = $("#btnToggleInjury");
  const on = btn.dataset.on === "1";
  btn.dataset.on = on ? "0" : "1";
  btn.textContent = on ? "–í—ã–∫–ª" : "–í–∫–ª";
});

$("#btnSaveCell").addEventListener("click", ()=>{
  if(!cellCtx) return;
  const {workoutId, exId, wId, side} = cellCtx;
  const fe = findExercise(exId);
  if(!fe) return;
  const split = fe.ex.splitLR;

  const raw = $$('[data-set-row] input', $("#setsWrap")).map(inp=>inp.value);
  const nums = raw.map(clampInt).filter(v=>v!=null);

  const injuryOn = ($("#btnToggleInjury").dataset.on === "1");

  let entry = getCellEntry(workoutId, exId, wId);
  if(!entry){
    entry = split
      ? {L:{sets:[],injury:false},R:{sets:[],injury:false}}
      : {sets:[],injury:false};
  }

  if(!split){
    entry.sets = nums;
    entry.injury = injuryOn;
    // –µ—Å–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç–æ –∏ —Ç—Ä–∞–≤–º–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ ‚Äî —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
    if(entry.sets.length===0 && !entry.injury){
      setCellEntry(workoutId, exId, wId, null);
    }else{
      setCellEntry(workoutId, exId, wId, entry);
    }
  }else{
    entry[side] ||= {sets:[],injury:false};
    entry[side].sets = nums;
    entry[side].injury = injuryOn;

    const emptyL = (entry.L?.sets||[]).length===0 && !entry.L?.injury;
    const emptyR = (entry.R?.sets||[]).length===0 && !entry.R?.injury;
    if(emptyL && emptyR){
      setCellEntry(workoutId, exId, wId, null);
    }else{
      setCellEntry(workoutId, exId, wId, entry);
    }
  }

  saveState();
  renderAll();
  closeCellEditor();
});

/* ===========================
   –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–º–æ–¥–∞–ª–∫–∞)
=========================== */
function openWorkoutStats(workoutId){
  const wo = state.workouts.find(w=>w.id===workoutId);
  if(!wo) return;

  chronoCache = buildChronoIndex();
  const workouts = chronoCache.workouts;

  // –ø—Ä–æ–≥–æ–Ω—è–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ –∏ —Å—á–∏—Ç–∞–µ–º
  let records = 0, newWeights = 0, newExercises = 0;
  const setsByBlock = {}; // blockName => sets count
  for(const b of state.blocks){
    setsByBlock[b.name] = 0;
    for(const ex of b.exercises){
      if(ex.archived) continue;
      for(const w of ex.weights){
        if(w.hidden) continue;

        if(!ex.splitLR){
          const entry = getCellEntry(workoutId, ex.id, w.id);
          const has = entryHasData(entry,false);
          if(!has) continue;

          const st = computeCellStatus(chronoCache, workoutId, ex.id, w.id, "N");
          if(st.isRecord) records++;
          if(st.isNewWeight) newWeights++;
          if(st.isNewEx) newExercises++;
          setsByBlock[b.name] += entrySetsCount(entry,false);
        }else{
          const entry = getCellEntry(workoutId, ex.id, w.id);
          for(const side of ["L","R"]){
            const has = entryHasData(entry,true,side);
            if(!has) continue;
            const st = computeCellStatus(chronoCache, workoutId, ex.id, w.id, side);
            if(st.isRecord) records++;
            if(st.isNewWeight) newWeights++;
            if(st.isNewEx) newExercises++;
            setsByBlock[b.name] += entrySetsCount(entry,true,side);
          }
        }
      }
    }
  }

  const blockLines = Object.entries(setsByBlock)
    .filter(([,v])=>v>0)
    .map(([k,v])=>`<div class="kpi"><b>${v}</b><small>—Å–µ—Ç–æ–≤ ‚Ä¢ ${escapeHtml(k)}</small></div>`)
    .join("");

  const html = `
    <div class="kpiRow" style="margin-bottom:10px">
      <div class="kpi"><b>${records}</b><small>—Ä–µ–∫–æ—Ä–¥–æ–≤</small></div>
      <div class="kpi"><b>${newWeights}</b><small>–Ω–æ–≤—ã—Ö –≤–µ—Å–æ–≤</small></div>
      <div class="kpi"><b>${newExercises}</b><small>–Ω–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</small></div>
    </div>

    <div style="margin:8px 0 10px; color:var(--muted); font-size:12px">
      –°–µ—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –∫–∞–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–µ–Ω–∏–π –≤ —è—á–µ–π–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚Äú10/10/8‚Äù = 3).
    </div>

    <div class="kpiRow">
      ${blockLines || `<div style="color:var(--muted)">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.</div>`}
    </div>

    <hr style="border:none; border-top:1px solid var(--line); margin:12px 0">

    <div style="color:var(--muted); font-size:12px">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: long-press (~0.7s) –∏–ª–∏ double-tap –ø–æ –¥–∞—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü–µ.
    </div>
  `;

  showInfo(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Ä¢ ${wo.date}`, html);
}

/* ===========================
   –ú–µ–Ω—é: –¥–æ–±–∞–≤–∏—Ç—å/—É–ø—Ä–∞–≤–ª—è—Ç—å
=========================== */
function refreshMenuSelects(){
  // blocks
  $("#selBlockAddEx").innerHTML = state.blocks.map(b=>`<option value="${b.id}">${escapeHtml(b.name)}</option>`).join("");

  // exercises lists
  const exs = allExercises();
  const exOpt = exs.map(({block,ex})=>{
    const mark = ex.archived ? " (–∞—Ä—Ö–∏–≤)" : "";
    return `<option value="${ex.id}">${escapeHtml(block.name)} ‚Ä¢ ${escapeHtml(ex.name)}${mark}</option>`;
  }).join("");

  $("#selExAddWeight").innerHTML = exOpt;
  $("#selManageExercise").innerHTML = exOpt;

  refreshWeightsList();
  refreshSplitArchiveButtons();
}

function refreshSplitArchiveButtons(){
  const exId = $("#selManageExercise").value;
  const fe = findExercise(exId);
  if(!fe) return;
  $("#btnToggleSplit").textContent = fe.ex.splitLR ? "–í–∫–ª" : "–í—ã–∫–ª";
  $("#btnToggleArchive").textContent = fe.ex.archived ? "–í–∫–ª" : "–í—ã–∫–ª";
}

$("#selManageExercise").addEventListener("change", ()=>{
  refreshWeightsList();
  refreshSplitArchiveButtons();
});

function refreshWeightsList(){
  const exId = $("#selManageExercise").value;
  const fe = findExercise(exId);
  if(!fe){ $("#weightsList").innerHTML=""; return; }
  const ex = fe.ex;

  ex.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
  const items = ex.weights.map(w=>{
    const eye = w.hidden ? "üôà" : "üëÅÔ∏è";
    const txt = w.hidden ? `<span style="color:var(--muted)">${escapeHtml(w.label)} (—Å–∫—Ä—ã—Ç)</span>` : escapeHtml(w.label);
    return `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--line); background:var(--bg); border-radius:14px; margin-bottom:6px">
        <div style="min-width:0; overflow:hidden; text-overflow:ellipsis">${txt}</div>
        <button class="btn icon" data-menu-toggle-weight="${w.id}" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å">${eye}</button>
      </div>
    `;
  }).join("");

  $("#weightsList").innerHTML = items || `<div style="color:var(--muted); font-size:12px">–ù–µ—Ç –≤–µ—Å–æ–≤</div>`;

  $$("[data-menu-toggle-weight]", $("#weightsList")).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const wId = btn.getAttribute("data-menu-toggle-weight");
      const fw = findWeight(exId, wId);
      if(!fw) return;
      fw.w.hidden = !fw.w.hidden;
      saveState();
      renderAll();
      refreshWeightsList();
    });
  });
}

$("#btnAddExercise").addEventListener("click", ()=>{
  const blockId = $("#selBlockAddEx").value;
  const name = $("#inExName").value.trim();
  if(!name){ alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."); return; }
  const b = findBlock(blockId);
  if(!b) return;

  b.exercises.push({
    id: nowId(),
    name,
    archived:false,
    splitLR:false,
    weights: []
  });
  $("#inExName").value = "";
  saveState();
  renderAll();
  refreshMenuSelects();
});

$("#btnAddWeight").addEventListener("click", ()=>{
  const exId = $("#selExAddWeight").value;
  const label = $("#inWeightLabel").value.trim();
  if(!label){ alert("–í–≤–µ–¥–∏ –≤–µ—Å."); return; }
  const fe = findExercise(exId);
  if(!fe) return;

  // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π label ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
  if(fe.ex.weights.some(w=>String(w.label).trim()===label)){
    alert("–¢–∞–∫–æ–π –≤–µ—Å —É–∂–µ –µ—Å—Ç—å —É —ç—Ç–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.");
    return;
  }
  fe.ex.weights.push({id: nowId(), label, hidden:false});
  fe.ex.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
  $("#inWeightLabel").value = "";
  saveState();
  renderAll();
  refreshMenuSelects();
});

$("#btnToggleSplit").addEventListener("click", ()=>{
  const exId = $("#selManageExercise").value;
  const fe = findExercise(exId);
  if(!fe) return;

  fe.ex.splitLR = !fe.ex.splitLR;

  // –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö entries —ç—Ç–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:
  // –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ split ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º sets –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã? –ù–ï–¢. –ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ: —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ N –∏ –∫–ª–∞–¥—ë–º –≤ L, R –ø—É—Å—Ç–æ.
  // –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–∏–ª–∏ split ‚Äî —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å L+R? –ù–ï–¢. –ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ N = L (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–Ω–∞—á–µ R.
  for(const wid of Object.keys(state.entries)){
    const wEntries = state.entries[wid] || {};
    const exMap = wEntries[exId] || null;
    if(!exMap) continue;

    for(const wId of Object.keys(exMap)){
      const ent = exMap[wId];
      if(fe.ex.splitLR){
        // —Å—Ç–∞–ª–æ splitLR=true
        if(ent && !ent.L && !ent.R){
          exMap[wId] = {
            L:{sets: (ent.sets||[]), injury: !!ent.injury},
            R:{sets: [], injury:false}
          };
        }
      }else{
        // —Å—Ç–∞–ª–æ splitLR=false
        if(ent && (ent.L || ent.R)){
          const pick = (ent.L && (ent.L.sets||[]).length>0) ? ent.L : (ent.R || {sets:[],injury:false});
          exMap[wId] = {sets: (pick.sets||[]), injury: !!pick.injury};
        }
      }
    }
  }

  saveState();
  renderAll();
  refreshMenuSelects();
});

$("#btnToggleArchive").addEventListener("click", ()=>{
  const exId = $("#selManageExercise").value;
  const fe = findExercise(exId);
  if(!fe) return;
  fe.ex.archived = !fe.ex.archived;
  saveState();
  renderAll();
  refreshMenuSelects();
});

$("#btnDeleteExercise").addEventListener("click", ()=>{
  const exId = $("#selManageExercise").value;
  const fe = findExercise(exId);
  if(!fe) return;
  const exName = fe.ex.name;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exName}" –Ω–∞–≤—Å–µ–≥–¥–∞? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é.`)) return;

  // —É–¥–∞–ª–∏—Ç—å –∏–∑ –±–ª–æ–∫–∞
  fe.block.exercises = fe.block.exercises.filter(e=>e.id!==exId);
  // —É–¥–∞–ª–∏—Ç—å –≤—Å–µ entries
  for(const wid of Object.keys(state.entries)){
    if(state.entries[wid] && state.entries[wid][exId]){
      delete state.entries[wid][exId];
    }
  }
  saveState();
  renderAll();
  refreshMenuSelects();
});

/* ===========================
   –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (canvas)
=========================== */
function refreshAnalyticsSelects(){
  // block options
  anBlock.innerHTML = state.blocks.map(b=>`<option value="${b.id}">${escapeHtml(b.name)}</option>`).join("");
  // default: first block
  const bId = anBlock.value || (state.blocks[0]?.id);
  if(bId) anBlock.value = bId;
  refreshAnalyticsExerciseList();
}
function refreshAnalyticsExerciseList(){
  const bId = anBlock.value;
  const b = findBlock(bId);
  if(!b){ anExercise.innerHTML=""; return; }
  const exs = b.exercises.filter(e=>!e.archived);
  anExercise.innerHTML = exs.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join("");
  if(!anExercise.value && exs[0]) anExercise.value = exs[0].id;
}

anBlock.addEventListener("change", ()=>{ refreshAnalyticsExerciseList(); renderAnalytics(); });
anExercise.addEventListener("change", renderAnalytics);
anMetric.addEventListener("change", renderAnalytics);

function renderAnalytics(){
  refreshAnalyticsSelects();
  chronoCache = buildChronoIndex();

  const exId = anExercise.value;
  const fe = findExercise(exId);
  if(!fe){
    drawEmptyChart("–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è");
    kpiRow.innerHTML = "";
    insights.innerHTML = `<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>`;
    return;
  }
  const ex = fe.ex;
  const workouts = chronoCache.workouts;

  // —Å–æ–±—Ä–∞—Ç—å —Ç–æ—á–∫–∏ –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º
  const points = [];
  const perWorkoutStats = []; // {records, injuries}
  for(const wo of workouts){
    let volume = 0;
    let reps = 0;
    let records = 0;
    let injuries = 0;

    for(const w of ex.weights){
      // —Å—á–∏—Ç–∞–µ–º –∏ —Å–∫—Ä—ã—Ç—ã–µ –≤–µ—Å–∞? –í –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –ª—É—á—à–µ —Å—á–∏—Ç–∞—Ç—å –∏ —Å–∫—Ä—ã—Ç—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Äî –±–µ—Ä—ë–º –≤—Å–µ –≤–µ—Å–∞
      const entry = getCellEntry(wo.id, exId, w.id);
      if(!ex.splitLR){
        if(entryHasData(entry,false)){
          const total = entryTotalReps(entry,false);
          reps += total;
          const wt = weightMaxNumber(w.label);
          if(Number.isFinite(wt)) volume += (entrySetsCount(entry,false) * (total/Math.max(1, entrySetsCount(entry,false))) * wt); 
          // –≤—ã—à–µ —Ö–∏—Ç—Ä–æ: sets * avgReps * weight = sumReps * weight (–µ—Å–ª–∏ sets>0)
          // –ø—Ä–æ—â–µ: sumReps * weight:
          volume += 0; // –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º –Ω–∏–∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—É–ª–æ–π
          volume = volume - 0; // noop
          volume += (total * wt);

          const st = computeCellStatus(chronoCache, wo.id, exId, w.id, "N");
          if(st.isRecord) records++;
          if(entryInjury(entry,false)) injuries++;
        }
      }else{
        for(const side of ["L","R"]){
          if(entryHasData(entry,true,side)){
            const total = entryTotalReps(entry,true,side);
            reps += total;
            const wt = weightMaxNumber(w.label);
            if(Number.isFinite(wt)) volume += (total * wt);

            const st = computeCellStatus(chronoCache, wo.id, exId, w.id, side);
            if(st.isRecord) records++;
            if(entryInjury(entry,true,side)) injuries++;
          }
        }
      }
    }

    perWorkoutStats.push({workoutId: wo.id, date: wo.date, records, injuries, volume, reps});
    points.push({x: wo.date, volume, reps, records, injuries});
  }

  // –≤—ã–±—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É
  const metric = anMetric.value;
  const yVals = points.map(p => p[metric] || 0);

  drawLineChart(points.map(p=>p.x), yVals, metricLabel(metric));

  // KPI
  const totalWorkouts = workouts.length;
  const totalRecords = perWorkoutStats.reduce((a,b)=>a+b.records,0);
  const totalInj = perWorkoutStats.reduce((a,b)=>a+b.injuries,0);

  const sumVol = perWorkoutStats.reduce((a,b)=>a+b.volume,0);
  const sumReps = perWorkoutStats.reduce((a,b)=>a+b.reps,0);

  kpiRow.innerHTML = `
    <div class="kpi"><b>${totalWorkouts}</b><small>—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏</small></div>
    <div class="kpi"><b>${totalRecords}</b><small>—Ä–µ–∫–æ—Ä–¥–æ–≤ (–≤—Å–µ–≥–æ)</small></div>
    <div class="kpi"><b>${metric==="volume" ? Math.round(sumVol) : sumReps}</b><small>${metric==="volume" ? "—Å—É–º–º. –æ–±—ä—ë–º (‚âà)" : "—Å—É–º–º. –ø–æ–≤—Ç–æ—Ä—ã"}</small></div>
    <div class="kpi"><b>${totalInj}</b><small>—Ç—Ä–∞–≤–º (–º–µ—Ç–æ–∫)</small></div>
  `;

  // Insights: –º–µ—Å—è—Ü –∫ –º–µ—Å—è—Ü—É –ø–æ –æ–±—ä—ë–º—É (–æ—Å–Ω–æ–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞)
  const insightHtml = buildInsights(perWorkoutStats, ex);
  insights.innerHTML = insightHtml;
}

function metricLabel(m){
  if(m==="volume") return "–û–±—ä—ë–º";
  if(m==="reps") return "–ü–æ–≤—Ç–æ—Ä—ã";
  if(m==="records") return "–†–µ–∫–æ—Ä–¥—ã";
  if(m==="injuries") return "–¢—Ä–∞–≤–º—ã";
  return m;
}

function monthKey(dateStr){
  const d = parseDDMMYYYY(dateStr);
  if(!d) return "????-??";
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function buildInsights(perWorkoutStats, ex){
  // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
  const byMonth = {};
  for(const it of perWorkoutStats){
    const k = monthKey(it.date);
    byMonth[k] ||= {volume:0, reps:0, records:0, injuries:0, workouts:0};
    byMonth[k].volume += it.volume;
    byMonth[k].reps += it.reps;
    byMonth[k].records += it.records;
    byMonth[k].injuries += it.injuries;
    byMonth[k].workouts += 1;
  }
  const keys = Object.keys(byMonth).sort();
  const cur = keys[keys.length-1];
  const prev = keys[keys.length-2];

  let html = `<div><b>–ö–∞–∫ —Å—á–∏—Ç–∞—é %:</b> (–æ–±—ä—ë–º_—Ç–µ–∫—É—â–∏–π ‚àí –æ–±—ä—ë–º_–ø—Ä–æ—à–ª—ã–π) / max(–æ–±—ä—ë–º_–ø—Ä–æ—à–ª—ã–π, 1) √ó 100%</div>
              <div class="muted">–û–±—ä—ë–º = Œ£(—Å—É–º–º–∞ reps –≤ —è—á–µ–π–∫–µ √ó weight). –î–ª—è ‚Äú60-50‚Äù weight —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ max(60,50)=60.</div>`;

  if(cur && prev){
    const vCur = byMonth[cur].volume;
    const vPrev = byMonth[prev].volume;
    const pct = ((vCur - vPrev) / Math.max(vPrev, 1)) * 100;
    const sign = pct>=0 ? "+" : "";
    html += `<div style="margin-top:8px">
      <b>–ú–µ—Å—è—Ü –∫ –º–µ—Å—è—Ü—É:</b> ${sign}${pct.toFixed(1)}% –ø–æ –æ–±—ä—ë–º—É ( ${cur} vs ${prev} ).
      <div class="muted">–¢–µ–∫—É—â–∏–π: ${Math.round(vCur)}, –ø—Ä–æ—à–ª—ã–π: ${Math.round(vPrev)}.</div>
    </div>`;
  }else{
    html += `<div style="margin-top:8px" class="muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.</div>`;
  }

  // ‚Äú—Ç—Ä–∞–≤–º—ã —á–∞—â–µ –Ω–∞ –±–æ–ª—å—à–∏—Ö –≤–µ—Å–∞—Ö‚Äù
  // –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –±–µ—Ä–µ–º –≤—Å–µ injury-—è—á–µ–π–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Å–º–æ—Ç—Ä–∏–º –∏—Ö –≤–µ—Å–∞; —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å–æ –º–µ–¥–∏–∞–Ω–æ–π –≤—Å–µ—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤
  const usedWeights = [];
  const injuryWeights = [];
  for(const wo of chronoCache.workouts){
    for(const w of ex.weights){
      const entry = getCellEntry(wo.id, ex.id, w.id);
      const wt = weightMaxNumber(w.label);
      if(!Number.isFinite(wt)) continue;

      const split = ex.splitLR;
      if(!split){
        if(entryHasData(entry,false)){
          usedWeights.push(wt);
          if(entryInjury(entry,false)) injuryWeights.push(wt);
        }
      }else{
        for(const side of ["L","R"]){
          if(entryHasData(entry,true,side)){
            usedWeights.push(wt);
            if(entryInjury(entry,true,side)) injuryWeights.push(wt);
          }
        }
      }
    }
  }
  if(usedWeights.length>=4 && injuryWeights.length>=2){
    usedWeights.sort((a,b)=>a-b);
    const med = usedWeights[Math.floor(usedWeights.length/2)];
    const highInj = injuryWeights.filter(w=>w>=med).length;
    const ratio = highInj / injuryWeights.length;
    if(ratio >= 0.6){
      html += `<div style="margin-top:10px">
        <b>–†–∏—Å–∫ —Ç—Ä–∞–≤–º:</b> –º–µ—Ç–∫–∏ —Ç—Ä–∞–≤–º —á–∞—â–µ –Ω–∞ –±–æ–ª–µ–µ —Ç—è–∂—ë–ª—ã—Ö –≤–µ—Å–∞—Ö (‚â• –º–µ–¥–∏–∞–Ω—ã ${med}).
        <div class="muted">–≠—Ç–æ –Ω–µ –º–µ–¥–∏—Ü–∏–Ω–∞. –ü—Ä–æ—Å—Ç–æ —Å–∏–≥–Ω–∞–ª: –ø—Ä–æ–≥—Ä–µ–≤, —Ç–µ—Ö–Ω–∏–∫–∞, –æ–±—ä—ë–º, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.</div>
      </div>`;
    }else{
      html += `<div style="margin-top:10px" class="muted">–¢—Ä–∞–≤–º—ã –Ω–µ –≤—ã–≥–ª—è–¥—è—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∏–º–µ–Ω–Ω–æ —Å –±–æ–ª—å—à–∏–º–∏ –≤–µ—Å–∞–º–∏ (–ø–æ —ç—Ç–æ–π —ç–≤—Ä–∏—Å—Ç–∏–∫–µ).</div>`;
    }
  }else{
    html += `<div style="margin-top:10px" class="muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Ç–æ–∫ —Ç—Ä–∞–≤–º, —á—Ç–æ–±—ã –¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥—ã.</div>`;
  }

  return html;
}

/* Canvas chart */
function drawEmptyChart(text){
  const ctx = chart.getContext("2d");
  const w = chart.width, h = chart.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--muted").trim() || "#64748b";
  ctx.font = "24px system-ui";
  ctx.textAlign = "center";
  ctx.fillText(text, w/2, h/2);
}
function drawLineChart(labels, values, title){
  const ctx = chart.getContext("2d");
  const W = chart.width, H = chart.height;

  ctx.clearRect(0,0,W,H);

  // padding
  const padL = 50, padR = 16, padT = 24, padB = 46;
  const x0 = padL, y0 = padT, x1 = W-padR, y1 = H-padB;
  const innerW = x1-x0, innerH = y1-y0;

  // axis / grid
  const line = getVar("--line");
  const fg = getVar("--fg");
  const muted = getVar("--muted");
  ctx.strokeStyle = line;
  ctx.lineWidth = 1;

  // grid horizontal
  const maxV = Math.max(...values, 0);
  const minV = Math.min(...values, 0);
  const span = Math.max(maxV - minV, 1);
  const gridN = 4;

  for(let i=0;i<=gridN;i++){
    const y = y0 + (innerH*(i/gridN));
    ctx.beginPath();
    ctx.moveTo(x0,y);
    ctx.lineTo(x1,y);
    ctx.stroke();

    const v = (maxV - span*(i/gridN));
    ctx.fillStyle = muted;
    ctx.font = "12px system-ui";
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.fillText(formatAxis(v), x0-8, y);
  }

  // title
  ctx.fillStyle = fg;
  ctx.font = "16px system-ui";
  ctx.textAlign = "left";
  ctx.textBaseline = "top";
  ctx.fillText(title, x0, 2);

  // points
  const n = labels.length;
  if(n===0){
    drawEmptyChart("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
    return;
  }

  const xAt = (i)=> x0 + (n===1 ? innerW/2 : innerW*(i/(n-1)));
  const yAt = (v)=> y0 + innerH*( (maxV - v)/span );

  // line
  ctx.strokeStyle = getVar("--accent");
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const x = xAt(i);
    const y = yAt(values[i]||0);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // dots
  ctx.fillStyle = getVar("--accent");
  for(let i=0;i<n;i++){
    const x = xAt(i), y = yAt(values[i]||0);
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  }

  // x labels (last 3)
  ctx.fillStyle = muted;
  ctx.font = "12px system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  const show = Math.min(n, 3);
  for(let k=0;k<show;k++){
    const i = n - show + k;
    const x = xAt(i);
    ctx.fillText(labels[i], x, y1 + 10);
  }
}

function formatAxis(v){
  // –∫–æ—Ä–æ—Ç–∫–æ
  if(v>=1000) return Math.round(v/100)/10 + "k";
  return String(Math.round(v));
}
function getVar(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

/* ===========================
   Escape helpers
=========================== */
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function escapeAttr(s){
  return escapeHtml(s).replaceAll("'","&#39;");
}

/* ===========================
   –†–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ + init
=========================== */
function renderAll(){
  renderTable();
  refreshMenuSelects();
  // –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: –µ—Å–ª–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
  if(viewAnalytics.classList.contains("active")) renderAnalytics();
}
renderAll();

/* ===========================
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–µ–ª–µ–∫—Ç–æ–≤
=========================== */
refreshAnalyticsSelects();

/* ===========================
   –ó–∞–∫—Ä—ã—Ç–∏–µ drawer –ø–æ ESC
=========================== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape"){
    closeDrawer();
    closeCellEditor();
    closeInfo();
  }
});
</script>
</body>
</html>
