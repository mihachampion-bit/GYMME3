<!doctype html> 
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gym Progress ‚Äî offline</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --card:#f8fafc; --card2:#f1f5f9;
      --accent:#2563eb; --danger:#dc2626;
      --shadow: 0 10px 30px rgba(2,6,23,.08);

      --stickyBg: rgba(255,255,255,.92);

      --gold:#f59e0b;     /* —Ä–µ–∫–æ—Ä–¥ */
      --green:#22c55e;    /* –Ω–æ–≤—ã–π –≤–µ—Å */
      --yellow:#eab308;   /* –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ */
      --grayFill:#f1f5f9; /* –Ω–µ —Ä–µ–∫–æ—Ä–¥ */
      --injuryFill:#ffe4f1; /* —Ç—Ä–∞–≤–º–∞ (—Ä–æ–∑–æ–≤—ã–π) */

      --radius:16px;
      --rowH: 44px;
      --leftW: 132px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#9aa7bd; --line:#1f2a44;
      --card:#0f172a; --card2:#111c33;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --stickyBg: rgba(11,18,32,.88);

      --grayFill:#101a31;
      --injuryFill:#3a1530;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    button,input,select{font:inherit}
    .app{min-height:100%;display:flex;flex-direction:column;}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: var(--stickyBg);
      border-bottom:1px solid var(--line);
      padding: 10px 12px calc(10px + env(safe-area-inset-top));
    }
    .topbar .row{display:flex;align-items:center;gap:10px;}
    .brand{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .brand b{font-weight:800;letter-spacing:.2px}
    .brand small{color:var(--muted)}
    .spacer{flex:1}
    .btn{
      border:1px solid var(--line);
      background: var(--card);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 12px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:transparent;background:var(--accent);color:white;}
    .btn.icon{width:42px;justify-content:center;padding:10px;}
    .seg{
      display:flex;gap:6px;padding:6px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
    }
    .seg button{
      border:0;background:transparent;color:var(--muted);
      padding:8px 10px;border-radius:10px;cursor:pointer;
    }
    .seg button.active{background:var(--card2);color:var(--fg);font-weight:700;}

    .content{flex:1;display:flex;flex-direction:column;min-height:0}
    .view{flex:1;min-height:0;display:none}
    .view.active{display:flex;flex-direction:column;min-height:0}

    .tableWrap{
      flex:1;min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:10px 0;
    }
    table{
      border-collapse: separate;
      border-spacing:0;
      width:max-content;
      min-width:100%;
      position:relative;
    }
    th,td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      height:var(--rowH);
      padding:6px 8px;
      vertical-align:middle;
      background:var(--bg);
      white-space:nowrap;
    }

    thead{
      position:sticky;
      top:0;
      z-index:15;
      background:var(--stickyBg);
      backdrop-filter: blur(10px);
    }
    thead tr{background:var(--stickyBg);}
    thead th{
      position:sticky;
      top:0;
      z-index:16;
      background:var(--stickyBg);
      backdrop-filter: blur(10px);
      font-weight:800;
    }

    th:first-child, td:first-child{border-left:1px solid var(--line);}
    tr:first-child th{border-top:1px solid var(--line);}

    .stickyLeft{
      position:sticky;left:0;z-index:8;
      background:var(--stickyBg);
      backdrop-filter: blur(10px);
      width:var(--leftW);
      min-width:var(--leftW);
      max-width:var(--leftW);
      border-right:1px solid var(--line);
    }
    th.stickyLeft{z-index:18}
    .corner{z-index:25 !important;}

    .leftCell{display:flex;align-items:center;gap:8px;min-width:0;}
    .leftText{min-width:0;overflow:hidden;text-overflow:ellipsis;}
    .blockRow .leftText{text-transform:uppercase;font-weight:900;letter-spacing:.8px;}
    .exRow .leftText{font-weight:800;text-transform:lowercase;padding-left:10px;}
    .wRow .leftText{font-weight:500;text-transform:lowercase;padding-left:22px;color:var(--muted);}
    .wRow .sideTag{
      font-size:11px;padding:2px 6px;border-radius:999px;
      border:1px solid var(--line);color:var(--muted);
      background:var(--card);flex:0 0 auto;
    }

    .exRow td{height:auto;white-space:normal;}
    .exRow .stickyLeft{white-space:normal;}
    .exRow .leftText{
      white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word;
    }

    .wRow td{height:auto;white-space:normal;}
    .wRow .stickyLeft{white-space:normal;}
    .wRow .leftText{
      white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word;
    }

    .tinyIcon{
      border:0;background:transparent;color:var(--muted);
      padding:6px;margin:-6px;cursor:pointer;
    }
    .tinyIcon:active{transform: translateY(1px)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);background:var(--card);
      color:var(--muted);font-size:12px;
    }

    td.cell{
      position:relative;
      cursor:pointer;
      background:var(--bg);
      min-width:96px;
      max-width:120px;
    }
    td.cell .val{
      font-weight:800;
      font-size:13px;
      line-height:1.1;
    }
    td.cell .sub{
      font-size:11px;color:var(--muted);
      margin-top:2px;
      overflow:hidden;text-overflow:ellipsis;
    }

    td.cell.empty .val{color:var(--muted);font-weight:400}
    td.cell:not(.empty) .sub{color:var(--fg);font-weight:800}

    td.cell.empty .sub{display:none}

    td.cell.gray{background:var(--grayFill);}
    td.cell.injury{background:var(--injuryFill);}
    td.cell.border-gold{box-shadow: inset 0 0 0 2px var(--gold);}
    td.cell.border-green{box-shadow: inset 0 0 0 2px var(--green);}
    td.cell.border-yellow{box-shadow: inset 0 0 0 2px var(--yellow);}

    .dateHead{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .dateHead .d{font-weight:900}
    .dateHead .trash{
      border:0;background:transparent;color:var(--muted);
      cursor:pointer;padding:6px;margin:-6px;border-radius:10px;
    }
    .dateHead .trash:active{transform: translateY(1px)}

    .hintRow{
      padding:0 12px 12px;
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      color:var(--muted);
    }

    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;z-index:100;}
    .overlay.show{display:block}
    .drawer{
      position:fixed;top:0;right:0;bottom:0;
      width:min(92vw,420px);
      background:var(--bg);
      border-left:1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:110;
      display:flex;flex-direction:column;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .drawer.show{transform: translateX(0)}
    .drawer header{
      display:flex;align-items:center;gap:10px;
      padding:6px 2px 10px;border-bottom:1px solid var(--line);
    }
    .drawer header b{font-size:16px}
    .drawer .body{flex:1;overflow:auto;padding-top:10px}
    .section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      margin-bottom:10px;
    }
    .section h3{
      margin:0 0 8px 0;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.8px;
      color:var(--muted);
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    .field label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="number"], select{
      border:1px solid var(--line);
      background:var(--bg);
      color:var(--fg);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    .rowActions{display:flex;gap:8px;flex-wrap:wrap}
    .danger{border-color:rgba(220,38,38,.35);color:var(--danger);background:transparent}

    .modalOverlay{
      position:fixed;inset:0;background:rgba(2,6,23,.38);
      display:none;z-index:200;padding:12px;
    }
    .modalOverlay.show{display:flex;align-items:center;justify-content:center}
    .modal{
      width:min(96vw,520px);
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      padding:12px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:var(--card);
    }
    .modal header b{font-size:14px}
    .modal main{padding:12px}
    .modal footer{
      padding:12px;border-top:1px solid var(--line);
      display:flex;gap:8px;justify-content:flex-end;
      background:var(--card);
    }
    .sets{display:flex;flex-direction:column;gap:8px;margin:8px 0 10px;}
    .setRow{display:flex;gap:8px;align-items:center;}
    .setRow input{flex:1}
    .setRow button{width:42px;}
    .toggleLine{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border:1px solid var(--line);
      border-radius:14px;background:var(--card);
      margin-top:8px;
    }
    .toggleLine .left{display:flex;align-items:center;gap:10px}
    .badge{
      font-size:12px;padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);background:var(--bg);color:var(--muted);
    }

    .analyticsWrap{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0;}
    .panel{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);padding:10px;}
    .panel h3{margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);}
    canvas{width:100%;height:180px;background:var(--bg);border:1px solid var(--line);border-radius:14px;display:block;}
    .insights{display:flex;flex-direction:column;gap:8px;color:var(--fg);}
    .insights .muted{color:var(--muted);font-size:12px}
    .kpiRow{display:flex;gap:8px;flex-wrap:wrap}
    .kpi{
      flex:1;min-width:130px;border:1px solid var(--line);
      border-radius:14px;background:var(--bg);padding:10px;
    }
    .kpi b{display:block;font-size:16px}
    .kpi small{color:var(--muted)}
    .legendLine{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:3px;border:2px solid transparent;display:inline-block}
    .dot.gold{border-color:var(--gold)}
    .dot.green{border-color:var(--green)}
    .dot.yellow{border-color:var(--yellow)}
    .dot.gray{background:var(--grayFill);border-color:var(--line)}
    .dot.pink{background:var(--injuryFill);border-color:var(--line)}

    @media (max-width: 380px){
      :root{ --leftW: 120px; --rowH: 42px; }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="row">
      <button class="btn icon" id="btnMenu" aria-label="–ú–µ–Ω—é">‚ò∞</button>
      <div class="brand">
        <b>Gym Progress</b>
        <small id="subTitle">offline ‚Ä¢ —Ç–∞–±–ª–∏—Ü–∞</small>
      </div>
      <div class="spacer"></div>
      <div class="seg" role="tablist" aria-label="–≠–∫—Ä–∞–Ω—ã">
        <button id="tabTable" class="active" role="tab" aria-selected="true">–¢–∞–±–ª–∏—Ü–∞</button>
        <button id="tabAnalytics" role="tab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>
      <button class="btn primary" id="btnAddWorkout">+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
      <button class="btn icon" id="btnHelp" aria-label="–õ–µ–≥–µ–Ω–¥–∞">?</button>
    </div>
  </div>

  <div class="content">
    <div class="hintRow" id="hintRow">
      <span class="pill">–¢–∞–ø –ø–æ —è—á–µ–π–∫–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
      <span class="pill">Long-press –ø–æ –¥–∞—Ç–µ (~0.7s) ‚Üí —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </div>

    <section class="view active" id="viewTable" aria-label="–¢–∞–±–ª–∏—Ü–∞">
      <div class="tableWrap" id="tableWrap"></div>
    </section>

    <section class="view" id="viewAnalytics" aria-label="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞">
      <div class="analyticsWrap">
        <div class="panel">
          <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
          <div class="grid2">
            <div class="field">
              <label>–ë–ª–æ–∫</label>
              <select id="anBlock"></select>
            </div>
            <div class="field">
              <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
              <select id="anExercise"></select>
            </div>
          </div>
          <div class="field" style="margin-bottom:0">
            <label>–ú–µ—Ç—Ä–∏–∫–∞</label>
            <select id="anMetric">
              <option value="volume">–û–±—ä—ë–º (sets √ó reps √ó weight)</option>
              <option value="reps">–ü–æ–≤—Ç–æ—Ä—ã (—Å—É–º–º–∞ reps)</option>
              <option value="records">–†–µ–∫–æ—Ä–¥—ã (–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)</option>
              <option value="injuries">–¢—Ä–∞–≤–º—ã (–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)</option>
            </select>
          </div>
        </div>

        <div class="panel">
          <h3>–ì—Ä–∞—Ñ–∏–∫</h3>
          <canvas id="chart" width="800" height="360"></canvas>
          <div class="legendLine" style="margin-top:8px; color:var(--muted); font-size:12px">
            <span>–ü—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫. –ú–∞—Å—à—Ç–∞–± –∞–≤—Ç–æ.</span>
          </div>
        </div>

        <div class="panel">
          <h3>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
          <div class="kpiRow" id="kpiRow"></div>
          <div class="insights" id="insights" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer" aria-label="–ú–µ–Ω—é">
  <header>
    <b>–ú–µ–Ω—é</b>
    <div class="spacer"></div>
    <button class="btn icon" id="btnCloseDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
  </header>

  <div class="body">
    <div class="section">
      <h3>–¢–µ–º–∞</h3>
      <div class="toggleLine">
        <div class="left">
          <span class="badge">üåô</span>
          <div>
            <b style="display:block">–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</b>
            <small style="color:var(--muted)">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</small>
          </div>
        </div>
        <button class="btn" id="btnTheme">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>

    <div class="section">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
      <div class="field">
        <label>–ë–ª–æ–∫</label>
        <select id="selBlockAddEx"></select>
      </div>
      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ö–æ—á–µ—à—å)</label>
        <input id="inExName" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∂–∏–º –ª—ë–∂–∞" />
      </div>
      <div class="rowActions">
        <button class="btn primary" id="btnAddExercise">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:12px">
        –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏, –Ω–æ –∏—Å—Ç–æ—Ä–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.
      </div>
    </div>

    <div class="section">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</h3>
      <div class="field">
        <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
        <select id="selExAddWeight"></select>
      </div>
      <div class="field">
        <label>–í–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 40 –∏–ª–∏ 60-50)</label>
        <input id="inWeightLabel" type="text" placeholder="40" />
      </div>
      <div class="rowActions">
        <button class="btn primary" id="btnAddWeight">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Å</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:12px">
        –í–µ—Å–∞ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é. ‚Äú60-50‚Äù —Å—Ç–∞–≤–∏—Ç—Å—è –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —á–∏—Å–ª—É (60).
      </div>
    </div>

    <div class="section">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
      <div class="field">
        <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
        <select id="selManageExercise"></select>
      </div>

      <div class="toggleLine" style="margin-top:0">
        <div class="left">
          <span class="badge">L/R</span>
          <div>
            <b style="display:block">Split L/R</b>
            <small style="color:var(--muted)">–†–∞–∑–¥–µ–ª—å–Ω—ã–π –≤–≤–æ–¥</small>
          </div>
        </div>
        <button class="btn" id="btnToggleSplit">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">üóÑÔ∏è</span>
          <div>
            <b style="display:block">–ê—Ä—Ö–∏–≤</b>
            <small style="color:var(--muted)">–°–∫—Ä—ã—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ (–Ω–µ —É–¥–∞–ª—è—Ç—å)</small>
          </div>
        </div>
        <button class="btn" id="btnToggleArchive">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div style="margin-top:10px">
        <div style="font-size:12px; color:var(--muted); margin-bottom:6px">–í–µ—Å–∞ (–ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç—å)</div>
        <div id="weightsList"></div>
      </div>

      <div style="margin-top:12px" class="rowActions">
        <button class="btn danger" id="btnDeleteExercise">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞‚Ä¶</button>
      </div>
      <div style="margin-top:6px; color:var(--muted); font-size:12px">
        –£–¥–∞–ª–µ–Ω–∏–µ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é. –ê—Ä—Ö–∏–≤ –æ–±—ã—á–Ω–æ –ª—É—á—à–µ.
      </div>
    </div>

    <div class="section">
      <h3>–î–∞–Ω–Ω—ã–µ</h3>
      <div class="rowActions">
        <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON</button>
        <button class="btn danger" id="btnReset">–°–±—Ä–æ—Å (seed)</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:12px">
        –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ LocalStorage. –ò–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.
      </div>
    </div>
  </div>
</aside>

<div class="modalOverlay" id="cellModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–†–µ–¥–∞–∫—Ç–æ—Ä">
    <header>
      <div>
        <b id="cellTitle">–Ø—á–µ–π–∫–∞</b><br/>
        <small id="cellSubtitle" style="color:var(--muted)"></small>
      </div>
      <button class="btn icon" id="btnCloseCellModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>
    <main>
      <div class="sets" id="setsWrap"></div>
      <div class="rowActions">
        <button class="btn" id="btnAddSet">+ —Å–µ—Ç</button>
        <button class="btn" id="btnClearSets">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">ü©π</span>
          <div>
            <b style="display:block">–¢—Ä–∞–≤–º–∞</b>
            <small style="color:var(--muted)">–†–æ–∑–æ–≤—ã–π —Ñ–æ–Ω, –Ω–æ —Å—Ç–∞—Ç—É—Å–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</small>
          </div>
        </div>
        <button class="btn" id="btnToggleInjury">–í—ã–∫–ª</button>
      </div>

      <div class="toggleLine">
        <div class="left">
          <span class="badge">‚≠ê</span>
          <div>
            <b style="display:block">–í –ø–ª–∞–Ω–µ</b>
            <small style="color:var(--muted)">–ü–æ–º–µ—Ç–∏—Ç—å –∑–≤–µ–∑–¥–æ—á–∫–æ–π –≤ —Ç–∞–±–ª–∏—Ü–µ</small>
          </div>
        </div>
        <button class="btn" id="btnTogglePlanned">–í—ã–∫–ª</button>
      </div>

    </main>
    <footer>
      <button class="btn" id="btnCancelCell">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveCell">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </footer>
  </div>
</div>

<div class="modalOverlay" id="infoModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–ò–Ω—Ñ–æ">
    <header>
      <b id="infoTitle">–ò–Ω—Ñ–æ</b>
      <button class="btn icon" id="btnCloseInfoModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>
    <main id="infoBody"></main>
    <footer>
      <button class="btn primary" id="btnCloseInfoModal2">–û–∫</button>
    </footer>
  </div>
</div>

<script>
const LS_KEY = "gymProgress.v1";
const DEFAULT_BLOCKS = ["–ì–†–£–î–¨","–ë–ò–¶–ï–ü–°","–°–ü–ò–ù–ê","–î–ï–õ–¨–¢–´","–ù–û–ì–ò"];

const STATUS = {
  RECORD: "record",
  NEW_WEIGHT: "new_weight",
  NEW_EX: "new_ex",
  NOT_RECORD: "not_record",
};

const nowId = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

const clampInt = (v) => {
  const n = parseInt(String(v||"").trim(), 10);
  return Number.isFinite(n) && n>=0 ? n : null;
};

function parseDDMMYYYY(s){
  if(!s) return null;
  const m = String(s).trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yyyy = +m[3];
  const d = new Date(yyyy, mm-1, dd);
  if(d.getFullYear()!==yyyy || (d.getMonth()+1)!==mm || d.getDate()!==dd) return null;
  return d;
}
function fmtDate(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function sortWorkoutsAsc(workouts){
  return [...workouts].sort((a,b)=>{
    const da = parseDDMMYYYY(a.date), db = parseDDMMYYYY(b.date);
    const ta = da?da.getTime():0, tb = db?db.getTime():0;
    return ta-tb;
  });
}
function sortWorkoutsDesc(workouts){
  return [...workouts].sort((a,b)=>{
    const da = parseDDMMYYYY(a.date), db = parseDDMMYYYY(b.date);
    const ta = da?da.getTime():0, tb = db?db.getTime():0;
    return tb-ta;
  });
}

function weightMaxNumber(label){
  const s = String(label||"").trim();
  const nums = s.match(/(\d+(?:[.,]\d+)?)/g);
  if(!nums) return Number.POSITIVE_INFINITY;
  let max = -Infinity;
  for(const t of nums){
    const n = parseFloat(t.replace(",","."));
    if(Number.isFinite(n)) max = Math.max(max,n);
  }
  return Number.isFinite(max) ? max : Number.POSITIVE_INFINITY;
}
function weightStepsFromLabel(weightLabel){
  const s = String(weightLabel||"").trim();
  if(!s.includes("-")) return 1;
  const parts = s.split("-").map(x=>x.trim()).filter(Boolean);
  if(parts.length < 2) return 1;
  const ok = parts.every(p => /(\d+(?:[.,]\d+)?)/.test(p));
  return ok ? parts.length : 1;
}
function parseRepsValue(raw, steps){
  const s = String(raw ?? "").trim();
  if(!s) return null;
  if(steps<=1){
    return clampInt(s);
  }
  const parts = s.split("-").map(x=>x.trim()).filter(x=>x.length>0);
  if(parts.length !== steps) return null;
  const nums = parts.map(clampInt);
  if(nums.some(n=>n==null)) return null;
  return nums.join("-");
}
function repsMeta(val, steps){
  if(steps<=1){
    const n = (typeof val === "number") ? val : clampInt(val);
    if(n==null) return null;
    return {parts:[n], prefixKey:"", last:n, str:String(n)};
  }
  if(typeof val !== "string") return null;
  const parts = val.split("-").map(x=>clampInt(x.trim()));
  if(parts.length !== steps) return null;
  if(parts.some(n=>n==null)) return null;
  const last = parts[parts.length-1];
  const prefixKey = parts.slice(0,-1).join("-");
  return {parts, prefixKey, last, str: parts.join("-")};
}

function seedState(){
  const mkW = (label) => ({id: nowId(), label, hidden:false});
  const mkE = (name, weights, splitLR=false) => ({
    id: nowId(), name, archived:false, splitLR,
    weights: weights.map(mkW)
  });
  const mkB = (name, exs) => ({id: nowId(), name, collapsed:false, exercises: exs});

  const w1 = {id: nowId(), date:"02.01.2026"};
  const w2 = {id: nowId(), date:"05.01.2026"};
  const w3 = {id: nowId(), date:"06.01.2026"};

  const chest = mkB("–ì–†–£–î–¨", [
    mkE("–∂–∏–º –ª—ë–∂–∞", ["40","50","60-50"]),
    mkE("—Ä–∞–∑–≤–æ–¥–∫–∞", ["10","12.5"])
  ]);
  const biceps = mkB("–ë–ò–¶–ï–ü–°", [
    mkE("–ø–æ–¥—ä—ë–º –Ω–∞ –±–∏—Ü–µ–ø—Å", ["10","12.5"], true)
  ]);
  const back = mkB("–°–ü–ò–ù–ê", [
    mkE("—Ç—è–≥–∞ –≤ –Ω–∞–∫–ª–æ–Ω–µ", ["40","50"])
  ]);
  const delts = mkB("–î–ï–õ–¨–¢–´", [
    mkE("–∂–∏–º —Å—Ç–æ—è", ["20","25"])
  ]);
  const legs = mkB("–ù–û–ì–ò", [
    mkE("–ø—Ä–∏—Å–µ–¥", ["40","60"])
  ]);

  const state = {
    theme: "light",
    blocks: [chest,biceps,back,delts,legs],
    workouts: [w1,w2,w3],
    entries: {}
  };

  const exBench = chest.exercises[0];
  const w40 = exBench.weights.find(x=>x.label==="40").id;
  const w50 = exBench.weights.find(x=>x.label==="50").id;

  state.entries[w1.id] = {
    [exBench.id]: {
      [w40]: {sets:[10,10], injury:false},
      [w50]: {sets:[8,8], injury:false}
    }
  };
  state.entries[w2.id] = {
    [exBench.id]: {
      [w40]: {sets:[11,10], injury:false},
      [w50]: {sets:[8,8,7], injury:false}
    }
  };

  const exCurl = biceps.exercises[0];
  const w10 = exCurl.weights.find(x=>x.label==="10").id;
  state.entries[w2.id][exCurl.id] = {
    [w10]: {
      L:{sets:[10,10], injury:false},
      R:{sets:[10,9], injury:false}
    }
  };

  state.workouts = sortWorkoutsAsc(state.workouts);
  for(const b of state.blocks){
    for(const e of b.exercises){
      e.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
    }
  }
  return state;
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return seedState();
    const st = JSON.parse(raw);
    if(!st || !Array.isArray(st.blocks) || !Array.isArray(st.workouts) || typeof st.entries!=="object"){
      return seedState();
    }
    st.workouts = sortWorkoutsAsc(st.workouts);
    st.theme = st.theme==="dark" ? "dark" : "light";
    for(const b of st.blocks){
      b.collapsed = !!b.collapsed;
      b.exercises = b.exercises || [];
      for(const e of b.exercises){
        e.archived = !!e.archived;
        e.splitLR = !!e.splitLR;
        e.weights = e.weights || [];
        for(const w of e.weights) w.hidden = !!w.hidden;
        e.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
      }
    }
    return st;
  }catch(e){
    console.warn("loadState failed", e);
    return seedState();
  }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

let state = loadState();

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const tableWrap = $("#tableWrap");
const subTitle = $("#subTitle");

const viewTable = $("#viewTable");
const viewAnalytics = $("#viewAnalytics");
const tabTable = $("#tabTable");
const tabAnalytics = $("#tabAnalytics");

const overlay = $("#overlay");
const drawer = $("#drawer");

const cellModalOverlay = $("#cellModalOverlay");
const infoModalOverlay = $("#infoModalOverlay");

const anBlock = $("#anBlock");
const anExercise = $("#anExercise");
const anMetric = $("#anMetric");
const chart = $("#chart");
const kpiRow = $("#kpiRow");
const insights = $("#insights");

function setTab(name){
  const isTable = name==="table";
  viewTable.classList.toggle("active", isTable);
  viewAnalytics.classList.toggle("active", !isTable);

  tabTable.classList.toggle("active", isTable);
  tabAnalytics.classList.toggle("active", !isTable);
  tabTable.setAttribute("aria-selected", String(isTable));
  tabAnalytics.setAttribute("aria-selected", String(!isTable));

  subTitle.textContent = isTable ? "offline ‚Ä¢ —Ç–∞–±–ª–∏—Ü–∞" : "offline ‚Ä¢ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞";
  if(!isTable) renderAnalytics();
}
tabTable.addEventListener("click", ()=>setTab("table"));
tabAnalytics.addEventListener("click", ()=>setTab("analytics"));

function applyTheme(){ document.documentElement.dataset.theme = state.theme==="dark" ? "dark" : "light"; }
applyTheme();

function openDrawer(){
  overlay.classList.add("show");
  drawer.classList.add("show");
  refreshMenuSelects();
}
function closeDrawer(){
  overlay.classList.remove("show");
  drawer.classList.remove("show");
}
$("#btnMenu").addEventListener("click", openDrawer);
$("#btnCloseDrawer").addEventListener("click", closeDrawer);
overlay.addEventListener("click", closeDrawer);

function showInfo(title, html){
  $("#infoTitle").textContent = title;
  $("#infoBody").innerHTML = html;
  infoModalOverlay.classList.add("show");
  infoModalOverlay.setAttribute("aria-hidden","false");
}
function closeInfo(){
  infoModalOverlay.classList.remove("show");
  infoModalOverlay.setAttribute("aria-hidden","true");
}
$("#btnHelp").addEventListener("click", ()=>{
  showInfo("–õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤", `
    <div style="display:flex; flex-direction:column; gap:10px">
      <div class="legendLine">
        <span class="dot gold"></span><b>–†–µ–∫–æ—Ä–¥</b><span style="color:var(--muted)">‚Äî –∑–æ–ª–æ—Ç–∞—è –æ–±–≤–æ–¥–∫–∞</span>
      </div>
      <div class="legendLine">
        <span class="dot green"></span><b>–ù–æ–≤—ã–π –≤–µ—Å</b><span style="color:var(--muted)">‚Äî –∑–µ–ª—ë–Ω–∞—è –æ–±–≤–æ–¥–∫–∞</span>
      </div>
      <div class="legendLine">
        <span class="dot yellow"></span><b>–ü–µ—Ä–≤—ã–π —Ä–∞–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</b><span style="color:var(--muted)">‚Äî –∂—ë–ª—Ç–∞—è –æ–±–≤–æ–¥–∫–∞</span>
      </div>
      <div class="legendLine">
        <span class="dot gray"></span><b>–ù–µ —Ä–µ–∫–æ—Ä–¥</b><span style="color:var(--muted)">‚Äî —Å–µ—Ä—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –±—ã–ª–∏ –ø—Ä–æ—à–ª—ã–µ –¥–∞–Ω–Ω—ã–µ)</span>
      </div>
      <div class="legendLine">
        <span class="dot pink"></span><b>–¢—Ä–∞–≤–º–∞</b><span style="color:var(--muted)">‚Äî —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–æ–±–≤–æ–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)</span>
      </div>
      <hr style="border:none; border-top:1px solid var(--line)">
      <div style="color:var(--muted); font-size:12px">
        <b>–¶–µ–ª—å ‚Äú–Ω–∞–¥–æ X‚Äù</b> –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—É—Å—Ç—ã—Ö —è—á–µ–π–∫–∞—Ö —Å–∞–º–æ–π —Å–≤–µ–∂–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–ø–æ –¥–∞—Ç–µ), –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –ø–æ —ç—Ç–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é+–≤–µ—Å—É.
      </div>
      <div style="color:var(--muted); font-size:12px">
        <b>–°–∏–º–≤–æ–ª ‚≠ê</b> ‚Äî —è—á–µ–π–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –≤ –ø–ª–∞–Ω–µ –Ω–∞ —Ç–µ–∫—É—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.
      </div>
    </div>
  `);
});
$("#btnCloseInfoModal").addEventListener("click", closeInfo);
$("#btnCloseInfoModal2").addEventListener("click", closeInfo);

$("#btnTheme").addEventListener("click", ()=>{
  state.theme = (state.theme==="dark") ? "light" : "dark";
  applyTheme();
  saveState();
});
$("#btnExport").addEventListener("click", ()=>{
  const json = JSON.stringify(state, null, 2);
  showInfo("–≠–∫—Å–ø–æ—Ä—Ç JSON", `
    <div style="display:flex; flex-direction:column; gap:10px">
      <div style="color:var(--muted); font-size:12px">–°–∫–æ–ø–∏—Ä—É–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –≥–¥–µ-–Ω–∏–±—É–¥—å. –≠—Ç–æ —Ç–≤–æ–π –±—ç–∫–∞–ø.</div>
      <textarea id="exportArea" style="width:100%; height:260px; padding:10px; border-radius:14px; border:1px solid var(--line); background:var(--bg); color:var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px"></textarea>
      <div class="rowActions">
        <button class="btn primary" id="btnCopyExport">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  `);
  setTimeout(()=>{
    const ta = $("#exportArea");
    if(ta){ ta.value = json; ta.focus(); ta.select(); }
    const btn = $("#btnCopyExport");
    if(btn){
      btn.addEventListener("click", ()=>{
        ta.select();
        document.execCommand("copy");
        btn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì";
        setTimeout(()=>btn.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 1200);
      });
    }
  },0);
});
$("#btnImport").addEventListener("click", ()=>{
  showInfo("–ò–º–ø–æ—Ä—Ç JSON", `
    <div style="display:flex; flex-direction:column; gap:10px">
      <div style="color:var(--muted); font-size:12px">
        –í—Å—Ç–∞–≤—å JSON. –ò–º–ø–æ—Ä—Ç <b>–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç</b> —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.
      </div>
      <textarea id="importArea" style="width:100%; height:260px; padding:10px; border-radius:14px; border:1px solid var(--line); background:var(--bg); color:var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px"></textarea>
      <div class="rowActions">
        <button class="btn danger" id="btnDoImport">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  `);
  setTimeout(()=>{
    const btn = $("#btnDoImport");
    const ta = $("#importArea");
    if(btn && ta){
      btn.addEventListener("click", ()=>{
        try{
          const obj = JSON.parse(ta.value);
          localStorage.setItem(LS_KEY, JSON.stringify(obj));
          state = loadState();
          applyTheme();
          renderAll();
          closeInfo();
        }catch(e){ alert("–û—à–∏–±–∫–∞ –≤ JSON!"); }
      });
    }
  },0);
});
$("#btnReset").addEventListener("click", ()=>{
  if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –∫ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º?")){
    state = seedState();
    saveState();
    applyTheme();
    renderAll();
    closeDrawer();
  }
});

function getEntry(wId, exId, weightId, side=null){
  const wEnt = state.entries[wId];
  if(!wEnt) return null;
  const exEnt = wEnt[exId];
  if(!exEnt) return null;
  const weEnt = exEnt[weightId];
  if(!weEnt) return null;
  if(side) return weEnt[side] || null;
  return weEnt;
}

function calcBest(exId, weightId, side=null, skipWorkoutId=null){
  let bestVal = -1;
  let bestEntry = null;
  let count = 0;

  const wSorted = sortWorkoutsAsc(state.workouts);
  for(const w of wSorted){
    if(w.id === skipWorkoutId) continue;
    const ent = getEntry(w.id, exId, weightId, side);
    if(ent && ent.sets && ent.sets.length > 0){
      count++;
      const last = ent.sets[ent.sets.length-1];
      if(last > bestVal){
        bestVal = last;
        bestEntry = ent;
      }
    }
  }
  return {bestVal, bestEntry, count};
}

function getExerciseStatus(wId, exId, weightId, side=null){
  const cur = getEntry(wId, exId, weightId, side);
  if(!cur || !cur.sets || cur.sets.length===0) return null;

  const {bestVal, bestEntry, count} = calcBest(exId, weightId, side, wId);
  const curLast = cur.sets[cur.sets.length-1];

  if(count === 0){
    let exUsed = false;
    for(const workout of state.workouts){
      if(workout.id === wId) continue;
      const wEnt = state.entries[workout.id];
      if(wEnt && wEnt[exId]) { exUsed = true; break; }
    }
    return exUsed ? STATUS.NEW_WEIGHT : STATUS.NEW_EX;
  }

  if(curLast > bestVal) return STATUS.RECORD;
  return STATUS.NOT_RECORD;
}

function renderAll(){
  renderTable();
  refreshMenuSelects();
  if(viewAnalytics.classList.contains("active")) renderAnalytics();
}

function renderTable(){
  const wSorted = sortWorkoutsDesc(state.workouts);
  const latestWorkoutId = wSorted.length > 0 ? wSorted[0].id : null;

  let h = `<table><thead><tr><th class="stickyLeft corner"></th>`;
  for(const w of wSorted){
    h += `<th data-wid="${w.id}">
            <div class="dateHead">
              <span class="d">${w.date.split('.').slice(0,2).join('.')}</span>
              <button class="trash" onclick="deleteWorkout('${w.id}')" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
            </div>
          </th>`;
  }
  h += `</tr></thead><tbody>`;

  for(const b of state.blocks){
    const visibleExs = b.exercises.filter(e => !e.archived);
    h += `<tr class="blockRow">
            <td class="stickyLeft" onclick="toggleBlock('${b.id}')">
              <div class="leftCell">
                <span class="tinyIcon">${b.collapsed?'+':'‚àí'}</span>
                <span class="leftText">${b.name}</span>
              </div>
            </td>
            <td colspan="${wSorted.length}"></td>
          </tr>`;
    
    if(!b.collapsed){
      for(const e of visibleExs){
        h += `<tr class="exRow">
                <td class="stickyLeft">
                  <div class="leftCell"><span class="leftText">${e.name}</span></div>
                </td>
                <td colspan="${wSorted.length}"></td>
              </tr>`;
        
        const visibleWeights = e.weights.filter(w => !w.hidden);
        for(const weight of visibleWeights){
          const steps = weightStepsFromLabel(weight.label);
          if(!e.splitLR){
            h += renderWeightRow(wSorted, b, e, weight, steps, null, latestWorkoutId);
          } else {
            h += renderWeightRow(wSorted, b, e, weight, steps, "L", latestWorkoutId);
            h += renderWeightRow(wSorted, b, e, weight, steps, "R", latestWorkoutId);
          }
        }
      }
    }
  }
  h += `</tbody></table>`;
  tableWrap.innerHTML = h;
  attachTableEvents();
}

function renderWeightRow(workouts, block, ex, weight, steps, side, latestWorkoutId){
  let h = `<tr class="wRow">
            <td class="stickyLeft">
              <div class="leftCell">
                <span class="leftText">${weight.label}</span>
                ${side ? `<span class="sideTag">${side}</span>` : ''}
              </div>
            </td>`;
  
  for(const w of workouts){
    const ent = getEntry(w.id, ex.id, weight.id, side);
    const st = getExerciseStatus(w.id, ex.id, weight.id, side);
    
    let cls = "cell";
    if(!ent || !ent.sets || ent.sets.length===0) cls += " empty";
    if(ent && ent.injury) cls += " injury";
    if(st === STATUS.RECORD) cls += " border-gold";
    else if(st === STATUS.NEW_WEIGHT) cls += " border-green";
    else if(st === STATUS.NEW_EX) cls += " border-yellow";
    else if(st === STATUS.NOT_RECORD) cls += " gray";

    let valStr = "";
    let subStr = "";

    if(ent && ent.sets && ent.sets.length > 0){
      valStr = ent.sets.join(" ‚Ä¢ ");
      subStr = ent.sets[ent.sets.length-1];
    } else {
      const {bestVal, bestEntry, count} = calcBest(ex.id, weight.id, side, null);
      if(count > 0 && w.id === latestWorkoutId){
        valStr = "–Ω–∞–¥–æ " + bestVal;
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤–µ–∑–¥–æ—á–∫—É, –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –ø–æ–º–µ—á–µ–Ω–∞ –≤ –ø–ª–∞–Ω–µ
        if(ent && ent.planned) valStr += " ‚≠ê";
      }
    }

    h += `<td class="${cls}" 
              onclick="openCellModal('${w.id}','${ex.id}','${weight.id}','${side||''}')">
            <div class="val">${valStr}</div>
            <div class="sub">${subStr}</div>
          </td>`;
  }
  h += `</tr>`;
  return h;
}

function attachTableEvents(){
  $$("thead th[data-wid]").forEach(th => {
    let timer;
    const wid = th.dataset.wid;
    const start = () => { timer = setTimeout(() => showWorkoutStats(wid), 700); };
    const cancel = () => clearTimeout(timer);
    th.addEventListener("mousedown", start);
    th.addEventListener("touchstart", start);
    th.addEventListener("mouseup", cancel);
    th.addEventListener("mouseleave", cancel);
    th.addEventListener("touchend", cancel);
  });
}

function showWorkoutStats(wid){
  const w = state.workouts.find(x=>x.id===wid);
  if(!w) return;
  const wEnt = state.entries[wid] || {};
  let vol = 0, setsC = 0, recC = 0, injC = 0;

  for(const eid in wEnt){
    const ex = findEx(eid);
    if(!ex) continue;
    for(const wid2 in wEnt[eid]){
      const weigh = ex.weights.find(x=>x.id===wid2);
      if(!weigh) continue;
      const wVal = weightMaxNumber(weigh.label);
      const obj = wEnt[eid][wid2];

      const process = (ent, side=null) => {
        if(ent && ent.sets && ent.sets.length > 0){
          setsC += ent.sets.length;
          ent.sets.forEach(r => { vol += (r * wVal); });
          if(ent.injury) injC++;
          if(getExerciseStatus(wid, eid, wid2, side) === STATUS.RECORD) recC++;
        }
      };

      if(obj.sets) process(obj);
      else { if(obj.L) process(obj.L, "L"); if(obj.R) process(obj.R, "R"); }
    }
  }

  showInfo(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${w.date}`, `
    <div style="display:flex; flex-direction:column; gap:8px">
      <div class="kpi"><b>${vol.toLocaleString()}</b><small>–û–±—â–∏–π –æ–±—ä—ë–º (–∫–≥)</small></div>
      <div class="kpiRow">
        <div class="kpi"><b>${setsC}</b><small>–í—Å–µ–≥–æ —Å–µ—Ç–æ–≤</small></div>
        <div class="kpi"><b>${recC}</b><small>–†–µ–∫–æ—Ä–¥–æ–≤</small></div>
        <div class="kpi"><b>${injC}</b><small>–¢—Ä–∞–≤–º</small></div>
      </div>
    </div>
  `);
}

function findEx(id){
  for(const b of state.blocks) for(const e of b.exercises) if(e.id===id) return e;
  return null;
}
function toggleBlock(bid){
  const b = state.blocks.find(x=>x.id===bid);
  if(b){ b.collapsed = !b.collapsed; saveState(); renderTable(); }
}
function deleteWorkout(wid){
  if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–π?")){
    state.workouts = state.workouts.filter(x=>x.id!==wid);
    delete state.entries[wid];
    saveState(); renderTable();
  }
}

let curCell = { wid:null, eid:null, weightId:null, side:null };

function openCellModal(wid, eid, weightId, side){
  curCell = { wid, eid, weightId, side: side || null };
  const w = state.workouts.find(x=>x.id===wid);
  const ex = findEx(eid);
  const weigh = ex.weights.find(x=>x.id===weightId);
  const ent = getEntry(wid, eid, weightId, curCell.side);

  $("#cellTitle").textContent = ex.name;
  $("#cellSubtitle").textContent = `${w.date} ‚Ä¢ ${weigh.label}${curCell.side ? ' ('+curCell.side+')' : ''}`;
  
  const steps = weightStepsFromLabel(weigh.label);
  const setsWrap = $("#setsWrap");
  setsWrap.innerHTML = "";

  const initialSets = (ent && ent.sets) ? ent.sets : [];
  initialSets.forEach(val => addSetRow(val, steps));
  if(initialSets.length === 0) addSetRow("", steps);

  const isInj = !!(ent && ent.injury);
  $("#btnToggleInjury").textContent = isInj ? "–í–∫–ª" : "–í—ã–∫–ª";
  $("#btnToggleInjury").className = isInj ? "btn primary" : "btn";

  const isPlanned = !!(ent && ent.planned);
  $("#btnTogglePlanned").textContent = isPlanned ? "–í–∫–ª" : "–í—ã–∫–ª";
  $("#btnTogglePlanned").className = isPlanned ? "btn primary" : "btn";

  cellModalOverlay.classList.add("show");
  cellModalOverlay.setAttribute("aria-hidden","false");
}

function addSetRow(val, steps){
  const div = document.createElement("div");
  div.className = "setRow";
  const placeholder = steps > 1 ? "–Ω–∞–ø—Ä: 10-8" : "10";
  div.innerHTML = `<input type="text" value="${val}" placeholder="${placeholder}" inputmode="decimal">
                   <button class="btn icon">√ó</button>`;
  div.querySelector("button").onclick = () => div.remove();
  $("#setsWrap").appendChild(div);
}

$("#btnAddSet").onclick = () => {
  const ex = findEx(curCell.eid);
  const weigh = ex.weights.find(x=>x.id===curCell.weightId);
  addSetRow("", weightStepsFromLabel(weigh.label));
};
$("#btnClearSets").onclick = () => { $("#setsWrap").innerHTML = ""; };

$("#btnToggleInjury").onclick = function(){
  const active = this.classList.contains("primary");
  if(active){ this.classList.remove("primary"); this.textContent="–í—ã–∫–ª"; }
  else { this.classList.add("primary"); this.textContent="–í–∫–ª"; }
};

$("#btnTogglePlanned").onclick = function(){
  const active = this.classList.contains("primary");
  if(active){ this.classList.remove("primary"); this.textContent="–í—ã–∫–ª"; }
  else { this.classList.add("primary"); this.textContent="–í–∫–ª"; }
};

function closeCellModal(){
  cellModalOverlay.classList.remove("show");
  cellModalOverlay.setAttribute("aria-hidden","true");
}
$("#btnCloseCellModal").onclick = closeCellModal;
$("#btnCancelCell").onclick = closeCellModal;

$("#btnSaveCell").onclick = () => {
  const ex = findEx(curCell.eid);
  const weigh = ex.weights.find(x=>x.id===curCell.weightId);
  const steps = weightStepsFromLabel(weigh.label);
  
  const inputs = $$("#setsWrap input");
  const newSets = [];
  inputs.forEach(inp => {
    const v = parseRepsValue(inp.value, steps);
    if(v !== null) newSets.push(v);
  });

  const isInj = $("#btnToggleInjury").classList.contains("primary");
  const isPlanned = $("#btnTogglePlanned").classList.contains("primary");

  if(!state.entries[curCell.wid]) state.entries[curCell.wid] = {};
  if(!state.entries[curCell.wid][curCell.eid]) state.entries[curCell.wid][curCell.eid] = {};
  
  let target = state.entries[curCell.wid][curCell.eid];
  if(curCell.side){
    if(!target[curCell.weightId]) target[curCell.weightId] = {};
    target[curCell.weightId][curCell.side] = { sets: newSets, injury: isInj, planned: isPlanned };
  } else {
    target[curCell.weightId] = { sets: newSets, injury: isInj, planned: isPlanned };
  }

  saveState(); renderTable(); closeCellModal();
};

$("#btnAddWorkout").onclick = () => {
  const dStr = prompt("–î–∞—Ç–∞ (–î–î.–ú–ú.–ì–ì–ì–ì):", fmtDate(new Date()));
  if(!dStr) return;
  if(!parseDDMMYYYY(dStr)){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã!"); return; }
  state.workouts.push({ id: nowId(), date: dStr });
  state.workouts = sortWorkoutsAsc(state.workouts);
  saveState(); renderTable();
};

function refreshMenuSelects(){
  const sB = $("#selBlockAddEx");
  sB.innerHTML = state.blocks.map(b => `<option value="${b.id}">${b.name}</option>`).join("");

  const allExs = [];
  state.blocks.forEach(b => b.exercises.forEach(e => allExs.push({e, bName:b.name})));
  
  const optExs = allExs.map(item => `<option value="${item.e.id}">${item.bName} ‚Äî ${item.e.name}${item.e.archived?' (–∞—Ä—Ö–∏–≤)':''}</option>`).join("");
  $("#selExAddWeight").innerHTML = optExs;
  $("#selManageExercise").innerHTML = optExs;

  const curMid = $("#selManageExercise").value;
  updateWeightsList(curMid);
}

$("#selManageExercise").onchange = (e) => updateWeightsList(e.target.value);

function updateWeightsList(eid){
  const ex = findEx(eid);
  const list = $("#weightsList");
  if(!ex){ list.innerHTML = ""; return; }

  $("#btnToggleSplit").className = ex.splitLR ? "btn primary" : "btn";
  $("#btnToggleArchive").className = ex.archived ? "btn primary" : "btn";
  $("#btnToggleArchive").textContent = ex.archived ? "–í –∞—Ä—Ö–∏–≤–µ" : "–ê–∫—Ç–∏–≤–Ω–æ";

  list.innerHTML = ex.weights.map(w => `
    <div class="toggleLine" style="padding:6px 10px; margin-top:4px">
      <span>${w.label}</span>
      <button class="btn ${w.hidden?'':'primary'}" onclick="toggleWeightHidden('${ex.id}','${w.id}')">
        ${w.hidden?'–°–∫—Ä—ã—Ç':'–ü–æ–∫–∞–∑'}
      </button>
    </div>
  `).join("");
}

function toggleWeightHidden(eid, wid){
  const ex = findEx(eid);
  const w = ex.weights.find(x=>x.id===wid);
  if(w){ w.hidden = !w.hidden; saveState(); renderTable(); updateWeightsList(eid); }
}

$("#btnAddExercise").onclick = () => {
  const bid = $("#selBlockAddEx").value;
  const name = $("#inExName").value.trim();
  if(!name) return;
  const b = state.blocks.find(x=>x.id===bid);
  b.exercises.push({ id:nowId(), name, archived:false, splitLR:false, weights:[] });
  $("#inExName").value = "";
  saveState(); renderTable(); refreshMenuSelects();
};

$("#btnAddWeight").onclick = () => {
  const eid = $("#selExAddWeight").value;
  const label = $("#inWeightLabel").value.trim();
  if(!label) return;
  const ex = findEx(eid);
  ex.weights.push({ id:nowId(), label, hidden:false });
  ex.weights.sort((a,b)=> weightMaxNumber(a.label)-weightMaxNumber(b.label));
  $("#inWeightLabel").value = "";
  saveState(); renderTable(); refreshMenuSelects();
};

$("#btnToggleSplit").onclick = () => {
  const ex = findEx($("#selManageExercise").value);
  if(ex){ ex.splitLR = !ex.splitLR; saveState(); renderTable(); updateWeightsList(ex.id); }
};
$("#btnToggleArchive").onclick = () => {
  const ex = findEx($("#selManageExercise").value);
  if(ex){ ex.archived = !ex.archived; saveState(); renderTable(); updateWeightsList(ex.id); }
};
$("#btnDeleteExercise").onclick = () => {
  const eid = $("#selManageExercise").value;
  if(confirm("–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ù–ê–í–°–ï–ì–î–ê –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π?")){
    for(const b of state.blocks){
      const idx = b.exercises.findIndex(x=>x.id===eid);
      if(idx!==-1){ b.exercises.splice(idx,1); break; }
    }
    for(const wid in state.entries) if(state.entries[wid][eid]) delete state.entries[wid][eid];
    saveState(); renderTable(); refreshMenuSelects();
  }
};

function renderAnalytics(){
  const bSel = $("#anBlock");
  const eSel = $("#anExercise");
  
  const oldB = bSel.value;
  const oldE = eSel.value;

  bSel.innerHTML = `<option value="ALL">–í–°–ï –ë–õ–û–ö–ò</option>` + 
    state.blocks.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
  
  if(oldB) bSel.value = oldB;
  const curB = bSel.value;

  let exs = [];
  state.blocks.forEach(b => {
    if(curB==="ALL" || b.id===curB) b.exercises.forEach(e => exs.push(e));
  });
  eSel.innerHTML = `<option value="ALL">–í–°–ï –£–ü–† (—Ç–æ–ª—å–∫–æ —Ä–µ–∫–æ—Ä–¥—ã/—Ç—Ä–∞–≤–º—ã)</option>` +
    exs.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  
  if(oldE) eSel.value = oldE;
  
  updateChart();
}

$("#anBlock").onchange = () => { renderAnalytics(); };
$("#anExercise").onchange = updateChart;
$("#anMetric").onchange = updateChart;

function updateChart(){
  const eid = $("#anExercise").value;
  const metric = $("#anMetric").value;
  const ctx = chart.getContext("2d");
  const wSorted = sortWorkoutsAsc(state.workouts);
  
  let data = [];
  wSorted.forEach(w => {
    let val = 0;
    const wEnt = state.entries[w.id] || {};

    const sumEx = (exId) => {
      const ex = findEx(exId);
      if(!ex || !wEnt[exId]) return;
      for(const wid2 in wEnt[exId]){
        const weigh = ex.weights.find(x=>x.id===wid2);
        if(!weigh) continue;
        const wKg = weightMaxNumber(weigh.label);
        const obj = wEnt[exId][wid2];
        const process = (ent) => {
          if(!ent || !ent.sets) return;
          if(metric==="volume") ent.sets.forEach(r => val += (r * wKg));
          else if(metric==="reps") ent.sets.forEach(r => val += r);
          else if(metric==="records"){ if(getExerciseStatus(w.id, exId, wid2)===STATUS.RECORD) val++; }
          else if(metric==="injuries"){ if(ent.injury) val++; }
        };
        if(obj.sets) process(obj);
        else { process(obj.L); process(obj.R); }
      }
    };

    if(eid === "ALL") state.blocks.forEach(b => b.exercises.forEach(e => sumEx(e.id)));
    else sumEx(eid);

    data.push({ date: w.date.split('.').slice(0,2).join('.'), val });
  });

  const maxV = Math.max(...data.map(d=>d.val), 1);
  const W = chart.width, H = chart.height;
  ctx.clearRect(0,0,W,H);
  
  if(data.length < 2){
    ctx.fillStyle = "gray"; ctx.textAlign="center";
    ctx.fillText("–ú–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞", W/2, H/2);
    return;
  }

  const pad = 40;
  const stepX = (W - pad*2) / (data.length - 1);
  
  ctx.beginPath();
  ctx.strokeStyle = "rgba(37, 99, 235, 0.2)";
  for(let i=0; i<=4; i++){
    let y = pad + i*(H-pad*2)/4;
    ctx.moveTo(pad, y); ctx.lineTo(W-pad, y);
  }
  ctx.stroke();

  ctx.beginPath();
  ctx.lineWidth = 3; ctx.strokeStyle = "#2563eb"; ctx.lineJoin = "round";
  data.forEach((d, i) => {
    const x = pad + i*stepX;
    const y = H - pad - (d.val/maxV)*(H-pad*2);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle = "var(--muted)"; ctx.font = "10px sans-serif"; ctx.textAlign="center";
  data.forEach((d, i) => {
    if(data.length > 10 && i % Math.ceil(data.length/10) !== 0) return;
    const x = pad + i*stepX;
    ctx.fillText(d.date, x, H-15);
  });

  let total = 0, maxFound = 0, count = 0;
  data.forEach(d => { total += d.val; if(d.val > maxFound) maxFound = d.val; if(d.val>0) count++; });
  
  kpiRow.innerHTML = `
    <div class="kpi"><b>${total.toLocaleString()}</b><small>–í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</small></div>
    <div class="kpi"><b>${maxFound.toLocaleString()}</b><small>–ú–∞–∫—Å–∏–º—É–º</small></div>
    <div class="kpi"><b>${count}</b><small>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</small></div>
  `;
}

renderAll();
</script>
</body>
</html>
