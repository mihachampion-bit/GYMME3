<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gym Progress Tracker ‚Äî Offline (Single File)</title>
  <meta name="description" content="Offline-first single-file gym tracker: blocks‚Üíexercises‚Üíweights, workouts table, PR logic, injuries, analytics, JSON backup." />
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7f9;
      --panel2:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --gold:#f5c542;
      --green:#22c55e;
      --yellow:#fbbf24;
      --injury:#ef4444;
      --gray:#e5e7eb;
      --shadow: 0 12px 30px rgba(0,0,0,.07);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --cellw: 150px;
      --rowheadw: 360px;
    }
    [data-theme="dark"]{
      --bg:#0b0c0f;
      --panel:#14151b;
      --panel2:#0f1116;
      --text:#f3f4f6;
      --muted:#9aa4b2;
      --border:#252833;
      --accent:#60a5fa;
      --accent2:#22d3ee;
      --gray:#2a2f3a;
      --shadow: 0 16px 36px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{ font-family:var(--sans); background:var(--bg); color:var(--text); }

    /* Topbar */
    .app{ height:100%; display:flex; flex-direction:column; }
    .topbar{
      position:sticky; top:0; z-index:20;
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, var(--panel2), var(--bg));
    }
    .brand{ font-weight:900; display:flex; align-items:center; gap:10px; }
    .brand .dot{
      width:10px; height:10px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 80%);
    }
    .pill{
      font-size:12px; padding:3px 8px; border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: color-mix(in oklab, var(--panel2), var(--panel) 55%);
      user-select:none;
    }
    .spacer{ flex:1; }

    .tabs{
      display:flex; gap:4px; padding:4px;
      border:1px solid var(--border);
      border-radius:999px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 45%);
    }
    .tab{
      border:0; background:transparent;
      padding:7px 10px; border-radius:999px;
      cursor:pointer; font-weight:850;
      color:var(--muted);
    }
    .tab.active{
      background:var(--panel2);
      color:var(--text);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }

    .btn{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
      font-weight:800;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ border-color: color-mix(in oklab, var(--border), var(--text) 18%); }
    .btn.primary{
      background: color-mix(in oklab, var(--accent), var(--panel2) 90%);
      border-color: color-mix(in oklab, var(--accent), var(--border) 45%);
    }
    .btn.danger{
      background: color-mix(in oklab, var(--injury), var(--panel2) 92%);
      border-color: color-mix(in oklab, var(--injury), var(--border) 45%);
    }
    .btn.ghost{
      background:transparent; border-color:transparent;
      color:var(--muted); box-shadow:none;
    }
    .btn.small{ padding:5px 8px; border-radius:9px; font-weight:850; }
    .btn.icon{ padding:7px 8px; }

    .tog{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); background:var(--panel2);
      padding:7px 10px; border-radius:999px;
    }
    .switch{
      width:36px; height:20px; border-radius:999px;
      background: color-mix(in oklab, var(--panel), var(--panel2) 30%);
      position:relative;
      border:1px solid var(--border);
      cursor:pointer;
    }
    .switch::after{
      content:"";
      position:absolute; top:50%; transform:translateY(-50%);
      left:2px; width:16px; height:16px; border-radius:50%;
      background:var(--panel2);
      border:1px solid var(--border);
      transition: all .18s ease;
    }
    .switch.on{
      background: color-mix(in oklab, var(--accent), var(--panel2) 82%);
      border-color: color-mix(in oklab, var(--accent), var(--border) 45%);
    }
    .switch.on::after{ left:18px; }

    /* Main layout */
    .main{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns: 380px 1fr 320px;
    }
    .panel{
      min-height:0;
      background:var(--panel);
      border-right:1px solid var(--border);
      overflow:auto;
    }
    .panel.right{
      border-right:none; border-left:1px solid var(--border);
    }
    .panel .inner{ padding:12px; }
    h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.3px;
      text-transform:uppercase;
      color:var(--muted);
    }

    /* Mobile drawer for left panel */
    .drawerBtn{ display:none; }
    .drawerBackdrop{
      display:none; position:fixed; inset:0; z-index:40;
      background: rgba(0,0,0,.35);
    }
    .drawer{
      display:none; position:fixed; top:0; left:0; bottom:0;
      width:min(92vw, 420px); z-index:50;
      background:var(--panel);
      border-right:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:auto;
    }
    .drawer .inner{ padding:12px; }
    .drawerHeader{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      position:sticky; top:0;
      z-index:2;
    }

    @media (max-width: 1120px){
      .main{ grid-template-columns: 380px 1fr; }
      .panel.right{ display:none; }
    }
    @media (max-width: 900px){
      .main{ grid-template-columns: 1fr; }
      .panel.left{ display:none; }
      .panel.right{ display:none; }
      .drawerBtn{ display:inline-flex; }
      .drawer, .drawerBackdrop{ display:block; }
      .drawer{ transform: translateX(-105%); transition: transform .22s ease; }
      .drawer.open{ transform: translateX(0); }
      .drawerBackdrop{ opacity:0; pointer-events:none; transition: opacity .22s ease; }
      .drawerBackdrop.open{ opacity:1; pointer-events:auto; }
    }

    /* Cards / structure */
    .card{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .hint{
      border:1px dashed var(--border);
      border-radius:var(--radius);
      padding:10px 12px;
      color:var(--muted);
      background: color-mix(in oklab, var(--panel2), var(--panel) 45%);
      line-height:1.35;
    }
    .hint b{ color:var(--text); }
    .mini{ font-size:12px; color:var(--muted); }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .list{ display:flex; flex-direction:column; gap:10px; }

    .block{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow);
      padding:10px;
      display:flex; flex-direction:column; gap:10px;
    }

    /* ====== HIERARCHY (left) ====== */
    .blockHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      cursor:pointer;
      user-select:none;
    }
    .blockTitle{
      font-weight:1000;
      font-size:18px;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .chev{
      width:22px; height:22px; border-radius:8px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--panel2), var(--panel) 35%);
      color:var(--muted);
      font-weight:1000;
      flex:0 0 auto;
    }
    .blockCollapsed .chev{ transform: rotate(-90deg); }

    .exList{ margin-left:18px; display:flex; flex-direction:column; gap:10px; }
    .exItem{
      display:flex; align-items:flex-start; justify-content:space-between; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 15%);
    }
    .exLeft{ min-width:0; flex:1; }
    .exName{
      font-weight:500; /* –ù–ï –∂–∏—Ä–Ω—ã–π */
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .exMeta{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
    .tag{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--panel2), var(--panel) 40%);
      color:var(--muted);
    }
    .exBtns{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

    .weightsBox{
      margin-top:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 10%);
    }
    .weightsRow{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .wChip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:var(--panel2);
      padding:4px 8px;
      border-radius:999px;
      font-family:var(--mono);
      font-size:12px;
      user-select:none;
    }
    .wChip.hidden{ opacity:.45; text-decoration: line-through; }
    .wChip button{
      border:0; background:transparent; cursor:pointer;
      color:var(--muted); font-weight:1000; padding:0 2px;
    }

    /* Center: table */
    .center{ min-height:0; background:var(--bg); }
    .center .inner{
      padding:12px; height:100%; min-height:0;
      display:flex; flex-direction:column; gap:10px;
    }
    .tableWrap{
      flex:1; min-height:0;
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--panel2);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }
    .tableHeader{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel), var(--panel2) 25%), var(--panel2));
    }
    .field{
      display:flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:999px;
      padding:6px 10px;
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .field select{
      border:0; outline:none; background:transparent;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .tableScroll{ flex:1; overflow:auto; position:relative; }
    .grid{
      display:grid;
      grid-auto-rows:minmax(34px, auto);
      min-width: 900px;
    }
    .th, .td, .rowhead{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:7px 8px;
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--panel2);
      min-width: var(--cellw);
    }
    .th{
      font-weight:950;
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel), var(--panel2) 25%), var(--panel2));
      position:sticky; top:0; z-index:5;
      user-select:none;
    }
    .th.workout{ cursor:pointer; }

    /* delete workout button */
    .wHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:8px; width:100%;
    }
    .wDel{
      border:1px solid var(--border);
      background:transparent;
      border-radius:10px;
      padding:4px 7px;
      cursor:pointer;
      color:var(--muted);
      font-weight:950;
      opacity:.75;
    }
    .wDel:hover{ opacity:1; }

    .th.workout.selected{
      outline:2px solid color-mix(in oklab, var(--accent), transparent 60%);
      outline-offset:-2px;
    }
    .rowhead{
      position:sticky; left:0; z-index:4;
      min-width: var(--rowheadw); max-width: var(--rowheadw);
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel2), var(--panel) 10%), var(--panel2));
    }
    .corner{
      position:sticky; top:0; left:0; z-index:7;
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel), var(--panel2) 20%), var(--panel2));
    }
    .rowhead .path{ display:flex; flex-direction:column; line-height:1.15; overflow:hidden; }
    .path .l1{ font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .path .l2{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* ====== HIERARCHY (table) ====== */
    .blockSep{
      background: color-mix(in oklab, var(--panel), var(--panel2) 40%);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .blockSep .l1{ font-size:16px; }
    .exerciseHead{
      background: color-mix(in oklab, var(--panel2), var(--panel) 10%);
    }
    .exerciseHead .l1{
      font-weight:600; /* –Ω–µ –∂–∏—Ä–Ω—ã–π */
      font-size:14px;
    }
    .weightRow .l1{
      font-weight:900;
      font-family:var(--mono);
    }
    .weightIndent{
      padding-left:18px;
    }

    .td{ cursor:pointer; }
    .td:focus{ outline:2px solid color-mix(in oklab, var(--accent2), transparent 55%); outline-offset:-2px; }
    .cell{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      min-width:0;
    }
    .cell .val{
      font-family:var(--mono);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 120px;
    }
    .cell .goal{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      margin-left:auto;
    }
    .injBtn{
      border:1px solid var(--border);
      background:transparent;
      border-radius:9px;
      padding:3px 7px;
      cursor:pointer;
      opacity:0;
      margin-left:6px;
      user-select:none;
    }
    .td:hover .injBtn{ opacity:1; }

    /* Cell colors */
    .td[data-color="gold"]{ background: color-mix(in oklab, var(--gold), var(--panel2) 84%); }
    .td[data-color="green"]{ background: color-mix(in oklab, var(--green), var(--panel2) 88%); }
    .td[data-color="yellow"]{ background: color-mix(in oklab, var(--yellow), var(--panel2) 88%); }
    .td[data-color="gray"]{ background: var(--panel2); }
    .td[data-color="injury"]{
      background: color-mix(in oklab, var(--injury), var(--panel2) 84%);
      box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--injury), transparent 55%);
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,.35);
      z-index:60;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width:min(720px, 100%);
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, color-mix(in oklab, var(--panel), var(--panel2) 22%), var(--panel2));
    }
    .modalTitle{ font-weight:950; }
    .modalBody{ padding:14px; display:grid; grid-template-columns: 1fr 280px; gap:12px; }
    @media (max-width: 780px){
      .modalBody{ grid-template-columns: 1fr; }
    }
    .setsBox{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 8%);
    }
    .setsRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .setsRow input{
      width:72px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
      font-family:var(--mono);
      font-weight:900;
      outline:none;
    }
    .setsRow input:focus{ border-color: color-mix(in oklab, var(--accent2), var(--border) 50%); }
    textarea{
      width:100%;
      min-height:88px;
      resize:vertical;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
      font-family:var(--mono);
      outline:none;
    }
    textarea:focus{ border-color: color-mix(in oklab, var(--accent2), var(--border) 50%); }

    .sideBox{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 8%);
    }
    .sideTabs{
      display:flex; gap:6px;
      padding:6px; border:1px solid var(--border); border-radius:999px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 20%);
      width:max-content;
    }
    .sideTab{
      border:0; background:transparent;
      padding:6px 10px; border-radius:999px;
      cursor:pointer; font-weight:950;
      color:var(--muted);
    }
    .sideTab.active{
      background:var(--panel2);
      color:var(--text);
    }

    .kv{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; }
    .kv .k{ color:var(--muted); font-size:12px; }
    .kv .v{ font-weight:950; font-family:var(--mono); }

    /* Right stats */
    .statsGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .stat{
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
    }
    .stat .n{ font-size:18px; font-weight:950; }
    .stat .k{ font-size:12px; color:var(--muted); }

    /* Analytics */
    .analytics{ display:none; }
    .analytics.open{ display:block; height:100%; }
    .analyticsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .analyticsGrid{ grid-template-columns: 1fr; }
    }
    canvas{
      width:100%;
      height:240px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel2);
      box-shadow: var(--shadow);
    }
    .note{
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: color-mix(in oklab, var(--panel2), var(--panel) 14%);
      color:var(--muted);
      line-height:1.35;
    }
    .note b{ color:var(--text); }
  </style>
</head>

<body>
<div class="app" id="app" data-theme="light">
  <div class="topbar">
    <button class="btn icon drawerBtn" id="btnDrawer" title="–ú–µ–Ω—é">‚ò∞</button>

    <div class="brand"><span class="dot"></span> Gym Tracker <span class="pill">offline ‚Ä¢ single file</span></div>

    <div class="tabs" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
      <button class="tab active" id="tabTable" role="tab" aria-selected="true">–¢–∞–±–ª–∏—Ü–∞</button>
      <button class="tab" id="tabAnalytics" role="tab" aria-selected="false">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <button class="btn primary" id="btnAddWorkout">+ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>

    <div class="tog" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span class="mini">–¢–µ–º–∞</span>
      <div class="switch" id="swTheme" role="switch" aria-checked="false" tabindex="0"></div>
    </div>

    <div class="spacer"></div>

    <button class="btn" id="btnExport">Export JSON</button>
    <button class="btn" id="btnImport">Import JSON</button>
    <button class="btn danger" id="btnReset">–°–±—Ä–æ—Å</button>
  </div>

  <!-- Mobile drawer -->
  <div class="drawerBackdrop" id="drawerBackdrop"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHeader">
      <div style="font-weight:950;">–ú–µ–Ω—é</div>
      <div class="spacer"></div>
      <button class="btn icon" id="btnDrawerClose">‚úï</button>
    </div>
    <div class="inner" id="drawerInner"></div>
  </div>

  <div class="main" id="main">
    <div class="panel left" id="leftPanel">
      <div class="inner" id="leftInner"></div>
    </div>

    <div class="center">
      <div class="inner">
        <!-- TABLE VIEW -->
        <div id="viewTable">
          <div class="tableWrap">
            <div class="tableHeader">
              <div class="field">
                <span>–ü–µ—Ä–∏–æ–¥:</span>
                <select id="selWindow">
                  <option value="all">–≤—Å–µ</option>
                  <option value="8">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 8</option>
                  <option value="12">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12</option>
                  <option value="20">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20</option>
                </select>
              </div>
              <div class="field">
                <span>–°–∫—Ä—ã—Ç—ã–µ –≤–µ—Å–∞:</span>
                <select id="selHidden">
                  <option value="hide">—Å–∫—Ä—ã–≤–∞—Ç—å</option>
                  <option value="show">–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</option>
                </select>
              </div>
              <div class="field">
                <span class="mini">–ü–æ–¥—Å–∫–∞–∑–∫–∞:</span>
                <span class="mini">–∫–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–µ—Ç–æ–≤ ‚Ä¢ ü©π —Ç—Ä–∞–≤–º–∞ ‚Ä¢ üóë —É–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span>
              </div>
            </div>

            <div class="tableScroll" id="tableScroll">
              <div class="grid" id="grid"></div>
            </div>
          </div>
        </div>

        <!-- ANALYTICS VIEW -->
        <div id="viewAnalytics" class="analytics">
          <div class="row" style="margin-bottom:10px;">
            <div class="field">
              <span>–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:</span>
              <select id="selMetric">
                <option value="volume">–æ–±—ä—ë–º (–≤–µ—Å√ó–ø–æ–≤—Ç–æ—Ä—ã)</option>
                <option value="reps">–ø–æ–≤—Ç–æ—Ä—ã (—Å—É–º–º–∞)</option>
                <option value="prs">—Ä–µ–∫–æ—Ä–¥—ã</option>
              </select>
            </div>
            <div class="field">
              <span>–ü–µ—Ä–∏–æ–¥:</span>
              <select id="selPeriod">
                <option value="month">–º–µ—Å—è—Ü</option>
                <option value="3m">3 –º–µ—Å—è—Ü–∞</option>
                <option value="year">–≥–æ–¥</option>
                <option value="all">–≤—Å—ë</option>
              </select>
            </div>
            <div class="field">
              <span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</span>
              <select id="selExerciseTrend"></select>
            </div>
          </div>

          <div class="analyticsGrid">
            <div>
              <canvas id="cVolume"></canvas>
              <div class="note" id="noteVolume" style="margin-top:10px;"></div>
            </div>
            <div>
              <canvas id="cPRs"></canvas>
              <div class="note" id="notePRs" style="margin-top:10px;"></div>
            </div>
            <div>
              <canvas id="cExercise"></canvas>
              <div class="note" id="noteExercise" style="margin-top:10px;"></div>
            </div>
            <div>
              <canvas id="cInjury"></canvas>
              <div class="note" id="noteInjury" style="margin-top:10px;"></div>
            </div>
          </div>

          <div class="hint" style="margin-top:12px;">
            <b>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–ø—Ä–æ–≥—Ä–µ—Å—Å‚Äù:</b> —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–µ—Ç—Ä–∏–∫—É –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Ç–∞–∫–æ–≥–æ –∂–µ —Ä–∞–∑–º–µ—Ä–∞ (–º–µ—Å—è—Ü –∫ –º–µ—Å—è—Ü—É / 3–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º 3–º / –≥–æ–¥ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –≥–æ–¥—É).
          </div>
        </div>
      </div>
    </div>

    <div class="panel right" id="rightPanel">
      <div class="inner" id="rightInner"></div>
    </div>
  </div>
</div>

<!-- Modal: cell editor -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="–†–µ–¥–∞–∫—Ç–æ—Ä —è—á–µ–π–∫–∏">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <div class="modalTitle" id="mTitle">‚Äî</div>
        <div class="mini" id="mSubtitle">‚Äî</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="mToggleInjury">ü©π –¢—Ä–∞–≤–º–∞</button>
        <button class="btn" id="mClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div class="modalBody">
      <div>
        <div class="setsBox">
          <div class="row" style="margin-bottom:8px;">
            <div style="font-weight:950;">–ü–æ–¥—Ö–æ–¥—ã (–ø–æ–≤—Ç–æ—Ä—ã)</div>
            <button class="btn small" id="mAddSet">+ set</button>
          </div>
          <div class="setsRow" id="mSets"></div>
          <div style="height:10px"></div>
          <div class="mini">–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥: <b>12+10+8</b> –∏–ª–∏ <b>12,10,8</b> –∏–ª–∏ –ø–æ —Å—Ç—Ä–æ–∫–∞–º.</div>
          <textarea id="mQuick" spellcheck="false" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12+10+8"></textarea>
          <div class="row" style="margin-top:8px;">
            <button class="btn" id="mApplyQuick">–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å</button>
            <button class="btn ghost" id="mClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <div class="spacer"></div>
            <button class="btn primary" id="mSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="setsBox">
          <div style="font-weight:950; margin-bottom:6px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
          <textarea id="mComment" spellcheck="false" placeholder="–∑–∞–º–µ—Ç–∫–∞/–æ—â—É—â–µ–Ω–∏—è/—Ç–µ—Ö–Ω–∏–∫–∞..."></textarea>
        </div>
      </div>

      <div>
        <div class="sideBox">
          <div class="row" style="margin-bottom:8px;">
            <div style="font-weight:950;">–°—Ç–æ—Ä–æ–Ω–∞</div>
            <div class="sideTabs" id="mSideTabs"></div>
          </div>
          <div class="kv"><div class="k">–í–µ—Å</div><div class="v" id="mWeight">‚Äî</div></div>
          <div class="kv"><div class="k">–¶–µ–ª—å</div><div class="v" id="mGoal">‚Äî</div></div>
          <div class="kv"><div class="k">–¶–≤–µ—Ç</div><div class="v" id="mColor">‚Äî</div></div>
          <div class="kv"><div class="k">–õ—É—á—à–∏–π —Å–µ—Ç</div><div class="v" id="mBest">‚Äî</div></div>
          <div class="kv"><div class="k">–°—É–º–º–∞ –ø–æ–≤—Ç–æ—Ä–æ–≤</div><div class="v" id="mSum">‚Äî</div></div>
        </div>

        <div style="height:12px"></div>

        <div class="sideBox">
          <div style="font-weight:950; margin-bottom:6px;">–¢—Ä–∞–≤–º–∞</div>
          <div class="mini" id="mInjuryState">‚Äî</div>
          <div style="height:8px"></div>
          <textarea id="mInjuryComment" spellcheck="false" placeholder="–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç—Ä–∞–≤–º–µ (—á—Ç–æ/–ø–æ—á–µ–º—É/–∫–∞–∫)"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="application/json" style="display:none" />

<script>
/* ==========================================================
   Gym Progress Tracker ‚Äî Single-file offline app
   v2.2 (patch):
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –î–ê–¢–ï (–î–î.–ú–ú.–ì–ì–ì–ì), –∞ –Ω–µ –ø–æ createdAt
   - –õ–æ–≥–∏–∫–∞ "–¥–æ/–ø–æ—Å–ª–µ" –¥–ª—è –Ω–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π/–≤–µ—Å–æ–≤/PR —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –ø–æ –î–ê–¢–ï
   ========================================================== */
</script>

<script>
/* ====== Utilities ====== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const uid = (p="id") => `${p}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g, "&quot;"); }

function parseDateDDMMYYYY(s){
  const m = String(s||"").trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  if(mm<1||mm>12||dd<1||dd>31) return null;
  const d = new Date(Date.UTC(yy, mm-1, dd));
  if(d.getUTCFullYear()!==yy || d.getUTCMonth()!==mm-1 || d.getUTCDate()!==dd) return null;
  return d;
}
function monthKeyUTC(d){ // YYYY-MM
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function fmtMonthKey(k){ // YYYY-MM -> MM.YYYY
  const [y,m]=k.split("-");
  return `${m}.${y}`;
}

function parseSetsQuick(str){
  if(!str) return [];
  return String(str).trim().split(/[\s,+\n\r]+/)
    .map(x => parseInt(x,10))
    .filter(n => Number.isFinite(n) && n>=0);
}
function bestSet(sets){ return sets.length ? Math.max(...sets) : 0; }
function sumSets(sets){ return sets.reduce((a,b)=>a+b,0); }

function safeNumWeight(w){
  const n = Number(String(w).replace(",", "."));
  return Number.isFinite(n) ? n : NaN;
}

function dlJSON(obj, name){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>

<!-- ‚úÖ REPLACED STORAGE BLOCK: localStorage-only (reliable) -->
<script>
/* ====== Storage: localStorage (simple + reliable) ====== */
const STORE_KEY = "gym_tracker_singlefile_v2_2";
let storageMode = "ls";

async function storageInit(){
  // nothing
}

async function storageLoad(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){
    console.warn("storageLoad failed:", e);
    return null;
  }
}

let saveTimer=null;
async function storageSave(obj){
  if(saveTimer) clearTimeout(saveTimer);
  return new Promise((resolve)=>{
    saveTimer = setTimeout(()=>{
      try{
        localStorage.setItem(STORE_KEY, JSON.stringify(obj));
      }catch(e){
        console.warn("storageSave failed:", e);
      }
      resolve(true);
    }, 60);
  });
}

async function storageReset(){
  try{ localStorage.removeItem(STORE_KEY); }catch{}
}

/* Extra safety: force-save on background/close */
document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState === "hidden"){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch{}
  }
});
window.addEventListener("pagehide", ()=>{
  try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch{}
});
</script>

<script>
/* ====== State schema ====== */
function seed(){
  const b = [
    {id:uid("b"), name:"–ì–†–£–î–¨", order:0, archived:false},
    {id:uid("b"), name:"–ë–ò–¶–ï–ü–°", order:1, archived:false},
    {id:uid("b"), name:"–°–ü–ò–ù–ê", order:2, archived:false},
    {id:uid("b"), name:"–î–ï–õ–¨–¢–´", order:3, archived:false},
    {id:uid("b"), name:"–ù–û–ì–ò", order:4, archived:false},
  ];
  return {
    version: 22,
    ui:{
      theme:"light",
      showHiddenWeights:false,
      window:"all",
      selectedWorkoutId:null,
      analyticsMetric:"volume",
      analyticsPeriod:"month",
      analyticsExerciseId:null,
      drawerOpen:false,
      collapsedBlocks: {} // blockId -> true/false
    },
    blocks: b,
    exercises: [],
    weights: {},
    workouts: [],
    entries: {}
  };
}

/* ====== NEW: workout ordering by DATE ======
   - main timeline is workout.date parsed as DD.MM.YYYY (UTC).
   - fallback: createdAt if date invalid/missing.
   - stable tie-breaker: createdAt (newer first), then id.
*/
function workoutTime(w){
  const d = parseDateDDMMYYYY(w?.date);
  if(d) return d.getTime();
  const ca = Number(w?.createdAt||0);
  return Number.isFinite(ca) ? ca : 0;
}
function sortWorkoutsInPlace(){
  state.workouts.sort((a,b)=>{
    const ta = workoutTime(a);
    const tb = workoutTime(b);
    if(tb!==ta) return tb-ta; // newest date first
    const ca = Number(a?.createdAt||0);
    const cb = Number(b?.createdAt||0);
    if(cb!==ca) return cb-ca; // tie-breaker
    return String(b?.id||"").localeCompare(String(a?.id||"")); // stable-ish
  });
}

function normalize(s){
  if(!s || typeof s!=="object") return seed();
  if(!s.ui) s.ui = {};
  s.ui.theme = s.ui.theme || "light";
  s.ui.showHiddenWeights = !!s.ui.showHiddenWeights;
  s.ui.window = s.ui.window || "all";
  s.ui.selectedWorkoutId = s.ui.selectedWorkoutId || null;
  s.ui.analyticsMetric = s.ui.analyticsMetric || "volume";
  s.ui.analyticsPeriod = s.ui.analyticsPeriod || "month";
  s.ui.analyticsExerciseId = s.ui.analyticsExerciseId || null;
  s.ui.drawerOpen = !!s.ui.drawerOpen;
  if(!s.ui.collapsedBlocks || typeof s.ui.collapsedBlocks!=="object") s.ui.collapsedBlocks = {};

  if(!Array.isArray(s.blocks)) s.blocks=[];
  if(!Array.isArray(s.exercises)) s.exercises=[];
  if(!s.weights || typeof s.weights!=="object") s.weights={};
  if(!Array.isArray(s.workouts)) s.workouts=[];
  if(!s.entries || typeof s.entries!=="object") s.entries={};

  s.blocks.forEach((b,i)=>{
    if(typeof b.order!=="number") b.order=i;
    if(b.archived==null) b.archived=false;
    if(s.ui.collapsedBlocks[b.id]==null) s.ui.collapsedBlocks[b.id] = false;
  });
  s.exercises.forEach((e,i)=>{
    if(typeof e.order!=="number") e.order=i;
    if(e.archived==null) e.archived=false;
    if(e.lr==null) e.lr=false;
  });

  // Ensure workouts have createdAt (fallback) and then sort by DATE
  s.workouts.forEach(w=>{
    if(!w.id) w.id = uid("t");
    if(typeof w.createdAt!=="number") w.createdAt = Date.now();
    if(typeof w.date!=="string") w.date = String(w.date||"").trim();
  });
  // sort by date descending
  s.workouts.sort((a,b)=>{
    const ta = workoutTime(a);
    const tb = workoutTime(b);
    if(tb!==ta) return tb-ta;
    const ca = Number(a?.createdAt||0);
    const cb = Number(b?.createdAt||0);
    if(cb!==ca) return cb-ca;
    return String(b?.id||"").localeCompare(String(a?.id||""));
  });

  // selected workout: if not exists or missing -> pick newest by date
  if(s.workouts.length){
    const exists = s.workouts.some(w=>w.id===s.ui.selectedWorkoutId);
    if(!s.ui.selectedWorkoutId || !exists) s.ui.selectedWorkoutId = s.workouts[0].id;
  }else{
    s.ui.selectedWorkoutId = null;
  }

  for(const exId of Object.keys(s.weights)){
    if(!Array.isArray(s.weights[exId])) s.weights[exId]=[];
    s.weights[exId].forEach((w,i)=>{
      if(!w.id) w.id=uid("w");
      if(w.hidden==null) w.hidden=false;
      if(w.value==null) w.value="";
      if(typeof w.order!=="number") w.order=i;
    });
    s.weights[exId].sort((a,b)=>(a.order||0)-(b.order||0));
  }

  for(const k of Object.keys(s.entries)){
    const v = s.entries[k];
    if(!v || typeof v!=="object"){ delete s.entries[k]; continue; }
    if(!Array.isArray(v.sets)) v.sets = [];
    v.sets = v.sets.map(n=>parseInt(n,10)).filter(n=>Number.isFinite(n)&&n>=0);
    if(typeof v.comment!=="string") v.comment = v.comment ? String(v.comment) : "";
    v.injury = !!v.injury;
    if(typeof v.injuryComment!=="string") v.injuryComment = v.injuryComment ? String(v.injuryComment) : "";
    v.gold = !!v.gold;
    v.createdAt = v.createdAt || Date.now();
    v.updatedAt = v.updatedAt || Date.now();
  }
  return s;
}

let state = null;
</script>

<script>
/* ====== Selectors over state ====== */
function blocksActive(){ return state.blocks.filter(b=>!b.archived).slice().sort((a,b)=>a.order-b.order); }
function exercisesActive(){ return state.exercises.filter(e=>!e.archived).slice().sort((a,b)=>a.order-b.order); }
function exercisesByBlock(blockId){ return exercisesActive().filter(e=>e.blockId===blockId); }
function getBlock(blockId){ return state.blocks.find(b=>b.id===blockId); }
function getExercise(exId){ return state.exercises.find(e=>e.id===exId); }
function getWeights(exId){
  const arr = state.weights[exId] || [];
  return arr.slice().sort((a,b)=>(a.order||0)-(b.order||0));
}
function weightsVisible(exId){
  const arr = getWeights(exId);
  if(state.ui.showHiddenWeights) return arr;
  return arr.filter(w=>!w.hidden);
}
function workoutWindowed(){
  // state.workouts is already date-sorted desc
  const w = state.workouts.slice();
  const win = state.ui.window;
  if(win==="all") return w;
  const n = parseInt(win,10);
  if(!Number.isFinite(n)) return w;
  return w.slice(0,n);
}
function entryKey(workoutId, exId, weightId, side){ return `${workoutId}|${exId}|${weightId}|${side}`; }
function sidesForExercise(ex){ return ex.lr ? ["L","R"] : ["-"]; }
function isBlockCollapsed(blockId){ return !!state.ui.collapsedBlocks[blockId]; }

function toggleBlockCollapse(blockId){
  state.ui.collapsedBlocks[blockId] = !state.ui.collapsedBlocks[blockId];
  storageSave(state);
  renderAll();
}

function setTheme(theme){
  state.ui.theme = theme;
  $("#app").setAttribute("data-theme", theme);
  const isDark = theme==="dark";
  $("#swTheme").classList.toggle("on", isDark);
  $("#swTheme").setAttribute("aria-checked", String(isDark));
  storageSave(state);
}

/* ====== CRUD: Blocks ====== */
function addBlock(){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¢–†–ò–¶–ï–ü–°)");
  if(!name) return;
  const maxOrder = Math.max(-1, ...state.blocks.map(b=>b.order||0));
  const b = {id:uid("b"), name:name.trim(), order:maxOrder+1, archived:false};
  state.blocks.push(b);
  state.ui.collapsedBlocks[b.id] = false;
  storageSave(state); renderAll();
}
function renameBlock(blockId){
  const b = getBlock(blockId); if(!b) return;
  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞", b.name);
  if(!name) return;
  b.name = name.trim();
  storageSave(state); renderAll();
}
function archiveBlock(blockId){
  const b = getBlock(blockId); if(!b) return;
  if(!confirm(`–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ ‚Äú${b.name}‚Äù? (–º—è–≥–∫–æ, –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è)`)) return;
  b.archived = true;
  state.exercises.forEach(e=>{ if(e.blockId===blockId) e.archived=true; });
  storageSave(state); renderAll();
}

/* ====== CRUD: Exercises ====== */
function addExercise(blockId){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (—Ç—ã –≤–≤–æ–¥–∏—à—å —Å–∞–º)");
  if(!name) return;
  const maxOrder = Math.max(-1, ...state.exercises.map(e=>e.order||0));
  const ex = {id:uid("e"), blockId, name:name.trim(), order:maxOrder+1, archived:false, lr:false};
  state.exercises.push(ex);
  if(!state.weights[ex.id]) state.weights[ex.id]=[];
  storageSave(state); renderAll();
  if(!state.ui.analyticsExerciseId) state.ui.analyticsExerciseId = ex.id;
}
function renameExercise(exId){
  const e = getExercise(exId); if(!e) return;
  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è", e.name);
  if(!name) return;
  e.name = name.trim();
  storageSave(state); renderAll();
}
function toggleLR(exId){
  const e = getExercise(exId); if(!e) return;
  e.lr = !e.lr;
  storageSave(state); renderAll();
}
function archiveExercise(exId){
  const e = getExercise(exId); if(!e) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å (–º—è–≥–∫–æ) —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Äú${e.name}‚Äù?`)) return;
  e.archived = true;
  storageSave(state); renderAll();
}

/* ====== CRUD: Weights ====== */
function addWeight(exId){
  const v = prompt("–í–µ—Å (–ª—é–±–∞—è —Å—Ç—Ä–æ–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: 60 –∏–ª–∏ 12.5)");
  if(v==null) return;
  const val = String(v).trim();
  if(!val) return;
  if(!state.weights[exId]) state.weights[exId]=[];
  const arr = state.weights[exId];
  const maxOrder = Math.max(-1, ...arr.map(w=>w.order||0));
  arr.push({id:uid("w"), value:val, hidden:false, order:maxOrder+1});
  storageSave(state); renderAll();
}
function toggleWeightHidden(exId, weightId){
  const arr = state.weights[exId] || [];
  const w = arr.find(x=>x.id===weightId); if(!w) return;
  w.hidden = !w.hidden;
  storageSave(state); renderAll();
}
function renameWeight(exId, weightId){
  const arr = state.weights[exId] || [];
  const w = arr.find(x=>x.id===weightId); if(!w) return;
  const nv = prompt("–ù–æ–≤—ã–π –≤–µ—Å (—Å—Ç—Ä–æ–∫–∞)", w.value);
  if(nv==null) return;
  const val = String(nv).trim();
  if(!val) return;
  w.value = val;
  storageSave(state); renderAll();
}

/* ====== Workouts ====== */
function addWorkout(){
  const date = prompt("–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–î–î.–ú–ú.–ì–ì–ì–ì). –î—É–±–ª–∏–∫–∞—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã.");
  if(!date) return;
  const t = { id: uid("t"), date: date.trim(), createdAt: Date.now() };
  state.workouts.push(t);          // push then sort by DATE
  sortWorkoutsInPlace();
  state.ui.selectedWorkoutId = state.workouts[0]?.id || t.id;
  storageSave(state); renderAll();
}
function selectWorkout(id){
  state.ui.selectedWorkoutId = id;
  storageSave(state);
  $$(".th.workout").forEach(x=>x.classList.toggle("selected", x.dataset.workoutId===id));
  renderRightStats();
}
function deleteWorkout(workoutId){
  const w = state.workouts.find(x=>x.id===workoutId);
  if(!w) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ${w.date}?\n(–£–¥–∞–ª—è—Ç—Å—è –∏ –≤—Å–µ —è—á–µ–π–∫–∏ —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)`)) return;

  // remove entries belonging to this workout
  for(const k of Object.keys(state.entries)){
    if(k.startsWith(workoutId + "|")) delete state.entries[k];
  }
  // remove workout
  state.workouts = state.workouts.filter(x=>x.id!==workoutId);

  // re-sort and update selection
  sortWorkoutsInPlace();
  if(state.ui.selectedWorkoutId === workoutId){
    state.ui.selectedWorkoutId = state.workouts[0]?.id || null;
  }
  storageSave(state);
  renderAll();
}

/* ====== Entry classification helpers ====== */
function workoutIdFromKey(k){ return k.split("|")[0]; }
function exIdFromKey(k){ return k.split("|")[1]; }
function weightIdFromKey(k){ return k.split("|")[2]; }
function sideFromKey(k){ return k.split("|")[3]; }

function getEntry(workoutId, exId, weightId, side){
  return state.entries[entryKey(workoutId, exId, weightId, side)] || null;
}
function setEntry(workoutId, exId, weightId, side, obj){
  const k = entryKey(workoutId, exId, weightId, side);
  state.entries[k] = obj;
}
function delEntry(workoutId, exId, weightId, side){
  const k = entryKey(workoutId, exId, weightId, side);
  delete state.entries[k];
}

/* ====== NEW: timeline comparisons use workout DATE (not createdAt) ====== */
function workoutTsById(workoutId){
  const w = state.workouts.find(x=>x.id===workoutId);
  if(!w) return 0;
  return workoutTime(w);
}

function hasAnyEntryForExerciseBefore(exId, workoutId){
  const curTs = workoutTsById(workoutId) || Number.MAX_SAFE_INTEGER;
  for(const k of Object.keys(state.entries)){
    const eId = exIdFromKey(k);
    if(eId !== exId) continue;
    const wId = workoutIdFromKey(k);
    const ts = workoutTsById(wId) || 0;
    if(ts < curTs && state.entries[k] && state.entries[k].sets && state.entries[k].sets.length){
      return true;
    }
  }
  return false;
}
function hasAnyEntryForWeightBefore(exId, weightId, workoutId){
  const curTs = workoutTsById(workoutId) || Number.MAX_SAFE_INTEGER;
  for(const k of Object.keys(state.entries)){
    if(exIdFromKey(k)!==exId) continue;
    if(weightIdFromKey(k)!==weightId) continue;
    const wId = workoutIdFromKey(k);
    const ts = workoutTsById(wId) || 0;
    if(ts < curTs && state.entries[k] && state.entries[k].sets && state.entries[k].sets.length){
      return true;
    }
  }
  return false;
}
function bestRecordBefore(exId, weightId, side, workoutId){
  const curTs = workoutTsById(workoutId) || Number.MAX_SAFE_INTEGER;
  let best = 0;
  for(const k of Object.keys(state.entries)){
    if(exIdFromKey(k)!==exId) continue;
    if(weightIdFromKey(k)!==weightId) continue;
    if(sideFromKey(k)!==side) continue;
    const wId = workoutIdFromKey(k);
    const ts = workoutTsById(wId) || 0;
    if(ts < curTs){
      const ent = state.entries[k];
      const b = bestSet(ent.sets||[]);
      if(b > best) best = b;
    }
  }
  return best;
}

function classifyCell(workoutId, exId, weightId, side){
  const ent = getEntry(workoutId, exId, weightId, side);
  if(!ent || !(ent.sets||[]).length){
    return { color:"gray", gold:false, green:false, yellow:false, injury:false };
  }
  const injury = !!ent.injury;

  const hadExerciseBefore = hasAnyEntryForExerciseBefore(exId, workoutId);
  const yellow = !hadExerciseBefore;

  const hadWeightBefore = hasAnyEntryForWeightBefore(exId, weightId, workoutId);
  const green = hadExerciseBefore && !hadWeightBefore;

  let gold = !!ent.gold;
  if(!gold && hadExerciseBefore){
    const b = bestSet(ent.sets||[]);
    const prevBest = bestRecordBefore(exId, weightId, side, workoutId);
    if(b > prevBest && b > 0){
      gold = true;
      ent.gold = true;
      ent.updatedAt = Date.now();
    }
  }

  if(injury) return { color:"injury", gold, green, yellow, injury:true };
  if(yellow) return { color:"yellow", gold:false, green:false, yellow:true, injury:false };
  if(gold) return { color:"gold", gold:true, green:false, yellow:false, injury:false };
  if(green) return { color:"green", gold:false, green:true, yellow:false, injury:false };
  return { color:"gray", gold:false, green:false, yellow:false, injury:false };
}
function goalForCell(exId, weightId, side){
  let best = 0;
  for(const k of Object.keys(state.entries)){
    if(exIdFromKey(k)!==exId) continue;
    if(weightIdFromKey(k)!==weightId) continue;
    if(sideFromKey(k)!==side) continue;
    const ent = state.entries[k];
    const b = bestSet(ent.sets||[]);
    if(b > best) best = b;
  }
  if(best<=0) return "";
  return String(best + 1);
}
</script>

<!--
  –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–∞–π–ª–∞ (—Ä–µ–Ω–¥–µ—Ä—ã, –º–æ–¥–∞–ª–∫–∞, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, wire/init)
  —É —Ç–µ–±—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è ‚Äî —è –µ—ë –ù–ï –º–µ–Ω—è–ª.
  –ß—Ç–æ–±—ã –Ω–µ —Ä–∏—Å–∫–æ–≤–∞—Ç—å ‚Äú–æ–±—Ä–µ–∑–∞—Ç—å‚Äù —Ñ–∞–π–ª –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ –æ—Å—Ç–∞–≤—à—É—é—Å—è —á–∞—Å—Ç—å
  –∏–∑ —Ç–≤–æ–µ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ index.html, –ù–ê–ß–ò–ù–ê–Ø —Å –±–ª–æ–∫–∞:
    <script>
    /* ====== Rendering: left panel (structure) ====== */
  –∏ –¥–æ –∫–æ–Ω—Ü–∞ </html>
-->
</body>
</html>
