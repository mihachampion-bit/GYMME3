<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gym Tracker (Single File + PIN + Save)</title>
  <style>
    :root{
      --bg:#0b0c0f;
      --panel:#14151b;
      --panel2:#0f1116;
      --text:#f3f4f6;
      --muted:#9aa4b2;
      --border:#252833;
      --accent:#60a5fa;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#fbbf24;
      --shadow: 0 16px 36px rgba(0,0,0,.35);
      --r:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --cellw: 140px;
      --roww: 360px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:var(--sans);background:var(--bg);color:var(--text)}
    button,input,select,textarea{font:inherit;color:inherit}
    .app{height:100%;display:flex;flex-direction:column}
    .top{
      position:sticky;top:0;z-index:10;
      display:flex;gap:8px;align-items:center;
      padding:10px 12px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,var(--panel2),var(--bg));
    }
    .brand{font-weight:900;display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .pill{font-size:12px;border:1px solid var(--border);padding:3px 8px;border-radius:999px;color:var(--muted)}
    .spacer{flex:1}
    .btn{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:hover{border-color:#3a3f4d}
    .btn.primary{border-color:rgba(96,165,250,.6);background:rgba(96,165,250,.12)}
    .btn.danger{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.12)}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--muted)}
    .main{flex:1;min-height:0;display:grid;grid-template-columns:380px 1fr}
    @media (max-width: 900px){ .main{grid-template-columns:1fr} }
    .side{
      min-height:0;overflow:auto;
      background:var(--panel);
      border-right:1px solid var(--border);
    }
    @media (max-width: 900px){ .side{border-right:none;border-bottom:1px solid var(--border)} }
    .center{min-height:0;overflow:auto;padding:12px}
    .inner{padding:12px}
    h2{margin:0 0 10px 0;font-size:12px;letter-spacing:.2px;text-transform:uppercase;color:var(--muted)}
    .card{background:var(--panel2);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:12px}
    .hint{color:var(--muted);line-height:1.35;font-size:13px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:10px}
    .block{
      background:var(--panel2);border:1px solid var(--border);
      border-radius:var(--r);box-shadow:var(--shadow);padding:10px
    }
    .blockHead{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .blockName{font-weight:950;font-size:16px}
    .exItem{
      margin-top:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      background:rgba(255,255,255,.03);
    }
    .exTitle{
      display:flex;justify-content:space-between;gap:8px;align-items:flex-start
    }
    .exName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .exMeta{color:var(--muted);font-size:12px;margin-top:2px}
    .weights{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding-left:14px}
    .wChip{
      border:1px solid var(--border);border-radius:999px;
      padding:4px 8px;font-family:var(--mono);
      font-size:12px;background:rgba(255,255,255,.04);
      cursor:pointer;
    }
    .wChip:hover{border-color:#3a3f4d}
    .tableWrap{
      border:1px solid var(--border);border-radius:var(--r);
      overflow:hidden;background:var(--panel2);box-shadow:var(--shadow)
    }
    .thead{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    }
    .field{
      border:1px solid var(--border);
      border-radius:999px;padding:6px 10px;
      display:flex;gap:8px;align-items:center;
      color:var(--muted);font-size:12px;background:rgba(255,255,255,.02)
    }
    .field select{
      border:0;outline:0;background:transparent;
      color:var(--text);font-weight:900;cursor:pointer
    }
    .gridScroll{overflow:auto}
    .grid{
      display:grid;
      grid-auto-rows:minmax(34px,auto);
      min-width:900px;
    }
    .th,.td,.rh{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:7px 8px;
      display:flex;align-items:center;gap:8px;
      background:var(--panel2);
      min-width:var(--cellw);
    }
    .th{
      position:sticky;top:0;z-index:5;
      font-weight:950;
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));
    }
    .rh{
      position:sticky;left:0;z-index:4;
      min-width:var(--roww);max-width:var(--roww);
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    }
    .corner{position:sticky;top:0;left:0;z-index:7}
    .td{cursor:pointer}
    .cell{width:100%;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .val{font-family:var(--mono);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px}
    .goal{font-size:11px;color:var(--muted);white-space:nowrap;margin-left:auto}
    .rowBlock{background:rgba(255,255,255,.03);font-weight:950}
    .rowEx .l1{font-weight:950}                /* –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∂–∏—Ä–Ω–æ–µ */
    .rowEx .l2{color:var(--muted);font-size:12px}
    .rowW .l1{font-weight:500;font-family:var(--mono)}  /* –í–µ—Å –æ–±—ã—á–Ω—ã–π */
    .rowW .l2{color:var(--muted);font-size:12px}
    .indentEx{padding-left:18px}
    .indentW{padding-left:38px}
    .badge{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:2px 7px;color:var(--muted)}
    .colorGold{background:rgba(251,191,36,.16)}
    .colorGreen{background:rgba(34,197,94,.14)}
    .colorYellow{background:rgba(251,191,36,.12)}
    .colorInj{background:rgba(239,68,68,.14)}
    .modalBack{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);z-index:50;padding:14px
    }
    .modalBack.open{display:flex}
    .modal{
      width:min(720px,100%);
      border:1px solid var(--border);
      border-radius:18px;background:var(--panel2);
      box-shadow:var(--shadow);overflow:hidden
    }
    .mHead{
      padding:12px 14px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;gap:10px;align-items:center
    }
    .mTitle{font-weight:950}
    .mBody{padding:14px;display:grid;grid-template-columns:1fr 280px;gap:12px}
    @media (max-width: 780px){ .mBody{grid-template-columns:1fr} }
    .box{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(255,255,255,.02)}
    .sets{display:flex;flex-wrap:wrap;gap:8px}
    .sets input{
      width:72px;padding:8px 10px;border-radius:12px;
      border:1px solid var(--border);background:rgba(255,255,255,.03);
      font-family:var(--mono);font-weight:900;outline:0
    }
    textarea{
      width:100%;min-height:84px;resize:vertical;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);background:rgba(255,255,255,.03);
      font-family:var(--mono);outline:0
    }
    .pinLock{
      position:fixed;inset:0;z-index:100;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.75);padding:14px
    }
    .pinLock.open{display:flex}
    .pinCard{
      width:min(420px,100%);
      border:1px solid var(--border);border-radius:18px;
      background:var(--panel2);box-shadow:var(--shadow);padding:14px
    }
    .pinCard h3{margin:0 0 6px 0}
    .pinCard p{margin:0 0 10px 0;color:var(--muted);line-height:1.35}
    .pinRow{display:flex;gap:8px;align-items:center}
    .pinRow input{
      flex:1;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-family:var(--mono);font-weight:950;font-size:16px;
      letter-spacing:3px;text-align:center
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="top">
    <div class="brand"><span class="dot"></span> Gym Tracker <span class="pill">single file ‚Ä¢ saves</span></div>
    <button class="btn primary" id="btnAddWorkout">+ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
    <button class="btn" id="btnExport">Export JSON</button>
    <button class="btn" id="btnImport">Import JSON</button>
    <button class="btn" id="btnPin">PIN</button>
    <button class="btn danger" id="btnReset">–°–±—Ä–æ—Å</button>
    <div class="spacer"></div>
    <span class="pill" id="saveState">‚Äî</span>
  </div>

  <div class="main">
    <div class="side">
      <div class="inner" id="sideInner"></div>
    </div>
    <div class="center">
      <div class="tableWrap">
        <div class="thead">
          <div class="field">
            <span>–ü–µ—Ä–∏–æ–¥:</span>
            <select id="selWin">
              <option value="all">–≤—Å–µ</option>
              <option value="8">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 8</option>
              <option value="12">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12</option>
              <option value="20">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20</option>
            </select>
          </div>
          <div class="field">
            <span class="hint">–ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ ‚Üí –≤–≤–æ–¥ —Å–µ—Ç–æ–≤. ü©π –æ—Ç–º–µ—á–∞–µ—Ç —Ç—Ä–∞–≤–º—É.</span>
          </div>
        </div>
        <div class="gridScroll">
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modalBack" id="mBack">
  <div class="modal">
    <div class="mHead">
      <div>
        <div class="mTitle" id="mTitle">‚Äî</div>
        <div class="hint" id="mSub">‚Äî</div>
      </div>
      <div class="row">
        <button class="btn" id="mInj">ü©π –¢—Ä–∞–≤–º–∞</button>
        <button class="btn" id="mClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div class="mBody">
      <div>
        <div class="box">
          <div class="row" style="margin-bottom:8px">
            <div style="font-weight:950">–ü–æ–¥—Ö–æ–¥—ã (–ø–æ–≤—Ç–æ—Ä—ã)</div>
            <button class="btn" id="mAddSet">+ set</button>
          </div>
          <div class="sets" id="mSets"></div>
          <div style="height:10px"></div>
          <div class="hint">–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥: <b>12+10+8</b> –∏–ª–∏ <b>12,10,8</b></div>
          <textarea id="mQuick" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12+10+8"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="mParse">–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å</button>
            <button class="btn ghost" id="mClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <div class="spacer"></div>
            <button class="btn primary" id="mSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="box">
          <div style="font-weight:950;margin-bottom:6px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
          <textarea id="mComment" placeholder="–∑–∞–º–µ—Ç–∫–∞/–æ—â—É—â–µ–Ω–∏—è/—Ç–µ—Ö–Ω–∏–∫–∞..."></textarea>
        </div>
      </div>
      <div>
        <div class="box">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:950">–°–≤–æ–¥–∫–∞</div>
            <span class="badge" id="mColor">‚Äî</span>
          </div>
          <div class="row" style="margin-top:10px;justify-content:space-between">
            <div class="hint">–õ—É—á—à–∏–π —Å–µ—Ç</div><div style="font-family:var(--mono);font-weight:950" id="mBest">‚Äî</div>
          </div>
          <div class="row" style="margin-top:6px;justify-content:space-between">
            <div class="hint">–°—É–º–º–∞</div><div style="font-family:var(--mono);font-weight:950" id="mSum">‚Äî</div>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="box">
          <div style="font-weight:950;margin-bottom:6px">–¢—Ä–∞–≤–º–∞</div>
          <div class="hint" id="mInjState">‚Äî</div>
          <div style="height:8px"></div>
          <textarea id="mInjComment" placeholder="–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç—Ä–∞–≤–º–µ"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="pinLock" id="pinLock">
  <div class="pinCard">
    <h3 id="pinTitle">PIN</h3>
    <p id="pinText">‚Äî</p>
    <div class="pinRow">
      <input id="pinInput" inputmode="numeric" maxlength="3" placeholder="‚Ä¢‚Ä¢‚Ä¢" />
      <button class="btn primary" id="pinOk">OK</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="pinNew">–°–º–µ–Ω–∏—Ç—å PIN</button>
      <div class="spacer"></div>
      <button class="btn ghost" id="pinSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="application/json" style="display:none" />
<script>
// ===== Utilities =====
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const uid = (p="id") => `${p}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;

function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }
function parseQuick(str){
  return String(str||"").trim().split(/[\s,+\n\r]+/).map(x=>parseInt(x,10)).filter(n=>Number.isFinite(n)&&n>=0);
}
function bestSet(arr){ return arr.length ? Math.max(...arr) : 0; }
function sumSets(arr){ return arr.reduce((a,b)=>a+b,0); }

function dlJSON(obj, name){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// ===== Storage (localStorage) =====
const STORE_KEY = "gym_tracker_simple_v1";
let saveTimer = null;

function setSaveState(t){ $("#saveState").textContent = t; }
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveStateDebounced(){
  setSaveState("saving‚Ä¶");
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    try{
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
      setSaveState("saved");
    }catch(e){
      setSaveState("save failed");
    }
  }, 120);
}
function forceSaveNow(){
  try{
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
    setSaveState("saved");
  }catch(e){
    setSaveState("save failed");
  }
}

// ===== PIN (–ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞) =====
const PIN_KEY = "gym_tracker_pin3";
let pinEnabled = true;

function openPinLock(mode="check"){
  // mode: "check" | "set"
  $("#pinInput").value = "";
  $("#pinLock").classList.add("open");
  $("#pinInput").focus();

  const hasPin = !!localStorage.getItem(PIN_KEY);
  if(mode==="set" || !hasPin){
    $("#pinTitle").textContent = "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PIN (3 —Ü–∏—Ñ—Ä—ã)";
    $("#pinText").textContent = "–ó–∞–ø–æ–º–Ω–∏ –µ–≥–æ. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤.";
    $("#pinOk").onclick = ()=>{
      const v = ($("#pinInput").value||"").trim();
      if(!/^\d{3}$/.test(v)) return alert("–ù—É–∂–Ω—ã —Ä–æ–≤–Ω–æ 3 —Ü–∏—Ñ—Ä—ã.");
      localStorage.setItem(PIN_KEY, v);
      pinEnabled = true;
      $("#pinLock").classList.remove("open");
    };
  }else{
    $("#pinTitle").textContent = "–í–≤–µ–¥–∏—Ç–µ PIN";
    $("#pinText").textContent = "–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫–µ—Ä.";
    $("#pinOk").onclick = ()=>{
      const v = ($("#pinInput").value||"").trim();
      const p = localStorage.getItem(PIN_KEY);
      if(v === p){
        $("#pinLock").classList.remove("open");
      }else{
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN");
        $("#pinInput").value = "";
        $("#pinInput").focus();
      }
    };
  }

  $("#pinNew").onclick = ()=> openPinLock("set");
  $("#pinSkip").onclick = ()=>{
    // –≤—ã–∫–ª—é—á–∞–µ–º PIN —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç—É —Å–µ—Å—Å–∏—é
    pinEnabled = false;
    $("#pinLock").classList.remove("open");
  };
}
// ===== Data model =====
function seed(){
  return {
    ui:{ win:"all", selectedWorkoutId:null },
    blocks:[
      {id:uid("b"), name:"–ì–†–£–î–¨", order:0},
      {id:uid("b"), name:"–°–ü–ò–ù–ê", order:1},
      {id:uid("b"), name:"–ù–û–ì–ò", order:2},
    ],
    exercises: [
      // {id, blockId, name, order}
    ],
    weights: {
      // exId: [{id,value,order}]
    },
    workouts: [
      // {id,date,createdAt}
    ],
    entries: {
      // key: {sets:[], comment:"", injury:false, injuryComment:"", gold:false, createdAt, updatedAt}
    }
  };
}
function normalize(s){
  if(!s || typeof s!=="object") return seed();
  if(!s.ui) s.ui={win:"all", selectedWorkoutId:null};
  if(!Array.isArray(s.blocks)) s.blocks=[];
  if(!Array.isArray(s.exercises)) s.exercises=[];
  if(!s.weights || typeof s.weights!=="object") s.weights={};
  if(!Array.isArray(s.workouts)) s.workouts=[];
  if(!s.entries || typeof s.entries!=="object") s.entries={};

  s.blocks.forEach((b,i)=>{ if(typeof b.order!=="number") b.order=i; if(!b.id) b.id=uid("b"); });
  s.exercises.forEach((e,i)=>{ if(typeof e.order!=="number") e.order=i; if(!e.id) e.id=uid("e"); });

  for(const exId of Object.keys(s.weights)){
    if(!Array.isArray(s.weights[exId])) s.weights[exId]=[];
    s.weights[exId].forEach((w,i)=>{ if(!w.id) w.id=uid("w"); if(typeof w.order!=="number") w.order=i; });
    s.weights[exId].sort((a,b)=>a.order-b.order);
  }

  s.workouts.forEach(w=>{
    if(!w.id) w.id=uid("t");
    if(typeof w.createdAt!=="number") w.createdAt = Date.now();
    if(typeof w.date!=="string") w.date = String(w.date||"").trim();
  });
  s.workouts.sort((a,b)=>b.createdAt-a.createdAt);

  if(s.workouts.length){
    const ok = s.workouts.some(w=>w.id===s.ui.selectedWorkoutId);
    if(!ok) s.ui.selectedWorkoutId = s.workouts[0].id;
  }else{
    s.ui.selectedWorkoutId = null;
  }

  for(const k of Object.keys(s.entries)){
    const v = s.entries[k];
    if(!v || typeof v!=="object"){ delete s.entries[k]; continue; }
    if(!Array.isArray(v.sets)) v.sets=[];
    v.sets = v.sets.map(n=>parseInt(n,10)).filter(n=>Number.isFinite(n)&&n>=0);
    if(typeof v.comment!=="string") v.comment = String(v.comment||"");
    if(typeof v.injuryComment!=="string") v.injuryComment = String(v.injuryComment||"");
    v.injury = !!v.injury;
    v.gold = !!v.gold;
    v.createdAt = v.createdAt || Date.now();
    v.updatedAt = v.updatedAt || Date.now();
  }

  return s;
}

let state = normalize(loadState() || seed());

// ===== Selectors =====
const blocks = ()=> state.blocks.slice().sort((a,b)=>a.order-b.order);
const exercises = ()=> state.exercises.slice().sort((a,b)=>a.order-b.order);
const exByBlock = (bid)=> exercises().filter(e=>e.blockId===bid);
const getEx = (id)=> state.exercises.find(e=>e.id===id);
const getBlock = (id)=> state.blocks.find(b=>b.id===id);
const getWeights = (exId)=> (state.weights[exId]||[]).slice().sort((a,b)=>a.order-b.order);
const entryKey = (workoutId, exId, weightId)=> `${workoutId}|${exId}|${weightId}`;
const getEntry = (workoutId, exId, weightId)=> state.entries[entryKey(workoutId,exId,weightId)] || null;
// ===== CRUD =====
function addBlock(){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–õ–ï–ß–ò)");
  if(!name) return;
  const max = Math.max(-1, ...state.blocks.map(b=>b.order||0));
  state.blocks.push({id:uid("b"), name:name.trim(), order:max+1});
  saveStateDebounced(); render();
}
function renameBlock(id){
  const b = getBlock(id); if(!b) return;
  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞", b.name);
  if(!name) return;
  b.name = name.trim();
  saveStateDebounced(); render();
}
function addExercise(blockId){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è");
  if(!name) return;
  const max = Math.max(-1, ...state.exercises.map(e=>e.order||0));
  const ex = {id:uid("e"), blockId, name:name.trim(), order:max+1};
  state.exercises.push(ex);
  if(!state.weights[ex.id]) state.weights[ex.id]=[];
  saveStateDebounced(); render();
}
function renameExercise(exId){
  const ex = getEx(exId); if(!ex) return;
  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è", ex.name);
  if(!name) return;
  ex.name = name.trim();
  saveStateDebounced(); render();
}
function addWeight(exId){
  const v = prompt("–í–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 60 –∏–ª–∏ 12.5)");
  if(v==null) return;
  const val = String(v).trim(); if(!val) return;
  if(!state.weights[exId]) state.weights[exId]=[];
  const arr = state.weights[exId];
  const max = Math.max(-1, ...arr.map(w=>w.order||0));
  arr.push({id:uid("w"), value:val, order:max+1});
  saveStateDebounced(); render();
}
function renameWeight(exId, wid){
  const arr = state.weights[exId]||[];
  const w = arr.find(x=>x.id===wid); if(!w) return;
  const nv = prompt("–ù–æ–≤—ã–π –≤–µ—Å", w.value);
  if(nv==null) return;
  const val = String(nv).trim(); if(!val) return;
  w.value = val;
  saveStateDebounced(); render();
}
function addWorkout(){
  const date = prompt("–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–∫–∞–∫ —Ö–æ—á–µ—à—å, –Ω–∞–ø—Ä–∏–º–µ—Ä 05.01.2026)");
  if(!date) return;
  const w = {id:uid("t"), date:date.trim(), createdAt:Date.now()};
  state.workouts.unshift(w);
  state.ui.selectedWorkoutId = w.id;
  saveStateDebounced(); render();
}
function deleteWorkout(id){
  const w = state.workouts.find(x=>x.id===id);
  if(!w) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É ${w.date}?`)) return;

  // delete entries for this workout
  for(const k of Object.keys(state.entries)){
    if(k.startsWith(id+"|")) delete state.entries[k];
  }
  state.workouts = state.workouts.filter(x=>x.id!==id);
  state.ui.selectedWorkoutId = state.workouts[0]?.id || null;
  saveStateDebounced(); render();
}
// ===== Cell logic (–ø—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞) =====
function classify(workoutId, exId, weightId){
  const ent = getEntry(workoutId, exId, weightId);
  if(!ent || !(ent.sets||[]).length){
    return {cls:"", label:""};
  }
  if(ent.injury) return {cls:"colorInj", label:"inj"};

  // gold: –µ—Å–ª–∏ –ª—É—á—à–∏–π —Å–µ—Ç –∑–¥–µ—Å—å –±–æ–ª—å—à–µ –ª—é–±–æ–≥–æ –ø—Ä–æ—à–ª–æ–≥–æ –Ω–∞ —ç—Ç–æ–º –≤–µ—Å–µ
  const curBest = bestSet(ent.sets||[]);
  let prevBest = 0;
  for(const k of Object.keys(state.entries)){
    const [wid,eid,wtid] = k.split("|");
    if(eid!==exId || wtid!==weightId) continue;
    if(wid===workoutId) continue;
    const e = state.entries[k];
    prevBest = Math.max(prevBest, bestSet(e.sets||[]));
  }
  if(curBest > prevBest && prevBest>0){
    ent.gold = true;
    return {cls:"colorGold", label:"PR"};
  }
  if(ent.gold) return {cls:"colorGold", label:"PR"};

  // green: –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —ç—Ç–æ—Ç –≤–µ—Å –≤–æ–æ–±—â–µ
  let seenThisWeightBefore = false;
  for(const k of Object.keys(state.entries)){
    const [wid,eid,wtid] = k.split("|");
    if(wid===workoutId) continue;
    if(eid===exId && wtid===weightId){
      const e = state.entries[k];
      if(e && (e.sets||[]).length){ seenThisWeightBefore=true; break; }
    }
  }
  if(!seenThisWeightBefore) return {cls:"colorGreen", label:"new weight"};

  return {cls:"colorYellow", label:"ok"};
}

function goalNext(exId, weightId){
  let best = 0;
  for(const k of Object.keys(state.entries)){
    const [wid,eid,wtid] = k.split("|");
    if(eid!==exId || wtid!==weightId) continue;
    const e = state.entries[k];
    best = Math.max(best, bestSet(e.sets||[]));
  }
  return best>0 ? String(best+1) : "";
}
// ===== Render sidebar (–ë–ª–æ–∫ ‚Üí –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Üí –í–µ—Å–∞) =====
function renderSide(){
  const root = $("#sideInner");
  let html = `
    <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h2>
    <div class="card">
      <div class="hint">
        1) –î–æ–±–∞–≤—å –±–ª–æ–∫/—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ/–≤–µ—Å–∞<br/>
        2) –î–æ–±–∞–≤—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É<br/>
        3) –ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ ‚Üí –≤–≤–æ–¥ —Å–µ—Ç–æ–≤ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button class="btn" id="btnAddBlock">+ –ë–ª–æ–∫</button>
    </div>
    <div style="height:10px"></div>
    <div class="list">
  `;

  for(const b of blocks()){
    html += `
      <div class="block">
        <div class="blockHead">
          <div class="blockName">${esc(b.name)}</div>
          <div class="row">
            <button class="btn" data-act="addEx" data-bid="${esc(b.id)}">+ –£–ø—Ä</button>
            <button class="btn" data-act="renB" data-bid="${esc(b.id)}">‚úé</button>
          </div>
        </div>
    `;

    const exs = exByBlock(b.id);
    if(!exs.length){
      html += `<div class="hint" style="margin-top:8px">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>`;
    }else{
      for(const ex of exs){
        const ws = getWeights(ex.id);
        html += `
          <div class="exItem">
            <div class="exTitle">
              <div style="min-width:0;flex:1">
                <div class="exName" title="${esc(ex.name)}">${esc(ex.name)}</div>
                <div class="exMeta">–≤–µ—Å–æ–≤: ${ws.length}</div>
              </div>
              <div class="row">
                <button class="btn" data-act="addW" data-ex="${esc(ex.id)}">+ –≤–µ—Å</button>
                <button class="btn" data-act="renEx" data-ex="${esc(ex.id)}">‚úé</button>
              </div>
            </div>
            <div class="weights">
              ${
                ws.length
                  ? ws.map(w=>`<span class="wChip" data-act="renW" data-ex="${esc(ex.id)}" data-w="${esc(w.id)}">${esc(w.value)}</span>`).join("")
                  : `<span class="hint">–Ω–µ—Ç –≤–µ—Å–æ–≤</span>`
              }
            </div>
          </div>
        `;
      }
    }
    html += `</div>`;
  }

  html += `</div>`;
  root.innerHTML = html;

  $("#btnAddBlock").onclick = addBlock;

  root.onclick = (ev)=>{
    const el = ev.target.closest("[data-act]");
    if(!el) return;
    const act = el.dataset.act;
    const bid = el.dataset.bid;
    const ex = el.dataset.ex;
    const wid = el.dataset.w;

    if(act==="addEx") return addExercise(bid);
    if(act==="renB") return renameBlock(bid);
    if(act==="addW") return addWeight(ex);
    if(act==="renEx") return renameExercise(ex);
    if(act==="renW") return renameWeight(ex, wid);
  };
}

  // ===== Render table (–ë–ª–æ–∫ ‚Üí –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Üí –í–µ—Å) =====
function workoutsWindowed(){
  const w = state.workouts.slice();
  const win = state.ui.win;
  if(win==="all") return w;
  const n = parseInt(win,10);
  return Number.isFinite(n) ? w.slice(0,n) : w;
}

function renderTable(){
  const grid = $("#grid");
  const ws = workoutsWindowed();

  grid.style.gridTemplateColumns = `var(--roww) repeat(${ws.length}, var(--cellw))`;

  let frag = document.createDocumentFragment();

  // corner
  const corner = document.createElement("div");
  corner.className = "th corner";
  corner.textContent = "–ë–ª–æ–∫ / –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ / –í–µ—Å";
  frag.appendChild(corner);

  // workout headers
  for(const w of ws){
    const th = document.createElement("div");
    th.className = "th";
    th.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;width:100%;align-items:flex-start">
        <div style="display:flex;flex-direction:column;line-height:1.1">
          <div style="font-weight:950">${esc(w.date)}</div>
          <div class="hint" style="font-family:var(--mono);font-size:11px">#${esc(w.id.slice(0,6))}</div>
        </div>
        <button class="btn ghost" data-del="${esc(w.id)}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
      </div>
    `;
    frag.appendChild(th);
  }

  // rows
  for(const b of blocks()){
    // block row
    const rhB = document.createElement("div");
    rhB.className = "rh rowBlock";
    rhB.innerHTML = `<div class="cell"><div>${esc(b.name)}</div><span class="badge">–ë–ª–æ–∫</span></div>`;
    frag.appendChild(rhB);
    for(let i=0;i<ws.length;i++){
      const td = document.createElement("div");
      td.className = "td";
      td.innerHTML = `<div class="cell"><div class="val" style="color:var(--muted)">‚Äî</div></div>`;
      frag.appendChild(td);
    }

    // exercises
    for(const ex of exByBlock(b.id)){
      const rhE = document.createElement("div");
      rhE.className = "rh rowEx";
      rhE.innerHTML = `
        <div style="width:100%">
          <div class="l1 indentEx">${esc(ex.name)}</div>
          <div class="l2 indentEx">${esc(b.name)} ‚Ä¢ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
        </div>
      `;
      frag.appendChild(rhE);
      for(let i=0;i<ws.length;i++){
        const td = document.createElement("div");
        td.className = "td";
        td.innerHTML = `<div class="cell"><div class="val" style="color:var(--muted)">‚Äî</div></div>`;
        frag.appendChild(td);
      }

      const weights = getWeights(ex.id);
      if(!weights.length) continue;

      for(const wt of weights){
        const rhW = document.createElement("div");
        rhW.className = "rh rowW";
        rhW.innerHTML = `
          <div style="width:100%">
            <div class="l1 indentW">${esc(wt.value)}</div>
            <div class="l2 indentW">–≤–µ—Å</div>
          </div>
        `;
        frag.appendChild(rhW);

        for(const w of ws){
          const td = document.createElement("div");
          td.className = "td";
          td.dataset.workoutId = w.id;
          td.dataset.exId = ex.id;
          td.dataset.weightId = wt.id;

          const ent = getEntry(w.id, ex.id, wt.id);
          const sets = ent?.sets || [];
          const val = sets.length ? sets.join("+") : "";
          const goal = !sets.length ? goalNext(ex.id, wt.id) : "";
          const {cls,label} = classify(w.id, ex.id, wt.id);

          if(cls) td.classList.add(cls);

          td.innerHTML = `
            <div class="cell">
              <div class="val">${esc(val)}</div>
              <div class="goal">${goal ? esc("–Ω–∞–¥–æ "+goal) : ""}</div>
              <span class="badge">${esc(label||"")}</span>
            </div>
          `;
          frag.appendChild(td);
        }
      }
    }
  }

  grid.innerHTML = "";
  grid.appendChild(frag);

  // delete workout buttons
  grid.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      deleteWorkout(btn.dataset.del);
    };
  });
}
// ===== Modal (—Ä–µ–¥–∞–∫—Ç–æ—Ä —è—á–µ–π–∫–∏) =====
let modalCtx = null;

function openModal(ctx){
  modalCtx = ctx;
  const w = state.workouts.find(x=>x.id===ctx.workoutId);
  const ex = getEx(ctx.exId);
  const wt = getWeights(ctx.exId).find(x=>x.id===ctx.weightId);

  $("#mTitle").textContent = `${ex?.name||"?"} ‚Äî ${wt?.value||"?"}`;
  $("#mSub").textContent = w?.date || "?";

  const ent = getEntry(ctx.workoutId, ctx.exId, ctx.weightId) || {
    sets:[], comment:"", injury:false, injuryComment:"", gold:false, createdAt:Date.now(), updatedAt:Date.now()
  };

  renderSets(ent.sets||[]);
  $("#mQuick").value = "";
  $("#mComment").value = ent.comment || "";
  $("#mInjComment").value = ent.injuryComment || "";
  $("#mInjState").textContent = ent.injury ? "–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ç—Ä–∞–≤–º–∞" : "–ù–µ—Ç —Ç—Ä–∞–≤–º—ã";

  $("#mBest").textContent = ent.sets?.length ? String(bestSet(ent.sets)) : "‚Äî";
  $("#mSum").textContent  = ent.sets?.length ? String(sumSets(ent.sets)) : "‚Äî";

  const {label} = classify(ctx.workoutId, ctx.exId, ctx.weightId);
  $("#mColor").textContent = label || "‚Äî";

  $("#mBack").classList.add("open");
}

function closeModal(){
  $("#mBack").classList.remove("open");
  modalCtx = null;
}

function renderSets(sets){
  const box = $("#mSets");
  box.innerHTML = "";
  const arr = sets && sets.length ? sets.slice() : [0];
  for(const v of arr){
    const inp = document.createElement("input");
    inp.type="number"; inp.min="0"; inp.value = String(v||0);
    inp.oninput = updateModalComputed;
    box.appendChild(inp);
  }
}
function getSets(){
  return $$("#mSets input").map(i=>parseInt(i.value||"0",10)).filter(n=>Number.isFinite(n)&&n>=0);
}
function updateModalComputed(){
  const sets = getSets().filter(n=>n>0);
  $("#mBest").textContent = sets.length ? String(bestSet(sets)) : "‚Äî";
  $("#mSum").textContent  = sets.length ? String(sumSets(sets)) : "‚Äî";
}

function saveModal(){
  if(!modalCtx) return;
  const sets = getSets().filter(n=>n>0);
  const comment = ($("#mComment").value||"").trim();
  const injuryComment = ($("#mInjComment").value||"").trim();
  const now = Date.now();

  let ent = getEntry(modalCtx.workoutId, modalCtx.exId, modalCtx.weightId);
  if(!ent) ent = {sets:[], comment:"", injury:false, injuryComment:"", gold:false, createdAt:now, updatedAt:now};

  ent.sets = sets;
  ent.comment = comment;
  ent.injuryComment = injuryComment;
  ent.updatedAt = now;

  const key = entryKey(modalCtx.workoutId, modalCtx.exId, modalCtx.weightId);
  if(!ent.sets.length && !ent.injury && !ent.comment && !ent.injuryComment){
    delete state.entries[key];
  }else{
    state.entries[key] = ent;
  }
  saveStateDebounced();
  render();
  closeModal();
}

function toggleInjury(){
  if(!modalCtx) return;
  const now = Date.now();
  const key = entryKey(modalCtx.workoutId, modalCtx.exId, modalCtx.weightId);
  let ent = state.entries[key] || {sets:[], comment:"", injury:false, injuryComment:"", gold:false, createdAt:now, updatedAt:now};
  ent.injury = !ent.injury;
  ent.injuryComment = ($("#mInjComment").value||"").trim();
  ent.comment = ($("#mComment").value||"").trim();
  ent.sets = getSets().filter(n=>n>0);
  ent.updatedAt = now;
  state.entries[key] = ent;
  saveStateDebounced();
  openModal(modalCtx);
  render();
}

function parseQuickToSets(){
  const sets = parseQuick($("#mQuick").value);
  renderSets(sets.length ? sets : [0]);
  updateModalComputed();
}

function clearModal(){
  renderSets([0]);
  $("#mQuick").value="";
  $("#mComment").value="";
  $("#mInjComment").value="";
  updateModalComputed();
}
// ===== Export/Import/Reset =====
function exportAll(){
  dlJSON(state, `gym-tracker-${new Date().toISOString().slice(0,10)}.json`);
}
function importFile(file){
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const obj = JSON.parse(String(fr.result||""));
      state = normalize(obj);
      forceSaveNow();
      render();
      alert("–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤");
    }catch(e){
      alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + (e?.message||e));
    }
  };
  fr.readAsText(file);
}
function resetAll(){
  if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë?")) return;
  localStorage.removeItem(STORE_KEY);
  state = normalize(seed());
  forceSaveNow();
  render();
}

// ===== Wire =====
function render(){
  renderSide();
  renderTable();
}

function wire(){
  $("#btnAddWorkout").onclick = addWorkout;
  $("#btnExport").onclick = exportAll;
  $("#btnImport").onclick = ()=> $("#fileInput").click();
  $("#fileInput").onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    e.target.value="";
    if(f) importFile(f);
  };
  $("#btnReset").onclick = resetAll;

  $("#selWin").onchange = ()=>{
    state.ui.win = $("#selWin").value;
    saveStateDebounced();
    renderTable();
  };

  $("#btnPin").onclick = ()=> openPinLock("set");

  // table cell click
  $("#grid").onclick = (ev)=>{
    const td = ev.target.closest(".td");
    if(!td) return;
    const workoutId = td.dataset.workoutId;
    const exId = td.dataset.exId;
    const weightId = td.dataset.weightId;
    if(!workoutId || !exId || !weightId) return;
    openModal({workoutId, exId, weightId});
  };

  // modal
  $("#mClose").onclick = closeModal;
  $("#mBack").onclick = (e)=>{ if(e.target.id==="mBack") closeModal(); };
  $("#mAddSet").onclick = ()=>{
    const sets = getSets(); sets.push(0);
    renderSets(sets); updateModalComputed();
  };
  $("#mParse").onclick = parseQuickToSets;
  $("#mClear").onclick = clearModal;
  $("#mSave").onclick = saveModal;
  $("#mInj").onclick = toggleInjury;

  // extra: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener("beforeunload", ()=> {
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){}
  });
}
// ===== Init =====
(function init(){
  // UI defaults
  $("#selWin").value = state.ui.win || "all";
  setSaveState("loaded");

  wire();
  render();

  // PIN check: –µ—Å–ª–∏ PIN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
  const hasPin = !!localStorage.getItem(PIN_KEY);
  if(hasPin && pinEnabled){
    openPinLock("check");
  }
})();
</script>
</body>
</html>
