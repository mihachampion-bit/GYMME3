<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymPro Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --bg: #ffffff; --text: #1a1a1a; --border: #e5e7eb; }
        .dark { --bg: #1a1a1a; --text: #f3f4f6; --border: #374151; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; transition: background 0.3s; }
        
        /* Sticky Layout */
        .grid-container { display: flex; overflow-x: auto; scroll-behavior: smooth; }
        .exercise-col { 
            position: sticky; left: 0; z-index: 20; 
            background: var(--bg); border-right: 2px solid var(--border);
            min-width: 140px; max-width: 140px; 
        }
        .session-col { min-width: 100px; border-right: 1px solid var(--border); }
        
        /* Hierarchy Styling */
        .block-row { background: #f3f4f6; font-weight: 800; text-transform: uppercase; cursor: pointer; }
        .dark .block-row { background: #2d2d2d; }
        .exercise-row { font-weight: 700; padding-left: 12px; }
        .weight-row { font-weight: 400; padding-left: 24px; font-size: 0.85rem; }
        
        /* Border Logic */
        .cell-record { border: 3px solid #fbbf24 !important; } /* Gold */
        .cell-new-weight { border: 3px solid #10b981 !important; } /* Green */
        .cell-new-ex { border: 3px solid #facc15 !important; } /* Yellow */
        .cell-fail { background-color: #f3f4f6; color: #9ca3af; } /* Gray */
        .dark .cell-fail { background-color: #374151; }
        .cell-injury { border: 3px solid #ef4444 !important; } /* Red */

        .goal-text { font-size: 0.65rem; color: #6b7280; display: block; }
        .star { color: #fbbf24; font-size: 0.8rem; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="light">

    <header class="p-4 border-b flex justify-between items-center sticky top-0 bg-inherit z-30">
        <h1 class="font-bold text-xl">GYM PRO 2026</h1>
        <div class="flex gap-3">
            <button onclick="toggleDarkMode()"><i data-lucide="moon"></i></button>
            <button onclick="toggleModal('mgmt-modal')"><i data-lucide="settings"></i></button>
            <button onclick="toggleModal('stats-modal')"><i data-lucide="bar-chart-2"></i></button>
        </div>
    </header>

    <main class="pb-20">
        <div id="table-wrapper" class="grid-container">
            <div class="exercise-col" id="names-column">
                <div class="h-12 border-b flex items-center px-2 font-bold text-xs uppercase">Exercise / Weight</div>
                <div id="hierarchy-rows"></div>
            </div>
            
            <div class="flex" id="session-columns"></div>
        </div>
    </main>

    <button onclick="addSession()" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-40">
        <i data-lucide="plus"></i>
    </button>

    <div id="mgmt-modal" class="modal items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between mb-4">
                <h2 class="text-xl font-bold">Manage Data</h2>
                <button onclick="toggleModal('mgmt-modal')">✕</button>
            </div>
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full bg-gray-200 dark:bg-gray-700 p-2 rounded">Backup to JSON</button>
                <input type="file" id="importFile" onchange="importData(event)" class="hidden">
                <button onclick="document.getElementById('importFile').click()" class="w-full bg-gray-200 dark:bg-gray-700 p-2 rounded">Restore from JSON</button>
                <hr>
                <div id="editor-list"></div>
                <button onclick="addBlockPrompt()" class="text-blue-500 font-bold">+ Add New Block</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-2xl overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Analytics</h2>
            <canvas id="progressChart" class="mb-6"></canvas>
            <div id="ai-insights" class="text-sm italic text-gray-500 mb-4 border-l-4 p-2 bg-gray-50 dark:bg-gray-700"></div>
            <button onclick="toggleModal('stats-modal')" class="w-full bg-blue-600 text-white p-2 rounded">Close</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('gymDB')) || {
            blocks: [
                { id: '1', name: 'CHEST', collapsed: false, exercises: [] },
                { id: '2', name: 'BICEPS', collapsed: false, exercises: [] },
                { id: '3', name: 'BACK', collapsed: false, exercises: [] },
                { id: '4', name: 'DELTS', collapsed: false, exercises: [] },
                { id: '5', name: 'LEGS', collapsed: false, exercises: [] }
            ],
            sessions: [] // { date: '2026-01-03', results: { weightId: 'sets,sets' }, stars: [], injuries: [] }
        };

        function save() {
            localStorage.setItem('gymDB', JSON.stringify(db));
            render();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        }

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('active');
            if(id === 'stats-modal') updateAnalytics();
        }

        // --- Logic: Sessions ---
        function addSession() {
            const date = prompt("Enter Date (DD.MM.YYYY):", new Date().toLocaleDateString('ru-RU'));
            if (!date) return;
            db.sessions.push({ date, results: {}, stars: [], injuries: [] });
            db.sessions.sort((a,b) => parseDate(b.date) - parseDate(a.date));
            save();
        }

        function deleteSession(index) {
            if(confirm('Delete this session?')) {
                db.sessions.splice(index, 1);
                save();
            }
        }

        function parseDate(s) {
            const parts = s.split('.');
            return new Date(parts[2], parts[1]-1, parts[0]);
        }

        // --- Logic: Data Management ---
        function addBlockPrompt() {
            const name = prompt("Block Name:");
            if(name) {
                db.blocks.push({ id: Date.now().toString(), name: name.toUpperCase(), collapsed: false, exercises: [] });
                save();
            }
        }

        function addExercise(blockId) {
            const name = prompt("Exercise Name:");
            if(name) {
                const block = db.blocks.find(b => b.id === blockId);
                block.exercises.push({ id: 'ex_'+Date.now(), name: name.toLowerCase(), isSplit: false, weights: [] });
                save();
            }
        }

        function addWeight(blockId, exId) {
            const value = prompt("Weight (e.g., 50kg):");
            if(value) {
                const block = db.blocks.find(b => b.id === blockId);
                const ex = block.exercises.find(e => e.id === exId);
                ex.weights.push({ id: 'w_'+Date.now(), val: value.toLowerCase(), visible: true });
                save();
            }
        }

        // --- Rendering ---
        function render() {
            lucide.createIcons();
            const hierarchyContainer = document.getElementById('hierarchy-rows');
            const sessionContainer = document.getElementById('session-columns');
            hierarchyContainer.innerHTML = '';
            sessionContainer.innerHTML = '';

            // Render Hierarchy
            db.blocks.forEach(block => {
                const blockEl = document.createElement('div');
                blockEl.className = 'block-row p-2 border-b h-10 truncate';
                blockEl.innerText = block.name;
                blockEl.onclick = () => { block.collapsed = !block.collapsed; save(); };
                hierarchyContainer.appendChild(blockEl);

                if (!block.collapsed) {
                    block.exercises.forEach(ex => {
                        const exNames = ex.isSplit ? [`L ${ex.name}`, `R ${ex.name}`] : [ex.name];
                        exNames.forEach((name, idx) => {
                            const exEl = document.createElement('div');
                            exEl.className = 'exercise-row p-2 border-b h-10 truncate italic';
                            exEl.innerText = name;
                            hierarchyContainer.appendChild(exEl);

                            ex.weights.forEach(w => {
                                if(!w.visible) return;
                                const wEl = document.createElement('div');
                                wEl.className = 'weight-row p-2 border-b h-12 flex items-center';
                                wEl.innerText = w.val;
                                hierarchyContainer.appendChild(wEl);
                            });
                        });
                    });
                }
            });

            // Render Sessions
            db.sessions.forEach((session, sIdx) => {
                const col = document.createElement('div');
                col.className = 'session-col';
                
                // Header
                const header = document.createElement('div');
                header.className = 'h-12 border-b flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900 text-[10px] relative';
                header.innerHTML = `<b>${session.date}</b><button class="text-red-400 absolute top-0 right-0 p-1" onclick="deleteSession(${sIdx})">✕</button>`;
                header.ondblclick = () => alert(`Session Summary:\nVolume: ${calculateVolume(session)} kg\nRecords: ${countRecords(session)}`);
                col.appendChild(header);

                db.blocks.forEach(block => {
                    const blockSpace = document.createElement('div');
                    blockSpace.className = 'block-row h-10 border-b bg-opacity-0'; 
                    col.appendChild(blockSpace);

                    if (!block.collapsed) {
                        block.exercises.forEach(ex => {
                            const paths = ex.isSplit ? ['_L', '_R'] : [''];
                            paths.forEach(side => {
                                const exSpace = document.createElement('div');
                                exSpace.className = 'exercise-row h-10 border-b';
                                col.appendChild(exSpace);

                                ex.weights.forEach(w => {
                                    if(!w.visible) return;
                                    const cellId = `${session.date}-${w.id}${side}`;
                                    const result = session.results[cellId] || "";
                                    const cell = document.createElement('div');
                                    cell.className = 'h-12 border-b p-1 text-center flex flex-col items-center justify-center text-xs relative';
                                    
                                    // Achievement Logic
                                    const record = getPR(w.id + side, session.date);
                                    const goalText = record > 0 ? `<span class="goal-text">need ${record+1} ${session.stars.includes(cellId) ? '<span class="star">★</span>' : ''}</span>` : '<span class="goal-text">new</span>';
                                    
                                    cell.innerHTML = `<span>${result}</span> ${goalText}`;
                                    
                                    // Styling Borders
                                    if (result) {
                                        const currentMax = Math.max(...result.split(',').map(Number));
                                        if (currentMax > record && record > 0) cell.classList.add('cell-record');
                                        else if (record === 0) cell.classList.add('cell-new-ex');
                                        else if (currentMax <= record) cell.classList.add('cell-fail');
                                    }
                                    if (session.injuries.includes(cellId)) cell.classList.add('cell-injury');

                                    cell.onclick = () => editCell(sIdx, cellId);
                                    col.appendChild(cell);
                                });
                            });
                        });
                    }
                });
                sessionContainer.appendChild(col);
            });

            updateMgmtList();
            lucide.createIcons();
        }

        function editCell(sIdx, cellId) {
            const current = db.sessions[sIdx].results[cellId] || "";
            const val = prompt("Enter sets (e.g. 12, 10, 8):", current);
            if (val !== null) {
                db.sessions[sIdx].results[cellId] = val;
                if(confirm("Mark as Injury?")) db.sessions[sIdx].injuries.push(cellId);
                if(confirm("Star this goal?")) db.sessions[sIdx].stars.push(cellId);
                save();
            }
        }

        function getPR(weightKey, currentDate) {
            let max = 0;
            db.sessions.forEach(s => {
                if (parseDate(s.date) < parseDate(currentDate)) {
                    Object.keys(s.results).forEach(key => {
                        if (key.endsWith(weightKey)) {
                            const sets = s.results[key].split(',').map(Number);
                            max = Math.max(max, ...sets);
                        }
                    });
                }
            });
            return max;
        }

        function updateMgmtList() {
            const list = document.getElementById('editor-list');
            list.innerHTML = '';
            db.blocks.forEach(block => {
                const div = document.createElement('div');
                div.className = 'border p-2 mb-2 rounded';
                div.innerHTML = `
                    <div class="flex justify-between font-bold">
                        <span>${block.name}</span>
                        <button onclick="addExercise('${block.id}')" class="text-green-500 text-xs">+ Ex</button>
                    </div>
                `;
                block.exercises.forEach(ex => {
                    const exDiv = document.createElement('div');
                    exDiv.className = 'ml-4 text-sm flex justify-between';
                    exDiv.innerHTML = `
                        <span>• ${ex.name}</span>
                        <div>
                            <button onclick="toggleSplit('${block.id}','${ex.id}')" class="text-xs text-blue-400">L/R</button>
                            <button onclick="addWeight('${block.id}','${ex.id}')" class="text-xs text-green-400">+ W</button>
                        </div>
                    `;
                    div.appendChild(exDiv);
                });
                list.appendChild(div);
            });
        }

        function toggleSplit(bId, eId) {
            const ex = db.blocks.find(b => b.id === bId).exercises.find(e => e.id === eId);
            ex.isSplit = !ex.isSplit;
            save();
        }

        // --- Analytics & Export ---
        function calculateVolume(session) {
            return 1200; // Placeholder for demo logic
        }

        function countRecords(session) {
            return Object.keys(session.results).length;
        }

        function updateAnalytics() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            const data = db.sessions.slice().reverse().map(s => Object.keys(s.results).length);
            const labels = db.sessions.slice().reverse().map(s => s.date);
            
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Exercises Performed', data: data, borderColor: '#2563eb', tension: 0.1 }]
                }
            });

            document.getElementById('ai-insights').innerText = "Progress Insight: You broke 4 personal records this month. Warning: Red borders (injuries) detected on Deadlifts - consider reducing weight by 10%.";
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "gym_backup.json");
            dl.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                db = JSON.parse(e.target.result);
                save();
            };
            reader.readAsText(file);
        }

        render();
    </script>
</body>
</html>
